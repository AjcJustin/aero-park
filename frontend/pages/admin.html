<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administration - AeroPark GOMA</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/admin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f1f5f9; min-height: 100vh; }
        
        /* Sidebar */
        .admin-sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 260px;
            height: 100vh;
            background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%);
            color: white;
            z-index: 100;
            display: flex;
            flex-direction: column;
            transition: width 0.3s;
        }
        
        .admin-sidebar.collapsed { width: 70px; }
        .admin-sidebar.collapsed .sidebar-text { display: none; }
        .admin-sidebar.collapsed .sidebar-header h2 { display: none; }
        
        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .sidebar-header img { height: 40px; width: auto; }
        .sidebar-header h2 { font-size: 1.1rem; font-weight: 600; }
        
        .sidebar-menu { flex: 1; padding: 1rem 0; overflow-y: auto; }
        
        .menu-item {
            display: flex;
            align-items: center;
            padding: 0.875rem 1.5rem;
            color: #94a3b8;
            text-decoration: none;
            gap: 0.75rem;
            transition: all 0.2s;
            cursor: pointer;
        }
        
        .menu-item:hover, .menu-item.active {
            background: rgba(37, 99, 235, 0.2);
            color: white;
            border-left: 3px solid #2563eb;
        }
        
        .menu-item i { width: 20px; text-align: center; font-size: 1.1rem; }
        
        .sidebar-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        
        .admin-user {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }
        
        .admin-avatar {
            width: 40px;
            height: 40px;
            background: #2563eb;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .admin-info { flex: 1; overflow: hidden; }
        .admin-info .name { font-weight: 500; font-size: 0.9rem; }
        .admin-info .role { font-size: 0.75rem; color: #64748b; }
        
        .logout-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            width: 100%;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        
        .logout-btn:hover { background: #ef4444; color: white; }
        
        /* Main Content */
        .admin-main {
            margin-left: 260px;
            min-height: 100vh;
            transition: margin-left 0.3s;
        }
        
        .admin-sidebar.collapsed ~ .admin-main { margin-left: 70px; }
        
        .admin-header {
            background: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            position: sticky;
            top: 0;
            z-index: 50;
        }
        
        .header-left { display: flex; align-items: center; gap: 1rem; }
        
        .toggle-sidebar {
            background: none;
            border: none;
            font-size: 1.2rem;
            color: #64748b;
            cursor: pointer;
            padding: 0.5rem;
        }
        
        .page-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #1e293b;
        }
        
        .admin-content { padding: 2rem; }
        
        /* Stats Cards */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .stat-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .stat-card-icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
        }
        
        .stat-card-icon.blue { background: #dbeafe; color: #2563eb; }
        .stat-card-icon.green { background: #dcfce7; color: #10b981; }
        .stat-card-icon.orange { background: #fef3c7; color: #f59e0b; }
        .stat-card-icon.red { background: #fee2e2; color: #ef4444; }
        
        .stat-card-value { font-size: 2rem; font-weight: bold; color: #1e293b; }
        .stat-card-label { font-size: 0.85rem; color: #64748b; }
        
        /* Cards */
        .admin-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 1.5rem;
        }
        
        .card-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .card-header h3 {
            font-size: 1rem;
            font-weight: 600;
            color: #1e293b;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .card-header h3 i { color: #2563eb; }
        
        .card-body { padding: 1.5rem; }
        
        /* Parking Grid */
        .parking-admin-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 1rem;
        }
        
        .parking-admin-spot {
            padding: 1.25rem;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        
        .parking-admin-spot:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .parking-admin-spot.free { background: #f0fdf4; border-color: #10b981; }
        .parking-admin-spot.reserved { background: #fefce8; border-color: #f59e0b; }
        .parking-admin-spot.occupied { background: #fef2f2; border-color: #ef4444; }
        
        .spot-id { font-size: 1.2rem; font-weight: bold; color: #1e293b; margin-bottom: 0.5rem; }
        
        .spot-status {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .spot-status.free { background: #10b981; color: white; }
        .spot-status.reserved { background: #f59e0b; color: white; }
        .spot-status.occupied { background: #ef4444; color: white; }
        
        /* Table */
        .admin-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .admin-table th, .admin-table td {
            padding: 0.875rem 1rem;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .admin-table th {
            background: #f8fafc;
            font-weight: 600;
            font-size: 0.85rem;
            color: #64748b;
        }
        
        .admin-table tr:hover { background: #f8fafc; }
        
        .badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .badge.active { background: #dcfce7; color: #166534; }
        .badge.expired { background: #fee2e2; color: #dc2626; }
        .badge.used { background: #dbeafe; color: #1d4ed8; }
        
        /* Buttons */
        .btn-action {
            padding: 0.4rem 0.8rem;
            border: none;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            transition: all 0.2s;
        }
        
        .btn-action.release { background: #fee2e2; color: #dc2626; }
        .btn-action.release:hover { background: #dc2626; color: white; }
        .btn-action.refresh { background: #dbeafe; color: #2563eb; }
        .btn-action.refresh:hover { background: #2563eb; color: white; }
        
        /* Sections */
        .section { display: none; }
        .section.active { display: block; }
        
        /* Loading */
        .loading-spinner {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 3rem;
            color: #64748b;
        }
        
        .loading-spinner i { font-size: 2rem; }
        
        /* Responsive */
        @media (max-width: 768px) {
            .admin-sidebar { width: 0; overflow: hidden; }
            .admin-sidebar.mobile-open { width: 260px; }
            .admin-main { margin-left: 0; }
            .stats-row { grid-template-columns: 1fr 1fr; }
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <aside class="admin-sidebar" id="sidebar">
        <div class="sidebar-header">
            <img src="../logo/Logo_de_service_de_stationnement_aéroportuaire-removebg-preview.png" alt="AeroPark">
            <h2 class="sidebar-text">AeroPark Admin</h2>
        </div>
        
        <nav class="sidebar-menu">
            <a href="#" class="menu-item active" data-section="dashboard">
                <i class="fas fa-tachometer-alt"></i>
                <span class="sidebar-text">Tableau de bord</span>
            </a>
            <a href="#" class="menu-item" data-section="parking">
                <i class="fas fa-parking"></i>
                <span class="sidebar-text">Gestion Parking</span>
            </a>
            <a href="#" class="menu-item" data-section="reservations">
                <i class="fas fa-calendar-alt"></i>
                <span class="sidebar-text">Réservations</span>
            </a>
            <a href="#" class="menu-item" data-section="access-codes">
                <i class="fas fa-key"></i>
                <span class="sidebar-text">Codes d'accès</span>
            </a>
            <a href="#" class="menu-item" data-section="payments">
                <i class="fas fa-credit-card"></i>
                <span class="sidebar-text">Paiements</span>
            </a>
            <a href="#" class="menu-item" data-section="users">
                <i class="fas fa-users"></i>
                <span class="sidebar-text">Utilisateurs</span>
            </a>
        </nav>
        
        <div class="sidebar-footer">
            <div class="admin-user">
                <div class="admin-avatar" id="admin-avatar">A</div>
                <div class="admin-info sidebar-text">
                    <div class="name" id="admin-name">Admin</div>
                    <div class="role">Administrateur</div>
                </div>
            </div>
            <button class="logout-btn" id="admin-logout">
                <i class="fas fa-sign-out-alt"></i>
                <span class="sidebar-text">Déconnexion</span>
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="admin-main">
        <header class="admin-header">
            <div class="header-left">
                <button class="toggle-sidebar" id="toggle-sidebar">
                    <i class="fas fa-bars"></i>
                </button>
                <h1 class="page-title" id="page-title">Tableau de bord</h1>
            </div>
            <div class="header-right">
                <span id="current-time"></span>
            </div>
        </header>

        <div class="admin-content">
            <!-- Dashboard Section -->
            <section class="section active" id="section-dashboard">
                <div class="stats-row">
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div class="stat-card-icon blue"><i class="fas fa-warehouse"></i></div>
                        </div>
                        <div class="stat-card-value" id="stat-total">-</div>
                        <div class="stat-card-label">Places Totales</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div class="stat-card-icon green"><i class="fas fa-check-circle"></i></div>
                        </div>
                        <div class="stat-card-value" id="stat-free">-</div>
                        <div class="stat-card-label">Places Libres</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div class="stat-card-icon orange"><i class="fas fa-clock"></i></div>
                        </div>
                        <div class="stat-card-value" id="stat-reserved">-</div>
                        <div class="stat-card-label">Places Réservées</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div class="stat-card-icon red"><i class="fas fa-car"></i></div>
                        </div>
                        <div class="stat-card-value" id="stat-occupied">-</div>
                        <div class="stat-card-label">Places Occupées</div>
                    </div>
                </div>

                <div class="admin-card">
                    <div class="card-header">
                        <h3><i class="fas fa-parking"></i> Vue du Parking</h3>
                        <button class="btn-action refresh" onclick="loadParkingData()">
                            <i class="fas fa-sync-alt"></i> Actualiser
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="parking-admin-grid" id="parking-grid">
                            <div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i></div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Parking Section -->
            <section class="section" id="section-parking">
                <div class="admin-card">
                    <div class="card-header">
                        <h3><i class="fas fa-parking"></i> Gestion des Places</h3>
                        <div>
                            <button class="btn-action refresh" onclick="loadParkingData()">
                                <i class="fas fa-sync-alt"></i> Actualiser
                            </button>
                            <button class="btn-action" style="background: #dbeafe; color: #2563eb; margin-left: 0.5rem;" onclick="initializePlaces()">
                                <i class="fas fa-plus"></i> Initialiser
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="parking-admin-grid" id="parking-grid-manage">
                            <div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i></div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Reservations Section -->
            <section class="section" id="section-reservations">
                <div class="admin-card">
                    <div class="card-header">
                        <h3><i class="fas fa-calendar-alt"></i> Réservations Actives</h3>
                        <button class="btn-action refresh" onclick="loadReservations()">
                            <i class="fas fa-sync-alt"></i> Actualiser
                        </button>
                    </div>
                    <div class="card-body">
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>Place</th>
                                    <th>Utilisateur</th>
                                    <th>Début</th>
                                    <th>Fin</th>
                                    <th>Durée</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="reservations-table">
                                <tr><td colspan="6" class="loading-spinner"><i class="fas fa-spinner fa-spin"></i></td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Access Codes Section -->
            <section class="section" id="section-access-codes">
                <div class="admin-card">
                    <div class="card-header">
                        <h3><i class="fas fa-key"></i> Codes d'Accès</h3>
                        <button class="btn-action refresh" onclick="loadAccessCodes()">
                            <i class="fas fa-sync-alt"></i> Actualiser
                        </button>
                    </div>
                    <div class="card-body">
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>Code</th>
                                    <th>Place</th>
                                    <th>Statut</th>
                                    <th>Créé le</th>
                                    <th>Expire le</th>
                                </tr>
                            </thead>
                            <tbody id="access-codes-table">
                                <tr><td colspan="5" class="loading-spinner"><i class="fas fa-spinner fa-spin"></i></td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Payments Section -->
            <section class="section" id="section-payments">
                <div class="admin-card">
                    <div class="card-header">
                        <h3><i class="fas fa-credit-card"></i> Historique des Paiements</h3>
                        <button class="btn-action refresh" onclick="loadPayments()">
                            <i class="fas fa-sync-alt"></i> Actualiser
                        </button>
                    </div>
                    <div class="card-body">
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Montant</th>
                                    <th>Méthode</th>
                                    <th>Statut</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody id="payments-table">
                                <tr><td colspan="5" class="loading-spinner"><i class="fas fa-spinner fa-spin"></i></td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Users Section -->
            <section class="section" id="section-users">
                <div class="admin-card">
                    <div class="card-header">
                        <h3><i class="fas fa-users"></i> Utilisateurs</h3>
                        <button class="btn-action refresh" onclick="loadUsers()">
                            <i class="fas fa-sync-alt"></i> Actualiser
                        </button>
                    </div>
                    <div class="card-body">
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>Nom</th>
                                    <th>Email</th>
                                    <th>Rôle</th>
                                    <th>Réservations</th>
                                    <th>Inscrit le</th>
                                </tr>
                            </thead>
                            <tbody id="users-table">
                                <tr><td colspan="5" class="loading-spinner"><i class="fas fa-spinner fa-spin"></i></td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <script src="../js/api.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/admin.js"></script>
    <script>
        // Check admin authentication
        if (!Auth.isLoggedIn()) {
            window.location.href = 'admin-login.html';
        } else {
            // Vérifier si l'utilisateur est admin
            var user = Auth.getUser();
            if (!user || (!user.email.includes('admin') && user.role !== 'admin')) {
                window.location.href = 'admin-login.html';
            }
        }

        // Page titles
        const pageTitles = {
            'dashboard': 'Tableau de bord',
            'parking': 'Gestion du Parking',
            'reservations': 'Réservations',
            'access-codes': 'Codes d\'accès',
            'payments': 'Paiements',
            'users': 'Utilisateurs'
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initAdmin();
            loadParkingData();
            updateTime();
            setInterval(updateTime, 1000);
        });

        function initAdmin() {
            // Set admin info
            const user = Auth.getUser();
            if (user) {
                document.getElementById('admin-name').textContent = user.name || user.email.split('@')[0];
                document.getElementById('admin-avatar').textContent = (user.name || user.email)[0].toUpperCase();
            }

            // Toggle sidebar
            document.getElementById('toggle-sidebar').addEventListener('click', function() {
                document.getElementById('sidebar').classList.toggle('collapsed');
            });

            // Logout
            document.getElementById('admin-logout').addEventListener('click', function() {
                Auth.logout();
            });

            // Menu navigation
            document.querySelectorAll('.menu-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    const section = this.dataset.section;
                    
                    // Update active menu
                    document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Show section
                    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
                    document.getElementById('section-' + section).classList.add('active');
                    
                    // Update title
                    document.getElementById('page-title').textContent = pageTitles[section];
                    
                    // Load section data
                    loadSectionData(section);
                });
            });
        }

        function updateTime() {
            document.getElementById('current-time').textContent = new Date().toLocaleString('fr-FR');
        }

        function loadSectionData(section) {
            switch(section) {
                case 'dashboard':
                case 'parking':
                    loadParkingData();
                    break;
                case 'reservations':
                    loadReservations();
                    break;
                case 'access-codes':
                    loadAccessCodes();
                    break;
                case 'payments':
                    loadPayments();
                    break;
                case 'users':
                    loadUsers();
                    break;
            }
        }

        async function loadParkingData() {
            try {
                const response = await API.getParkingStatus();
                const places = response.places || [];
                
                // Update stats
                const total = places.length;
                const free = places.filter(p => p.etat === 'free').length;
                const reserved = places.filter(p => p.etat === 'reserved').length;
                const occupied = places.filter(p => p.etat === 'occupied').length;
                
                document.getElementById('stat-total').textContent = total;
                document.getElementById('stat-free').textContent = free;
                document.getElementById('stat-reserved').textContent = reserved;
                document.getElementById('stat-occupied').textContent = occupied;
                
                // Render parking grid
                renderParkingGrid(places, 'parking-grid');
                renderParkingGrid(places, 'parking-grid-manage');
                
            } catch (error) {
                console.error('Erreur chargement parking:', error);
                Admin.showNotification('Erreur de chargement', 'error');
            }
        }

        function renderParkingGrid(places, containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            container.innerHTML = places.map(place => {
                const status = place.etat || 'free';
                const statusLabel = status === 'free' ? 'Libre' : (status === 'reserved' ? 'Réservée' : 'Occupée');
                
                return `
                    <div class="parking-admin-spot ${status}" onclick="showPlaceDetails('${place.place_id}', '${status}')">
                        <div class="spot-id">${place.place_id}</div>
                        <span class="spot-status ${status}">${statusLabel}</span>
                    </div>
                `;
            }).join('');
        }

        function showPlaceDetails(placeId, status) {
            if (status !== 'free') {
                if (confirm(`Voulez-vous forcer la libération de la place ${placeId} ?`)) {
                    forceRelease(placeId);
                }
            } else {
                Admin.showNotification(`Place ${placeId} est disponible`, 'success');
            }
        }

        async function forceRelease(placeId) {
            try {
                await API.request(`/admin/parking/force-release/${placeId}`, { method: 'POST' });
                Admin.showNotification(`Place ${placeId} libérée`, 'success');
                loadParkingData();
            } catch (error) {
                Admin.showNotification('Erreur: ' + (error.message || 'Impossible de libérer'), 'error');
            }
        }

        async function initializePlaces() {
            try {
                await API.request('/admin/parking/initialize', { method: 'POST' });
                Admin.showNotification('Places initialisées', 'success');
                loadParkingData();
            } catch (error) {
                Admin.showNotification('Erreur: ' + (error.message || 'Échec'), 'error');
            }
        }

        async function loadReservations() {
            try {
                const response = await API.getParkingStatus();
                const places = response.places || [];
                const reservations = places.filter(p => p.etat === 'reserved' || p.etat === 'occupied');
                
                const tbody = document.getElementById('reservations-table');
                if (reservations.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#64748b;padding:2rem;">Aucune réservation active</td></tr>';
                    return;
                }
                
                tbody.innerHTML = reservations.map(r => `
                    <tr>
                        <td><strong>${r.place_id}</strong></td>
                        <td>${r.reserved_by || '-'}</td>
                        <td>${formatDate(r.reservation_start_time)}</td>
                        <td>${formatDate(r.reservation_end_time)}</td>
                        <td>${r.reservation_duration_minutes ? Math.round(r.reservation_duration_minutes/60) + 'h' : '-'}</td>
                        <td>
                            <button class="btn-action release" onclick="forceRelease('${r.place_id}')">
                                <i class="fas fa-times"></i> Libérer
                            </button>
                        </td>
                    </tr>
                `).join('');
                
            } catch (error) {
                console.error('Erreur chargement réservations:', error);
            }
        }

        async function loadAccessCodes() {
            try {
                const response = await API.request('/admin/parking/access-codes');
                const codes = response.codes || [];
                
                const tbody = document.getElementById('access-codes-table');
                if (codes.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:#64748b;padding:2rem;">Aucun code d\'accès</td></tr>';
                    return;
                }
                
                tbody.innerHTML = codes.map(c => `
                    <tr>
                        <td><strong style="letter-spacing:2px;">${c.code}</strong></td>
                        <td>${c.place_id || '-'}</td>
                        <td><span class="badge ${c.status}">${c.status}</span></td>
                        <td>${formatDate(c.created_at)}</td>
                        <td>${formatDate(c.expires_at)}</td>
                    </tr>
                `).join('');
                
            } catch (error) {
                document.getElementById('access-codes-table').innerHTML = 
                    '<tr><td colspan="5" style="text-align:center;color:#64748b;padding:2rem;">Erreur de chargement</td></tr>';
            }
        }

        async function loadPayments() {
            try {
                const response = await API.request('/admin/parking/payments');
                const payments = response.payments || [];
                
                const tbody = document.getElementById('payments-table');
                if (payments.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:#64748b;padding:2rem;">Aucun paiement</td></tr>';
                    return;
                }
                
                tbody.innerHTML = payments.map(p => `
                    <tr>
                        <td>${p.id?.substring(0,8) || '-'}</td>
                        <td><strong>${(p.amount || 0).toLocaleString('fr-FR')} FC</strong></td>
                        <td>${p.provider || '-'}</td>
                        <td><span class="badge ${p.status === 'completed' ? 'active' : 'expired'}">${p.status}</span></td>
                        <td>${formatDate(p.created_at)}</td>
                    </tr>
                `).join('');
                
            } catch (error) {
                document.getElementById('payments-table').innerHTML = 
                    '<tr><td colspan="5" style="text-align:center;color:#64748b;padding:2rem;">Erreur de chargement</td></tr>';
            }
        }

        async function loadUsers() {
            try {
                const response = await API.request('/admin/parking/users');
                const users = response.users || [];
                
                const tbody = document.getElementById('users-table');
                if (users.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:#64748b;padding:2rem;">Aucun utilisateur</td></tr>';
                    return;
                }
                
                tbody.innerHTML = users.map(u => `
                    <tr>
                        <td>${u.name || u.display_name || '-'}</td>
                        <td>${u.email}</td>
                        <td><span class="badge ${u.role === 'admin' ? 'used' : 'active'}">${u.role || 'user'}</span></td>
                        <td>${u.reservation_count || 0}</td>
                        <td>${formatDate(u.created_at)}</td>
                    </tr>
                `).join('');
                
            } catch (error) {
                document.getElementById('users-table').innerHTML = 
                    '<tr><td colspan="5" style="text-align:center;color:#64748b;padding:2rem;">Erreur de chargement</td></tr>';
            }
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            return new Date(dateString).toLocaleString('fr-FR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
    </script>
</body>
</html>

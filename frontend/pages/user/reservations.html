<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Consultez et g√©rez vos r√©servations de parking">
    <meta name="theme-color" content="#1e3a5f">
    
    <title>Mes R√©servations - AeroPark GOMA</title>
    
    <link rel="icon" type="image/png" href="../../assets/icons/favicon-32x32.png">
    <link rel="manifest" href="../../manifest.json">
    <link rel="stylesheet" href="../../css/styles.css">
</head>
<body>
    <!-- Banni√®re Hors Ligne -->
    <div class="offline-banner" id="offline-banner">
        ‚ö†Ô∏è Vous √™tes actuellement hors ligne. Affichage des donn√©es en cache.
    </div>
    
    <!-- En-t√™te -->
    <header class="header">
        <div class="header-container">
            <a href="/frontend/index.html" class="logo">
                <svg class="logo-icon" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="20" cy="20" r="18" stroke="currentColor" stroke-width="2" fill="none"/>
                    <path d="M20 8 L20 32 M12 16 L28 16 M14 24 L26 24" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    <circle cx="20" cy="20" r="4" fill="currentColor"/>
                </svg>
                <span>AeroPark <span style="font-weight: 400; opacity: 0.8;">GOMA</span></span>
            </a>
            
            <button class="hamburger-btn" id="hamburger-btn" aria-label="Toggle navigation">‚ò∞</button>
            
            <nav>
                <ul class="nav-menu" id="nav-menu">
                    <li><a href="/frontend/index.html" class="nav-link">üè† Accueil</a></li>
                    <li><a href="/frontend/pages/user/dashboard.html" class="nav-link">üìä Tableau de Bord</a></li>
                    <li><a href="/frontend/pages/user/reservations.html" class="nav-link active">üìÖ R√©servations</a></li>
                    <li><a href="/frontend/pages/user/access-codes.html" class="nav-link">üîë Codes d'Acc√®s</a></li>
                    <li><a href="/frontend/pages/user/payments.html" class="nav-link">üí≥ Paiements</a></li>
                    <li><a href="#" class="nav-link" id="logout-btn">üö™ D√©connexion</a></li>
                </ul>
            </nav>
        </div>
    </header>
    
    <!-- Contenu Principal -->
    <main class="main-content">
        <div class="container">
            <!-- En-t√™te de Page -->
            <div class="page-header flex justify-between items-center" style="flex-wrap: wrap; gap: var(--spacing-4);">
                <div>
                    <h1 class="page-title">üìÖ Mes R√©servations</h1>
                    <p class="page-subtitle">Consultez et g√©rez toutes vos r√©servations de parking</p>
                </div>
                <a href="/frontend/index.html#parking-status" class="btn btn-primary">
                    + Nouvelle R√©servation
                </a>
            </div>
            
            <!-- Filtres -->
            <div class="card mb-6">
                <div class="flex gap-4" style="flex-wrap: wrap;">
                    <div class="form-group mb-0" style="min-width: 150px;">
                        <label class="form-label">Statut</label>
                        <select class="form-select" id="filter-status">
                            <option value="">Tous</option>
                            <option value="active">Actif</option>
                            <option value="reserved">R√©serv√©</option>
                            <option value="completed">Termin√©</option>
                            <option value="cancelled">Annul√©</option>
                        </select>
                    </div>
                    <div class="form-group mb-0" style="min-width: 150px;">
                        <label class="form-label">P√©riode</label>
                        <select class="form-select" id="filter-date">
                            <option value="">Tout</option>
                            <option value="today">Aujourd'hui</option>
                            <option value="week">Cette Semaine</option>
                            <option value="month">Ce Mois</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- Liste des R√©servations -->
            <div id="reservations-container">
                <!-- Skeleton de chargement -->
                <div class="card mb-4">
                    <div class="skeleton" style="height: 100px;"></div>
                </div>
                <div class="card mb-4">
                    <div class="skeleton" style="height: 100px;"></div>
                </div>
            </div>
            
            <!-- √âtat Vide -->
            <div class="card text-center p-6" id="empty-state" style="display: none;">
                <div style="font-size: 4rem; margin-bottom: var(--spacing-4);">üì≠</div>
                <h3>Aucune R√©servation Trouv√©e</h3>
                <p class="text-muted mb-4">Vous n'avez pas encore fait de r√©servation de parking.</p>
                <a href="/frontend/index.html#parking-status" class="btn btn-primary">Faire Votre Premi√®re R√©servation</a>
            </div>
        </div>
    </main>
    
    <!-- Conteneur Toast -->
    <div class="toast-container" id="toast-container"></div>
    
    <!-- Modal Prolonger -->
    <div class="modal-backdrop" id="extend-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Prolonger la R√©servation</h3>
                <button class="modal-close" onclick="closeExtendModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="extend-form">
                    <input type="hidden" id="extend-reservation-id">
                    <div class="form-group">
                        <label class="form-label">Heure de Fin Actuelle</label>
                        <input type="text" class="form-input" id="current-end-time" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Nouvelle Heure de Fin</label>
                        <input type="datetime-local" class="form-input" id="new-end-time" required>
                    </div>
                    <div class="card" style="background: var(--gray-50);">
                        <div class="flex justify-between">
                            <span>Co√ªt Suppl√©mentaire:</span>
                            <strong id="additional-cost">$0.00</strong>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeExtendModal()">Annuler</button>
                <button class="btn btn-primary" id="confirm-extend">Prolonger la R√©servation</button>
            </div>
        </div>
    </div>
    
    <!-- Scripts -->
    <script src="../../js/services/api.js"></script>
    <script src="../../js/services/auth.js"></script>
    <script src="../../js/services/state.js"></script>
    <script src="../../js/services/notifications.js"></script>
    <script src="../../js/utils/helpers.js"></script>
    <script src="../../js/app.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <!-- Page Script -->
    <script>
        let allReservations = [];
        
        document.addEventListener('DOMContentLoaded', async () => {
            // V√©rifier l'authentification
            if (!localStorage.getItem('aeropark_token')) {
                window.location.href = '/frontend/pages/public/login.html';
                return;
            }
            
            // Initialiser le menu hamburger
            initHamburgerMenu();
            
            // Charger les r√©servations
            await loadReservations();
            
            // Gestionnaires de filtres
            document.getElementById('filter-status').addEventListener('change', filterReservations);
            document.getElementById('filter-date').addEventListener('change', filterReservations);
            
            // Modal de prolongation
            document.getElementById('new-end-time').addEventListener('change', calculateExtendCost);
            document.getElementById('confirm-extend').addEventListener('click', submitExtend);
            
            // Gestionnaire de d√©connexion
            document.getElementById('logout-btn').addEventListener('click', (e) => {
                e.preventDefault();
                localStorage.clear();
                showToast('D√©connexion r√©ussie', 'success');
                setTimeout(() => {
                    window.location.href = '/frontend/pages/public/login.html';
                }, 500);
            });
        });
        
        // ===== MENU HAMBURGER =====
        function initHamburgerMenu() {
            const hamburgerBtn = document.getElementById('hamburger-btn');
            const navMenu = document.getElementById('nav-menu');
            
            if (hamburgerBtn && navMenu) {
                hamburgerBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    navMenu.classList.toggle('active');
                    hamburgerBtn.innerHTML = navMenu.classList.contains('active') ? '‚úï' : '‚ò∞';
                });
                
                document.addEventListener('click', (e) => {
                    if (!navMenu.contains(e.target) && !hamburgerBtn.contains(e.target)) {
                        navMenu.classList.remove('active');
                        hamburgerBtn.innerHTML = '‚ò∞';
                    }
                });
                
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.addEventListener('click', () => {
                        navMenu.classList.remove('active');
                        hamburgerBtn.innerHTML = '‚ò∞';
                    });
                });
            }
        }
        
        // ===== SYST√àME TOAST =====
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            
            const icons = { success: '‚úÖ', error: '‚ùå', warning: '‚ö†Ô∏è', info: '‚ÑπÔ∏è' };
            toast.innerHTML = `<span class="toast-icon">${icons[type] || icons.info}</span><span class="toast-message">${message}</span>`;
            
            container.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }
        
        // ===== TRADUCTIONS =====
        const statusTranslations = {
            'active': 'Actif',
            'reserved': 'R√©serv√©',
            'completed': 'Termin√©',
            'cancelled': 'Annul√©',
            'pending': 'En Attente'
        };
        
        async function loadReservations() {
            const container = document.getElementById('reservations-container');
            
            try {
                // Charger la r√©servation active depuis le backend
                const activeReservationData = await ApiService.getMyActiveReservation();
                
                allReservations = [];
                
                if (activeReservationData.has_reservation && activeReservationData.reservation) {
                    const reservation = activeReservationData.reservation;
                    allReservations.push({
                        id: reservation.id || reservation.place_id,
                        spot_id: reservation.place_id || reservation.id,
                        start_time: reservation.reserve_at || reservation.start_time,
                        end_time: reservation.reserve_until || reservation.end_time,
                        status: reservation.etat || reservation.status || 'reserved',
                        vehicle_plate: reservation.vehicle_plate || 'N/A',
                        user_email: reservation.user_email
                    });
                }
                
                renderReservations(allReservations);
                
            } catch (error) {
                console.error('Erreur de chargement des r√©servations:', error);
                
                // Essayer les donn√©es en cache
                const lastReservation = StateService ? StateService.getLastReservation() : null;
                if (lastReservation) {
                    allReservations = [lastReservation];
                    renderReservations(allReservations);
                    showToast('Affichage des donn√©es en cache', 'warning');
                } else {
                    container.innerHTML = '';
                    document.getElementById('reservations-container').style.display = 'none';
                    document.getElementById('empty-state').style.display = 'block';
                }
            }
        }
        
        function renderReservations(reservations) {
            const container = document.getElementById('reservations-container');
            const emptyState = document.getElementById('empty-state');
            
            if (reservations.length === 0) {
                container.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }
            
            container.style.display = 'block';
            emptyState.style.display = 'none';
            
            // Trier par date de d√©but (plus r√©cent en premier)
            reservations.sort((a, b) => new Date(b.start_time) - new Date(a.start_time));
            
            container.innerHTML = reservations.map(reservation => {
                const start = new Date(reservation.start_time);
                const end = new Date(reservation.end_time);
                const now = new Date();
                const isActive = now >= start && now <= end && reservation.status !== 'cancelled';
                const isUpcoming = now < start && reservation.status !== 'cancelled';
                const isPast = now > end || reservation.status === 'completed' || reservation.status === 'cancelled';
                
                const hours = Math.round((end - start) / (1000 * 60 * 60));
                const duration = hours + (hours > 1 ? ' heures' : ' heure');
                const cost = hours * 2.5; // $2.50/heure
                
                return `
                    <div class="card mb-4 ${isPast ? '' : 'reservation-active'}">
                        <div class="flex gap-4" style="flex-wrap: wrap;">
                            <!-- Badge Place -->
                            <div class="parking-spot ${reservation.status}" style="min-width: 100px; max-width: 100px; cursor: default;">
                                <span class="parking-spot-id">${reservation.spot_id}</span>
                                <span class="parking-spot-status" style="font-size: 0.7rem;">
                                    ${statusTranslations[reservation.status] || reservation.status}
                                </span>
                            </div>
                            
                            <!-- D√©tails -->
                            <div class="flex-1" style="min-width: 200px;">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="status-badge ${getStatusClass(reservation.status)}">
                                        ${statusTranslations[reservation.status] || reservation.status}
                                    </span>
                                    ${isActive ? '<span class="status-badge success">‚óè En Cours</span>' : ''}
                                    ${isUpcoming ? '<span class="status-badge info">√Ä Venir</span>' : ''}
                                </div>
                                <p class="mb-1"><strong>üìÖ Date:</strong> ${formatDateFr(start)}</p>
                                <p class="mb-1"><strong>‚è∞ Horaire:</strong> ${formatTimeFr(start)} - ${formatTimeFr(end)}</p>
                                <p class="mb-1"><strong>‚è±Ô∏è Dur√©e:</strong> ${duration}</p>
                                <p class="mb-1"><strong>üöó V√©hicule:</strong> ${reservation.vehicle_plate || 'N/A'}</p>
                                ${isActive ? `<p class="mb-1"><strong>‚è≥ Restant:</strong> <span class="time-remaining" data-end="${end.toISOString()}">${getTimeRemainingText(end)}</span></p>` : ''}
                            </div>
                            
                            <!-- Co√ªt & Actions -->
                            <div class="text-right" style="min-width: 150px;">
                                <div class="mb-4">
                                    <p class="text-muted mb-1">Co√ªt Estim√©</p>
                                    <p style="font-size: var(--font-size-2xl); font-weight: 700; color: var(--primary);">
                                        $${cost.toFixed(2)}
                                    </p>
                                </div>
                                
                                ${!isPast ? `
                                    <div class="flex flex-col gap-2">
                                        <a href="/frontend/pages/user/access-codes.html?reservation=${reservation.id}" class="btn btn-primary btn-sm">
                                            üîë Code d'Acc√®s
                                        </a>
                                        ${isActive ? `
                                            <button class="btn btn-outline btn-sm" onclick="openExtendModal('${reservation.id}', '${end.toISOString()}')">
                                                ‚è∞ Prolonger
                                            </button>
                                        ` : ''}
                                        ${isUpcoming ? `
                                            <button class="btn btn-outline btn-sm btn-danger" onclick="cancelReservation('${reservation.id}')">
                                                ‚úï Annuler
                                            </button>
                                        ` : ''}
                                    </div>
                                ` : `
                                    ${reservation.status === 'completed' ? `
                                        <a href="/frontend/pages/user/payments.html?reservation=${reservation.id}" class="btn btn-outline btn-sm">
                                            Voir Re√ßu
                                        </a>
                                    ` : ''}
                                `}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // D√©marrer les compteurs
            startCountdownTimers();
        }
        
        function filterReservations() {
            const status = document.getElementById('filter-status').value;
            const dateRange = document.getElementById('filter-date').value;
            
            let filtered = [...allReservations];
            
            if (status) {
                filtered = filtered.filter(r => r.status === status);
            }
            
            if (dateRange) {
                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                
                if (dateRange === 'today') {
                    filtered = filtered.filter(r => {
                        const start = new Date(r.start_time);
                        return start >= today && start < new Date(today.getTime() + 24*60*60*1000);
                    });
                } else if (dateRange === 'week') {
                    const weekAgo = new Date(today.getTime() - 7*24*60*60*1000);
                    filtered = filtered.filter(r => new Date(r.start_time) >= weekAgo);
                } else if (dateRange === 'month') {
                    const monthAgo = new Date(today.getTime() - 30*24*60*60*1000);
                    filtered = filtered.filter(r => new Date(r.start_time) >= monthAgo);
                }
            }
            
            renderReservations(filtered);
        }
        
        function startCountdownTimers() {
            setInterval(() => {
                document.querySelectorAll('.time-remaining').forEach(el => {
                    const endTime = new Date(el.dataset.end);
                    el.textContent = getTimeRemainingText(endTime);
                });
            }, 1000);
        }
        
        function getTimeRemainingText(endTime) {
            const now = new Date();
            const diff = endTime - now;
            
            if (diff <= 0) return 'Expir√©';
            
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            
            if (hours > 0) {
                return `${hours}h ${minutes}min`;
            }
            return `${minutes} min`;
        }
        
        function openExtendModal(reservationId, currentEndTime) {
            document.getElementById('extend-reservation-id').value = reservationId;
            document.getElementById('current-end-time').value = formatDateTimeFr(currentEndTime);
            
            // D√©finir l'heure minimum de fin
            const minTime = new Date(new Date(currentEndTime).getTime() + 30*60*1000); // +30 min
            document.getElementById('new-end-time').min = minTime.toISOString().slice(0, 16);
            document.getElementById('new-end-time').value = minTime.toISOString().slice(0, 16);
            
            calculateExtendCost();
            document.getElementById('extend-modal').classList.add('active');
        }
        
        function closeExtendModal() {
            document.getElementById('extend-modal').classList.remove('active');
        }
        
        function calculateExtendCost() {
            const currentEndStr = document.getElementById('current-end-time').value;
            const newEnd = new Date(document.getElementById('new-end-time').value);
            
            // Parse French date format or ISO
            let currentEnd;
            if (currentEndStr.includes('/')) {
                // French format
                currentEnd = new Date(); // Fallback
            } else {
                currentEnd = new Date(currentEndStr);
            }
            
            if (newEnd > currentEnd) {
                const additionalHours = Math.ceil((newEnd - currentEnd) / (1000 * 60 * 60));
                const cost = additionalHours * 2.5; // $2.50/heure
                document.getElementById('additional-cost').textContent = '$' + cost.toFixed(2);
            } else {
                document.getElementById('additional-cost').textContent = '$0.00';
            }
        }
        
        async function submitExtend() {
            const reservationId = document.getElementById('extend-reservation-id').value;
            const newEndTime = document.getElementById('new-end-time').value;
            
            if (!newEndTime) {
                showToast('Veuillez s√©lectionner une nouvelle heure de fin', 'warning');
                return;
            }
            
            try {
                await ApiService.extendReservation(reservationId, new Date(newEndTime).toISOString());
                showToast('R√©servation prolong√©e avec succ√®s', 'success');
                closeExtendModal();
                await loadReservations();
            } catch (error) {
                showToast(error.message || '√âchec de la prolongation', 'error');
            }
        }
        
        async function cancelReservation(reservationId) {
            if (!confirm('√ätes-vous s√ªr de vouloir annuler cette r√©servation?')) {
                return;
            }
            
            try {
                await ApiService.cancelReservation(reservationId);
                showToast('R√©servation annul√©e', 'success');
                await loadReservations();
            } catch (error) {
                showToast(error.message || '√âchec de l\'annulation', 'error');
            }
        }
        
        // ===== UTILITAIRES =====
        function formatDateFr(date) {
            return date.toLocaleDateString('fr-FR', { 
                day: '2-digit', 
                month: 'short', 
                year: 'numeric'
            });
        }
        
        function formatTimeFr(date) {
            return date.toLocaleTimeString('fr-FR', { 
                hour: '2-digit', 
                minute: '2-digit'
            });
        }
        
        function formatDateTimeFr(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('fr-FR', { 
                day: '2-digit', 
                month: 'short', 
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        function getStatusClass(status) {
            const classes = {
                'active': 'status-active',
                'reserved': 'status-pending',
                'completed': 'status-active',
                'cancelled': 'status-cancelled',
                'pending': 'status-pending'
            };
            return classes[status] || 'status-pending';
        }
    </script>
</body>
</html>

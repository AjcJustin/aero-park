<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="G√©rez vos paiements de parking - Orange Money, Airtel Money, M-Pesa">
    <meta name="theme-color" content="#1e3a5f">
    
    <title>Paiements - AeroPark GOMA</title>
    
    <link rel="icon" type="image/png" href="../../assets/icons/favicon-32x32.png">
    <link rel="manifest" href="../../manifest.json">
    <link rel="stylesheet" href="../../css/styles.css">
</head>
<body>
    <!-- Banni√®re Hors Ligne -->
    <div class="offline-banner" id="offline-banner">
        ‚ö†Ô∏è Vous √™tes actuellement hors ligne. Les paiements n√©cessitent une connexion internet.
    </div>
    
    <!-- En-t√™te -->
    <header class="header">
        <div class="header-container">
            <a href="/frontend/index.html" class="logo">
                <svg class="logo-icon" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="20" cy="20" r="18" stroke="currentColor" stroke-width="2" fill="none"/>
                    <path d="M12 24 L20 8 L28 24 M15 20 L25 20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <circle cx="20" cy="28" r="3" fill="currentColor"/>
                </svg>
                <span>AeroPark <span style="font-weight: 400; opacity: 0.8;">GOMA</span></span>
            </a>
            
            <button class="nav-toggle" id="nav-toggle" aria-label="Menu de navigation" aria-expanded="false">
                <span id="nav-toggle-icon">‚ò∞</span>
            </button>
            
            <nav>
                <ul class="nav-menu" id="nav-menu">
                    <li><a href="/frontend/index.html" class="nav-link">üè† Accueil</a></li>
                    <li><a href="/frontend/pages/user/dashboard.html" class="nav-link">üìä Tableau de bord</a></li>
                    <li><a href="/frontend/pages/user/reservations.html" class="nav-link">üìÖ R√©servations</a></li>
                    <li><a href="/frontend/pages/user/access-codes.html" class="nav-link">üîë Codes d'Acc√®s</a></li>
                    <li><a href="/frontend/pages/user/payments.html" class="nav-link active">üí≥ Paiements</a></li>
                    <li><a href="#" class="nav-link" id="logout-btn">üö™ D√©connexion</a></li>
                </ul>
            </nav>
        </div>
    </header>
    
    <!-- Contenu Principal -->
    <main class="main-content">
        <div class="container">
            <!-- En-t√™te de Page -->
            <div class="page-header">
                <h1 class="page-title">üí≥ Paiements</h1>
                <p class="page-subtitle">G√©rez vos paiements de parking et consultez l'historique</p>
            </div>
            
            <!-- R√©sum√© des Paiements -->
            <section class="stats-grid mb-6">
                <div class="stat-card">
                    <div class="stat-card-icon warning">‚è≥</div>
                    <div class="stat-card-value" id="pending-amount">$0</div>
                    <div class="stat-card-label">En Attente</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-icon success">‚úì</div>
                    <div class="stat-card-value" id="paid-amount">$0</div>
                    <div class="stat-card-label">Pay√© ce Mois</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-icon primary">üìä</div>
                    <div class="stat-card-value" id="total-spent">$0</div>
                    <div class="stat-card-label">Total D√©pens√©</div>
                </div>
            </section>
            
            <!-- Paiements en Attente -->
            <section class="card mb-6" id="pending-section">
                <div class="card-header">
                    <h2 class="card-title">‚è≥ Paiements en Attente</h2>
                </div>
                <div id="pending-payments-container">
                    <div class="skeleton" style="height: 80px;"></div>
                </div>
            </section>
            
            <!-- Section Effectuer Paiement -->
            <section class="card mb-6" id="make-payment-section" style="display: none;">
                <h2 class="card-title mb-4">üí≥ Effectuer un Paiement</h2>
                
                <form id="payment-form">
                    <input type="hidden" id="payment-reservation-id">
                    
                    <div class="card mb-4" style="background: var(--gray-50);">
                        <div class="flex justify-between mb-2">
                            <span>R√©servation:</span>
                            <strong id="payment-reservation-info"></strong>
                        </div>
                        <div class="flex justify-between mb-2">
                            <span>Dur√©e:</span>
                            <strong id="payment-duration"></strong>
                        </div>
                        <div class="flex justify-between" style="font-size: var(--font-size-xl);">
                            <span>Montant √† Payer:</span>
                            <strong id="payment-amount" style="color: var(--primary);">$0.00</strong>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">üì± Choisissez votre M√©thode de Paiement</label>
                        <div class="payment-methods">
                            <!-- Orange Money -->
                            <div class="payment-method" data-method="orange-money" onclick="selectPaymentMethod(this)">
                                <div class="payment-method-logo" style="background: linear-gradient(135deg, #ff7900 0%, #ff9933 100%); color: white; font-weight: bold; font-size: 0.9rem;">
                                    Orange
                                </div>
                                <span class="payment-method-name">Orange Money</span>
                            </div>
                            
                            <!-- Airtel Money -->
                            <div class="payment-method" data-method="airtel-money" onclick="selectPaymentMethod(this)">
                                <div class="payment-method-logo" style="background: linear-gradient(135deg, #ed1c24 0%, #ff4444 100%); color: white; font-weight: bold; font-size: 0.9rem;">
                                    Airtel
                                </div>
                                <span class="payment-method-name">Airtel Money</span>
                            </div>
                            
                            <!-- M-Pesa -->
                            <div class="payment-method" data-method="mpesa" onclick="selectPaymentMethod(this)">
                                <div class="payment-method-logo" style="background: linear-gradient(135deg, #00a651 0%, #33cc33 100%); color: white; font-weight: bold; font-size: 0.8rem;">
                                    M-PESA
                                </div>
                                <span class="payment-method-name">M-Pesa</span>
                            </div>
                            
                            <!-- Carte Bancaire -->
                            <div class="payment-method" data-method="card" onclick="selectPaymentMethod(this)">
                                <div class="payment-method-logo" style="background: linear-gradient(135deg, #1e3a5f 0%, #2d5a8f 100%); color: white; font-size: 1.2rem;">
                                    üí≥
                                </div>
                                <span class="payment-method-name">Carte Bancaire</span>
                            </div>
                        </div>
                        <input type="hidden" id="selected-payment-method" name="payment-method" value="">
                    </div>
                    
                    <!-- Champs Mobile Money -->
                    <div id="mobile-fields" style="display: none;">
                        <div class="form-group">
                            <label class="form-label">üì± Num√©ro de T√©l√©phone</label>
                            <input type="tel" class="form-input" id="mobile-phone" placeholder="+243 XXX XXX XXX" required>
                            <span class="form-hint">Entrez le num√©ro associ√© √† votre compte mobile money</span>
                        </div>
                    </div>
                    
                    <!-- Champs Carte Bancaire -->
                    <div id="card-fields" style="display: none;">
                        <div class="form-group">
                            <label class="form-label">üí≥ Num√©ro de Carte</label>
                            <input type="text" class="form-input" id="card-number" placeholder="1234 5678 9012 3456" maxlength="19">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="form-group">
                                <label class="form-label">Date d'Expiration</label>
                                <input type="text" class="form-input" id="card-expiry" placeholder="MM/AA" maxlength="5">
                            </div>
                            <div class="form-group">
                                <label class="form-label">CVV</label>
                                <input type="text" class="form-input" id="card-cvv" placeholder="123" maxlength="4">
                            </div>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary btn-block btn-lg" id="pay-btn" disabled>
                        ‚úÖ Payer Maintenant
                    </button>
                </form>
            </section>
            
            <!-- Historique des Paiements -->
            <section class="card">
                <div class="card-header">
                    <h2 class="card-title">üìã Historique des Paiements</h2>
                </div>
                <div class="table-container" style="box-shadow: none;">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Description</th>
                                <th>M√©thode</th>
                                <th>Montant</th>
                                <th>Statut</th>
                            </tr>
                        </thead>
                        <tbody id="payment-history-body">
                            <tr>
                                <td colspan="5" class="text-center text-muted p-6">Chargement...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>
        </div>
    </main>
    
    <!-- Conteneur Toast -->
    <div class="toast-container" id="toast-container"></div>
    
    <!-- Scripts -->
    <script src="../../js/services/api.js"></script>
    <script src="../../js/services/auth.js"></script>
    <script src="../../js/services/state.js"></script>
    <script src="../../js/services/notifications.js"></script>
    <script src="../../js/utils/helpers.js"></script>
    <script src="../../js/app.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <!-- Page Script -->
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // Check authentication
            if (!localStorage.getItem('aeropark_token')) {
                window.location.href = '/frontend/pages/public/login.html';
                return;
            }
            
            // Initialiser le menu hamburger
            initHamburgerMenu();
            
            // Charger les paiements
            await loadPayments();
            
            // Formulaire de paiement
            document.getElementById('payment-form').addEventListener('submit', processPayment);
            
            // Formatage num√©ro de carte
            document.getElementById('card-number').addEventListener('input', (e) => {
                let value = e.target.value.replace(/\s/g, '').replace(/\D/g, '');
                value = value.match(/.{1,4}/g)?.join(' ') || '';
                e.target.value = value;
            });
            
            // Formatage date d'expiration
            document.getElementById('card-expiry').addEventListener('input', (e) => {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length >= 2) {
                    value = value.slice(0, 2) + '/' + value.slice(2);
                }
                e.target.value = value;
            });
            
            // Gestionnaire de d√©connexion
            document.getElementById('logout-btn').addEventListener('click', (e) => {
                e.preventDefault();
                localStorage.clear();
                showToast('D√©connexion r√©ussie', 'success');
                setTimeout(() => {
                    window.location.href = '/frontend/pages/public/login.html';
                }, 500);
            });
        });
        
        // ===== MENU HAMBURGER =====
        function initHamburgerMenu() {
            const hamburgerBtn = document.getElementById('hamburger-btn');
            const navMenu = document.getElementById('nav-menu');
            
            if (hamburgerBtn && navMenu) {
                hamburgerBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    navMenu.classList.toggle('active');
                    hamburgerBtn.innerHTML = navMenu.classList.contains('active') ? '‚úï' : '‚ò∞';
                });
                
                document.addEventListener('click', (e) => {
                    if (!navMenu.contains(e.target) && !hamburgerBtn.contains(e.target)) {
                        navMenu.classList.remove('active');
                        hamburgerBtn.innerHTML = '‚ò∞';
                    }
                });
                
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.addEventListener('click', () => {
                        navMenu.classList.remove('active');
                        hamburgerBtn.innerHTML = '‚ò∞';
                    });
                });
            }
        }
        
        // ===== SYST√àME TOAST =====
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            
            const icons = { success: '‚úÖ', error: '‚ùå', warning: '‚ö†Ô∏è', info: '‚ÑπÔ∏è' };
            toast.innerHTML = `<span class="toast-icon">${icons[type] || icons.info}</span><span class="toast-message">${message}</span>`;
            
            container.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }
        
        // ===== S√âLECTION M√âTHODE DE PAIEMENT =====
        let selectedMethod = null;
        
        function selectPaymentMethod(element) {
            // Retirer la s√©lection pr√©c√©dente
            document.querySelectorAll('.payment-method').forEach(el => {
                el.classList.remove('selected');
            });
            
            // Ajouter la s√©lection
            element.classList.add('selected');
            selectedMethod = element.dataset.method;
            document.getElementById('selected-payment-method').value = selectedMethod;
            
            // Afficher/masquer les champs appropri√©s
            const mobileFields = document.getElementById('mobile-fields');
            const cardFields = document.getElementById('card-fields');
            const payBtn = document.getElementById('pay-btn');
            
            payBtn.disabled = false;
            
            if (['orange-money', 'airtel-money', 'mpesa'].includes(selectedMethod)) {
                mobileFields.style.display = 'block';
                cardFields.style.display = 'none';
            } else if (selectedMethod === 'card') {
                mobileFields.style.display = 'none';
                cardFields.style.display = 'block';
            }
        }
        
        // ===== TRADUCTION M√âTHODES =====
        const methodTranslations = {
            'orange-money': 'Orange Money',
            'airtel-money': 'Airtel Money',
            'mpesa': 'M-Pesa',
            'card': 'Carte Bancaire',
            'mobile': 'Mobile Money'
        };
        
        const statusTranslations = {
            'pending': 'En Attente',
            'completed': 'Compl√©t√©',
            'paid': 'Pay√©',
            'failed': '√âchou√©',
            'cancelled': 'Annul√©'
        };
        
        // ===== CHARGEMENT DES PAIEMENTS =====
        async function loadPayments() {
            try {
                let payments = [];
                let activeReservation = null;
                
                // Charger les paiements et la r√©servation active depuis le backend
                try {
                    const paymentsResponse = await ApiService.getMyPayments();
                    payments = paymentsResponse.payments || paymentsResponse || [];
                } catch (e) {
                    console.log('Aucun paiement trouv√©');
                }
                
                try {
                    const reservationData = await ApiService.getMyActiveReservation();
                    if (reservationData.has_reservation) {
                        activeReservation = reservationData.reservation;
                    }
                } catch (e) {
                    console.log('Aucune r√©servation active');
                }
                
                // Calculer les statistiques
                const pending = payments.filter(p => p.status === 'pending');
                const paid = payments.filter(p => p.status === 'completed' || p.status === 'paid');
                
                const pendingTotal = pending.reduce((sum, p) => sum + (p.amount || 0), 0);
                const paidTotal = paid.reduce((sum, p) => sum + (p.amount || 0), 0);
                
                document.getElementById('pending-amount').textContent = '$' + pendingTotal.toFixed(2);
                document.getElementById('paid-amount').textContent = '$' + paidTotal.toFixed(2);
                document.getElementById('total-spent').textContent = '$' + paidTotal.toFixed(2);
                
                // Afficher les paiements en attente (bas√© sur la r√©servation active)
                const reservations = activeReservation ? [activeReservation] : [];
                renderPendingPayments(reservations, payments);
                
                // Afficher l'historique
                renderPaymentHistory(payments);
                
            } catch (error) {
                console.error('Erreur de chargement des paiements:', error);
                document.getElementById('pending-payments-container').innerHTML = 
                    '<p class="text-center text-muted p-4">Impossible de charger les paiements</p>';
            }
        }
        
        // ===== PAIEMENTS EN ATTENTE =====
        function renderPendingPayments(reservations, payments) {
            const container = document.getElementById('pending-payments-container');
            
            // Trouver les r√©servations n√©cessitant un paiement
            const completedReservations = reservations.filter(r => {
                const endTime = r.reserve_until || r.end_time;
                return r.etat === 'occupied' || (endTime && new Date(endTime) < new Date());
            });
            
            const paidReservationIds = payments
                .filter(p => p.status === 'completed' || p.status === 'paid')
                .map(p => p.reservation_id || p.place_id);
            
            const unpaidReservations = completedReservations.filter(r => {
                const reservationId = r.id || r.place_id;
                return !paidReservationIds.includes(reservationId);
            });
            
            if (unpaidReservations.length === 0) {
                container.innerHTML = `
                    <div class="text-center p-6">
                        <div style="font-size: 3rem; margin-bottom: var(--spacing-4);">‚úÖ</div>
                        <p class="text-muted">Aucun paiement en attente</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = unpaidReservations.map(reservation => {
                const startTime = reservation.reserve_at || reservation.start_time;
                const endTime = reservation.reserve_until || reservation.end_time;
                const spotId = reservation.place_id || reservation.spot_id || reservation.id;
                
                const start = new Date(startTime);
                const end = endTime ? new Date(endTime) : new Date();
                const hours = Math.max(1, Math.round((end - start) / (1000 * 60 * 60)));
                const cost = hours * 5; // $5/heure (tarif backend)
                const duration = hours + (hours > 1 ? ' heures' : ' heure');
                
                return `
                    <div class="flex items-center justify-between p-4" style="border-bottom: 1px solid var(--gray-200);">
                        <div>
                            <p class="font-semibold">Place ${spotId}</p>
                            <p class="text-muted" style="font-size: var(--font-size-sm);">
                                ${formatDateFr(startTime)} ‚Ä¢ ${duration}
                            </p>
                        </div>
                        <div class="flex items-center gap-4">
                            <span style="font-size: var(--font-size-xl); font-weight: bold; color: var(--primary);">
                                $${cost.toFixed(2)}
                            </span>
                            <button class="btn btn-primary btn-sm" 
                                    onclick="showPaymentForm('${spotId}', '${spotId}', '${duration}', ${cost}, ${hours * 60})">
                                Payer
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // ===== FORMULAIRE DE PAIEMENT =====
        let currentPaymentDuration = 0;
        
        function showPaymentForm(reservationId, spotId, duration, amount, durationMinutes) {
            currentPaymentDuration = durationMinutes;
            document.getElementById('payment-reservation-id').value = reservationId;
            document.getElementById('payment-reservation-info').textContent = `Place ${spotId}`;
            document.getElementById('payment-duration').textContent = duration;
            document.getElementById('payment-amount').textContent = '$' + amount.toFixed(2);
            
            // R√©initialiser la s√©lection
            document.querySelectorAll('.payment-method').forEach(el => el.classList.remove('selected'));
            document.getElementById('selected-payment-method').value = '';
            document.getElementById('pay-btn').disabled = true;
            document.getElementById('mobile-fields').style.display = 'none';
            document.getElementById('card-fields').style.display = 'none';
            
            document.getElementById('make-payment-section').style.display = 'block';
            document.getElementById('make-payment-section').scrollIntoView({ behavior: 'smooth' });
        }
        
        // ===== HISTORIQUE DES PAIEMENTS =====
        function renderPaymentHistory(payments) {
            const tbody = document.getElementById('payment-history-body');
            
            if (payments.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center text-muted p-6">Aucun historique de paiement</td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = payments.map(payment => `
                <tr>
                    <td>${formatDateFr(payment.created_at || payment.payment_date)}</td>
                    <td>Parking - ${payment.reservation_id || 'N/A'}</td>
                    <td>${methodTranslations[payment.payment_method] || payment.payment_method || 'Carte'}</td>
                    <td><strong>$${(payment.amount || 0).toFixed(2)}</strong></td>
                    <td>
                        <span class="status-badge ${getStatusClass(payment.status)}">
                            ${statusTranslations[payment.status] || payment.status}
                        </span>
                    </td>
                </tr>
            `).join('');
        }
        
        // ===== TRAITEMENT DU PAIEMENT =====
        async function processPayment(e) {
            e.preventDefault();
            
            const placeId = document.getElementById('payment-reservation-id').value;
            const paymentMethod = document.getElementById('selected-payment-method').value;
            const payBtn = document.getElementById('pay-btn');
            
            if (!placeId) {
                showToast('Aucune r√©servation s√©lectionn√©e', 'error');
                return;
            }
            
            if (!paymentMethod) {
                showToast('Veuillez s√©lectionner un mode de paiement', 'warning');
                return;
            }
            
            // Validation mobile money
            if (['orange-money', 'airtel-money', 'mpesa'].includes(paymentMethod)) {
                const phone = document.getElementById('mobile-phone').value;
                if (!phone || phone.length < 10) {
                    showToast('Veuillez entrer un num√©ro de t√©l√©phone valide', 'warning');
                    return;
                }
            }
            
            payBtn.disabled = true;
            payBtn.innerHTML = '<span class="loading-spinner"></span> Traitement...';
            
            try {
                // Mapper les m√©thodes de paiement au format backend
                const methodMap = {
                    'orange-money': 'ORANGE_MONEY',
                    'airtel-money': 'AIRTEL_MONEY',
                    'mpesa': 'MPESA',
                    'card': 'CARD'
                };
                
                const paymentData = {
                    place_id: placeId,
                    duration_minutes: currentPaymentDuration,
                    method: methodMap[paymentMethod] || paymentMethod.toUpperCase(),
                    simulate_failure: false
                };
                
                // Appeler l'API backend
                const result = await ApiService.processPayment(paymentData);
                
                if (result.success) {
                    const amount = parseFloat(document.getElementById('payment-amount').textContent.replace('$', ''));
                    showToast(`Paiement de $${amount.toFixed(2)} effectu√© avec succ√®s via ${methodTranslations[paymentMethod]}!`, 'success');
                    
                    // Afficher le code d'acc√®s si disponible
                    if (result.access_code) {
                        showToast(`Votre code d'acc√®s: ${result.access_code}`, 'info');
                    }
                } else {
                    throw new Error(result.message || '√âchec du paiement');
                }
                
                // Masquer le formulaire et recharger
                document.getElementById('make-payment-section').style.display = 'none';
                await loadPayments();
                
            } catch (error) {
                showToast(error.message || '√âchec du paiement. Veuillez r√©essayer.', 'error');
            } finally {
                payBtn.disabled = false;
                payBtn.innerHTML = '‚úÖ Payer Maintenant';
            }
        }
        
        // ===== UTILITAIRES =====
        function formatDateFr(dateStr) {
            if (!dateStr) return 'N/A';
            const date = new Date(dateStr);
            return date.toLocaleDateString('fr-FR', { 
                day: '2-digit', 
                month: 'short', 
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        function getStatusClass(status) {
            const classes = {
                'pending': 'status-pending',
                'completed': 'status-active',
                'paid': 'status-active',
                'failed': 'status-cancelled',
                'cancelled': 'status-cancelled'
            };
            return classes[status] || 'status-pending';
        }
    </script>
</body>
</html>

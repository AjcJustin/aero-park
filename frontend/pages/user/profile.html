<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Manage your AeroPark profile settings">
    <meta name="theme-color" content="#1e3a5f">
    
    <title>My Profile - AeroPark GOMA</title>
    
    <link rel="icon" type="image/png" href="../../assets/icons/favicon-32x32.png">
    <link rel="manifest" href="../../manifest.json">
    <link rel="stylesheet" href="../../css/styles.css">
</head>
<body>
    <!-- Offline Banner -->
    <div class="offline-banner" id="offline-banner">
        ‚ö†Ô∏è You are currently offline.
    </div>
    
    <!-- Header -->
    <header class="header">
        <div class="header-container">
            <a href="/frontend/index.html" class="logo">
                <svg class="logo-icon" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="20" cy="20" r="18" stroke="currentColor" stroke-width="2" fill="none"/>
                    <path d="M20 8 L20 32 M12 16 L28 16 M14 24 L26 24" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    <circle cx="20" cy="20" r="4" fill="currentColor"/>
                </svg>
                <span>AeroPark <span style="font-weight: 400; opacity: 0.8;">GOMA</span></span>
            </a>
            
            <button class="nav-toggle" id="nav-toggle" aria-label="Toggle navigation">‚ò∞</button>
            
            <nav>
                <ul class="nav-menu" id="nav-menu">
                    <li><a href="/frontend/index.html" class="nav-link">Home</a></li>
                    <li><a href="/frontend/pages/user/dashboard.html" class="nav-link">Dashboard</a></li>
                    <li><a href="/frontend/pages/user/reservations.html" class="nav-link">Reservations</a></li>
                    <li><a href="/frontend/pages/user/access-codes.html" class="nav-link">Access Codes</a></li>
                    <li><a href="/frontend/pages/user/payments.html" class="nav-link">Payments</a></li>
                    <li><a href="#" class="nav-link" id="logout-btn">Logout</a></li>
                </ul>
            </nav>
        </div>
    </header>
    
    <!-- Main Content -->
    <main class="main-content">
        <div class="container" style="max-width: 800px;">
            <!-- Page Header -->
            <div class="page-header">
                <h1 class="page-title">üë§ My Profile</h1>
                <p class="page-subtitle">Manage your account settings</p>
            </div>
            
            <!-- Profile Info -->
            <section class="card mb-6">
                <div class="flex items-center gap-6 mb-6" style="flex-wrap: wrap;">
                    <div class="user-avatar-large" id="user-avatar" 
                         style="width: 100px; height: 100px; border-radius: 50%; background: var(--primary); color: white; display: flex; align-items: center; justify-content: center; font-size: 2.5rem; font-weight: bold;">
                        U
                    </div>
                    <div>
                        <h2 id="profile-name" style="margin-bottom: var(--spacing-1);">Loading...</h2>
                        <p class="text-muted" id="profile-email">...</p>
                        <span class="status-badge info" id="profile-role">User</span>
                    </div>
                </div>
                
                <form id="profile-form">
                    <div class="form-group">
                        <label class="form-label">Full Name</label>
                        <input type="text" class="form-input" id="full-name" placeholder="Your full name">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Email Address</label>
                        <input type="email" class="form-input" id="email" placeholder="your@email.com" disabled>
                        <span class="form-hint">Email cannot be changed</span>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Phone Number</label>
                        <input type="tel" class="form-input" id="phone" placeholder="+243 XXX XXX XXX">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Default Vehicle Plate</label>
                        <input type="text" class="form-input" id="vehicle-plate" placeholder="ABC-1234">
                        <span class="form-hint">This will be pre-filled when making reservations</span>
                    </div>
                    
                    <button type="submit" class="btn btn-primary" id="save-profile-btn">
                        Save Changes
                    </button>
                </form>
            </section>
            
            <!-- Notification Settings -->
            <section class="card mb-6">
                <h2 class="card-title mb-4">üîî Notification Settings</h2>
                
                <div class="flex items-center justify-between mb-4 p-4" style="background: var(--gray-50); border-radius: var(--radius);">
                    <div>
                        <p class="font-semibold">Push Notifications</p>
                        <p class="text-muted" style="font-size: var(--font-size-sm);">Receive alerts on your device</p>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="push-notifications">
                        <span class="slider"></span>
                    </label>
                </div>
                
                <div class="flex items-center justify-between mb-4 p-4" style="background: var(--gray-50); border-radius: var(--radius);">
                    <div>
                        <p class="font-semibold">Reservation Reminders</p>
                        <p class="text-muted" style="font-size: var(--font-size-sm);">Get reminded before your reservation starts/ends</p>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="reservation-reminders" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                
                <div class="flex items-center justify-between p-4" style="background: var(--gray-50); border-radius: var(--radius);">
                    <div>
                        <p class="font-semibold">Payment Alerts</p>
                        <p class="text-muted" style="font-size: var(--font-size-sm);">Notifications about pending and completed payments</p>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="payment-alerts" checked>
                        <span class="slider"></span>
                    </label>
                </div>
            </section>
            
            <!-- App Settings -->
            <section class="card mb-6">
                <h2 class="card-title mb-4">‚öôÔ∏è App Settings</h2>
                
                <div class="form-group">
                    <label class="form-label">Language</label>
                    <select class="form-select" id="language">
                        <option value="en">English</option>
                        <option value="fr">Fran√ßais</option>
                        <option value="sw">Swahili</option>
                    </select>
                </div>
                
                <button class="btn btn-outline" id="clear-cache-btn">
                    üóëÔ∏è Clear App Cache
                </button>
            </section>
            
            <!-- Danger Zone -->
            <section class="card" style="border: 2px solid var(--danger);">
                <h2 class="card-title mb-4" style="color: var(--danger);">‚ö†Ô∏è Danger Zone</h2>
                
                <div class="flex items-center justify-between" style="flex-wrap: wrap; gap: var(--spacing-4);">
                    <div>
                        <p class="font-semibold">Delete Account</p>
                        <p class="text-muted" style="font-size: var(--font-size-sm);">Permanently delete your account and all data</p>
                    </div>
                    <button class="btn btn-danger" id="delete-account-btn">
                        Delete Account
                    </button>
                </div>
            </section>
        </div>
    </main>
    
    <style>
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            inset: 0;
            background-color: var(--gray-300);
            transition: 0.3s;
            border-radius: 28px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: var(--primary);
        }
        input:checked + .slider:before {
            transform: translateX(22px);
        }
    </style>
    
    <!-- Scripts -->
    <script src="../../js/services/api.js"></script>
    <script src="../../js/services/auth.js"></script>
    <script src="../../js/services/state.js"></script>
    <script src="../../js/services/notifications.js"></script>
    <script src="../../js/utils/helpers.js"></script>
    <script src="../../js/app.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <!-- Page Script -->
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // Check authentication
            if (!localStorage.getItem('aeropark_token')) {
                window.location.href = '/frontend/pages/public/login.html';
                return;
            }
            
            // Load profile
            loadProfile();
            
            // Load settings
            loadSettings();
            
            // Profile form
            document.getElementById('profile-form').addEventListener('submit', saveProfile);
            
            // Clear cache
            document.getElementById('clear-cache-btn').addEventListener('click', clearCache);
            
            // Delete account
            document.getElementById('delete-account-btn').addEventListener('click', deleteAccount);
            
            // Push notifications toggle
            document.getElementById('push-notifications').addEventListener('change', async (e) => {
                if (e.target.checked) {
                    const granted = await NotificationService.requestPermission();
                    if (granted) {
                        await NotificationService.subscribeToPush();
                        NotificationService.success('Push notifications enabled');
                    } else {
                        e.target.checked = false;
                        NotificationService.warning('Push notifications were denied');
                    }
                }
            });
            
            // Logout handler
            document.getElementById('logout-btn').addEventListener('click', (e) => {
                e.preventDefault();
                localStorage.clear();
                window.location.href = '/frontend/pages/public/login.html';
            });
        });
        
        function loadProfile() {
            const user = JSON.parse(localStorage.getItem('aeropark_user') || '{}');
            const role = localStorage.getItem('aeropark_role') || 'user';
            
            // Update display
            document.getElementById('profile-name').textContent = user.displayName || 'User';
            document.getElementById('profile-email').textContent = user.email || '';
            document.getElementById('profile-role').textContent = role.charAt(0).toUpperCase() + role.slice(1);
            
            // Avatar initial
            const initial = (user.displayName || user.email || 'U').charAt(0).toUpperCase();
            document.getElementById('user-avatar').textContent = initial;
            
            // Form values
            document.getElementById('full-name').value = user.displayName || '';
            document.getElementById('email').value = user.email || '';
            document.getElementById('phone').value = user.phone || '';
            document.getElementById('vehicle-plate').value = user.vehiclePlate || '';
        }
        
        function loadSettings() {
            const settings = StateService.getSettings();
            
            document.getElementById('reservation-reminders').checked = settings.notifications !== false;
            document.getElementById('payment-alerts').checked = settings.notifications !== false;
            document.getElementById('language').value = settings.language || 'en';
            
            // Check if push notifications are enabled
            if ('Notification' in window && Notification.permission === 'granted') {
                document.getElementById('push-notifications').checked = true;
            }
        }
        
        async function saveProfile(e) {
            e.preventDefault();
            
            const btn = document.getElementById('save-profile-btn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span> Saving...';
            
            try {
                const profileData = {
                    displayName: document.getElementById('full-name').value,
                    phone: document.getElementById('phone').value,
                    vehiclePlate: document.getElementById('vehicle-plate').value
                };
                
                // Update local storage
                const user = JSON.parse(localStorage.getItem('aeropark_user') || '{}');
                const updatedUser = { ...user, ...profileData };
                localStorage.setItem('aeropark_user', JSON.stringify(updatedUser));
                
                // Try to update on server
                try {
                    await ApiService.updateProfile(profileData);
                } catch (error) {
                    console.log('Server update failed, saved locally');
                }
                
                // Update settings
                StateService.updateSettings({
                    notifications: document.getElementById('reservation-reminders').checked,
                    language: document.getElementById('language').value
                });
                
                NotificationService.success('Profile updated successfully');
                loadProfile();
                
            } catch (error) {
                NotificationService.error(error.message || 'Failed to update profile');
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'Save Changes';
            }
        }
        
        async function clearCache() {
            if (!confirm('This will clear all cached data. You will need to reload the app. Continue?')) {
                return;
            }
            
            try {
                // Clear caches
                if ('caches' in window) {
                    const cacheNames = await caches.keys();
                    await Promise.all(cacheNames.map(name => caches.delete(name)));
                }
                
                // Clear state except auth
                const token = localStorage.getItem('aeropark_token');
                const user = localStorage.getItem('aeropark_user');
                const role = localStorage.getItem('aeropark_role');
                
                StateService.clearAll();
                
                localStorage.setItem('aeropark_token', token);
                localStorage.setItem('aeropark_user', user);
                localStorage.setItem('aeropark_role', role);
                
                NotificationService.success('Cache cleared successfully');
                
                // Reload page
                setTimeout(() => window.location.reload(), 1500);
                
            } catch (error) {
                NotificationService.error('Failed to clear cache');
            }
        }
        
        async function deleteAccount() {
            const confirmed = prompt('This action is irreversible. Type "DELETE" to confirm:');
            
            if (confirmed !== 'DELETE') {
                NotificationService.info('Account deletion cancelled');
                return;
            }
            
            try {
                // Clear all local data
                localStorage.clear();
                
                // Clear caches
                if ('caches' in window) {
                    const cacheNames = await caches.keys();
                    await Promise.all(cacheNames.map(name => caches.delete(name)));
                }
                
                NotificationService.success('Account deleted. Redirecting...');
                
                setTimeout(() => {
                    window.location.href = '/frontend/index.html';
                }, 2000);
                
            } catch (error) {
                NotificationService.error('Failed to delete account');
            }
        }
    </script>
</body>
</html>

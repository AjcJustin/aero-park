<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Votre Tableau de Bord AeroPark - G√©rez vos r√©servations de parking">
    <meta name="theme-color" content="#1e3a5f">
    
    <title>Tableau de Bord - AeroPark GOMA</title>
    
    <link rel="icon" type="image/png" href="../../assets/icons/favicon-32x32.png">
    <link rel="manifest" href="../../manifest.json">
    <link rel="stylesheet" href="../../css/styles.css">
</head>
<body>
    <!-- Banni√®re Hors Ligne -->
    <div class="offline-banner" id="offline-banner">
        ‚ö†Ô∏è Vous √™tes actuellement hors ligne. Affichage des donn√©es en cache.
    </div>
    
    <!-- En-t√™te -->
    <header class="header">
        <div class="header-container">
            <a href="/frontend/index.html" class="logo">
                <svg class="logo-icon" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="20" cy="20" r="18" stroke="currentColor" stroke-width="2" fill="none"/>
                    <path d="M12 24 L20 8 L28 24 M15 20 L25 20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <circle cx="20" cy="28" r="3" fill="currentColor"/>
                </svg>
                <span>AeroPark <span style="font-weight: 400; opacity: 0.8;">GOMA</span></span>
            </a>
            
            <button class="nav-toggle" id="nav-toggle" aria-label="Menu de navigation" aria-expanded="false">
                <span id="nav-toggle-icon">‚ò∞</span>
            </button>
            
            <nav>
                <ul class="nav-menu" id="nav-menu">
                    <li><a href="/frontend/index.html" class="nav-link">üè† Accueil</a></li>
                    <li><a href="/frontend/pages/user/dashboard.html" class="nav-link active">üìä Tableau de bord</a></li>
                    <li><a href="/frontend/pages/user/reservations.html" class="nav-link">üìÖ R√©servations</a></li>
                    <li><a href="/frontend/pages/user/access-codes.html" class="nav-link">üîë Codes d'Acc√®s</a></li>
                    <li><a href="/frontend/pages/user/payments.html" class="nav-link">üí≥ Paiements</a></li>
                    <li class="admin-only"><a href="/frontend/pages/admin/dashboard.html" class="nav-link">‚öôÔ∏è Admin</a></li>
                    <li><a href="#" class="nav-link" id="logout-btn">üö™ D√©connexion</a></li>
                </ul>
            </nav>
        </div>
    </header>
    
    <!-- Contenu Principal -->
    <main class="main-content">
        <div class="container">
            <!-- Section Bienvenue -->
            <div class="page-header">
                <h1 class="page-title">Bienvenue, <span id="user-name">Utilisateur</span>! üëã</h1>
                <p class="page-subtitle">Voici un aper√ßu de votre activit√© de stationnement</p>
            </div>
            
            <!-- Statistiques Rapides -->
            <section class="stats-grid mb-6">
                <div class="stat-card">
                    <div class="stat-card-icon primary">üÖøÔ∏è</div>
                    <div class="stat-card-value" id="active-reservations">0</div>
                    <div class="stat-card-label">R√©servations Actives</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-icon success">‚úì</div>
                    <div class="stat-card-value" id="completed-reservations">0</div>
                    <div class="stat-card-label">Termin√©es</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-icon warning">üí≥</div>
                    <div class="stat-card-value" id="pending-payments">$0</div>
                    <div class="stat-card-label">Paiements en Attente</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-icon danger">üìç</div>
                    <div class="stat-card-value" id="total-hours">0</div>
                    <div class="stat-card-label">Heures Totales</div>
                </div>
            </section>
            
            <!-- Actions Rapides -->
            <section class="card mb-6">
                <h2 class="card-title mb-4">‚ö° Actions Rapides</h2>
                <div class="grid grid-cols-4 gap-4" style="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));">
                    <a href="/frontend/index.html#parking-status" class="btn btn-primary btn-block">
                        üÖøÔ∏è Nouvelle R√©servation
                    </a>
                    <a href="/frontend/pages/user/access-codes.html" class="btn btn-secondary btn-block">
                        üîë Codes d'Acc√®s
                    </a>
                    <a href="/frontend/pages/user/payments.html" class="btn btn-outline btn-block">
                        üí≥ Effectuer Paiement
                    </a>
                    <a href="/frontend/pages/user/profile.html" class="btn btn-outline btn-block">
                        üë§ Mon Profil
                    </a>
                </div>
            </section>
            
            <!-- R√©servation Actuelle -->
            <section class="card mb-6" id="current-reservation-section">
                <div class="card-header">
                    <h2 class="card-title">üìÖ R√©servation Actuelle</h2>
                </div>
                <div id="current-reservation-content">
                    <div class="skeleton" style="height: 150px;"></div>
                </div>
            </section>
            
            <!-- Dernier Code d'Acc√®s (hors ligne) -->
            <section class="card mb-6" id="last-access-code-section" style="display: none;">
                <div class="card-header">
                    <h2 class="card-title">üîë Votre Code d'Acc√®s</h2>
                    <span class="status-badge warning" id="access-code-status">En Cache</span>
                </div>
                <div id="last-access-code-content"></div>
            </section>
            
            <!-- Activit√© R√©cente -->
            <section class="card">
                <div class="card-header">
                    <h2 class="card-title">üìã Activit√© R√©cente</h2>
                    <a href="/frontend/pages/user/reservations.html" class="btn btn-sm btn-outline">Voir Tout</a>
                </div>
                <div class="table-container" style="box-shadow: none;">
                    <table class="table" id="recent-activity-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Place</th>
                                <th>Dur√©e</th>
                                <th>Statut</th>
                                <th>Montant</th>
                            </tr>
                        </thead>
                        <tbody id="recent-activity-body">
                            <tr>
                                <td colspan="5" class="text-center text-muted p-6">Chargement...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>
        </div>
    </main>
    
    <!-- Conteneur Toast -->
    <div class="toast-container" id="toast-container"></div>
    
    <!-- Scripts -->
    <script src="../../js/services/api.js"></script>
    <script src="../../js/services/auth.js"></script>
    <script src="../../js/services/state.js"></script>
    <script src="../../js/services/notifications.js"></script>
    <script src="../../js/utils/helpers.js"></script>
    <script src="../../js/app.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <!-- Script de la Page -->
    <script>
        // Traductions fran√ßaises
        const STATUS_FR = {
            active: 'Actif',
            reserved: 'R√©serv√©',
            completed: 'Termin√©',
            cancelled: 'Annul√©',
            pending: 'En attente'
        };
        
        document.addEventListener('DOMContentLoaded', async () => {
            // Initialiser le menu hamburger
            initHamburgerMenu();
            
            // V√©rifier l'authentification
            const isAuthenticated = localStorage.getItem('aeropark_token');
            if (!isAuthenticated) {
                window.location.href = '/frontend/pages/public/login.html';
                return;
            }
            
            // D√©finir le nom d'utilisateur
            const user = JSON.parse(localStorage.getItem('aeropark_user') || '{}');
            document.getElementById('user-name').textContent = user.displayName || user.email?.split('@')[0] || 'Utilisateur';
            
            // Charger les donn√©es du tableau de bord
            await loadDashboardData();
            
            // V√©rifier les donn√©es hors ligne
            checkOfflineData();
            
            // Gestionnaire de d√©connexion
            document.getElementById('logout-btn').addEventListener('click', async (e) => {
                e.preventDefault();
                localStorage.clear();
                showToast('D√©connexion', '√Ä bient√¥t !', 'success');
                setTimeout(() => {
                    window.location.href = '/frontend/pages/public/login.html';
                }, 1000);
            });
        });
        
        // Initialiser le menu hamburger
        function initHamburgerMenu() {
            const navToggle = document.getElementById('nav-toggle');
            const navMenu = document.getElementById('nav-menu');
            const navToggleIcon = document.getElementById('nav-toggle-icon');
            
            if (navToggle && navMenu) {
                navToggle.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const isActive = navMenu.classList.toggle('active');
                    navToggle.classList.toggle('active', isActive);
                    navToggle.setAttribute('aria-expanded', isActive);
                    if (navToggleIcon) navToggleIcon.textContent = isActive ? '‚úï' : '‚ò∞';
                });
                
                document.addEventListener('click', (e) => {
                    if (!navMenu.contains(e.target) && !navToggle.contains(e.target)) {
                        navMenu.classList.remove('active');
                        navToggle.classList.remove('active');
                        if (navToggleIcon) navToggleIcon.textContent = '‚ò∞';
                    }
                });
                
                navMenu.querySelectorAll('.nav-link').forEach(link => {
                    link.addEventListener('click', () => {
                        navMenu.classList.remove('active');
                        navToggle.classList.remove('active');
                        if (navToggleIcon) navToggleIcon.textContent = '‚ò∞';
                    });
                });
            }
        }
        
        async function loadDashboardData() {
            try {
                // Charger le profil utilisateur avec la r√©servation active
                const profileData = await ApiService.getProfile();
                
                // Mettre √† jour les statistiques depuis le profil
                document.getElementById('completed-reservations').textContent = profileData.reservation_count || 0;
                document.getElementById('total-hours').textContent = Math.round(profileData.total_parking_hours || 0);
                
                // V√©rifier s'il y a une r√©servation active
                const activeReservationData = await ApiService.getMyActiveReservation();
                
                if (activeReservationData.has_reservation && activeReservationData.reservation) {
                    const currentReservation = activeReservationData.reservation;
                    document.getElementById('active-reservations').textContent = 1;
                    
                    if (typeof StateService !== 'undefined') {
                        StateService.saveLastReservation(currentReservation);
                    }
                    renderCurrentReservation(currentReservation);
                } else {
                    document.getElementById('active-reservations').textContent = 0;
                    renderNoReservation();
                }
                
                // Charger les paiements
                try {
                    const payments = await ApiService.getMyPayments();
                    const paymentsList = payments.payments || payments || [];
                    const pending = paymentsList
                        .filter(p => p.status === 'pending')
                        .reduce((sum, p) => sum + (p.amount || 0), 0);
                    document.getElementById('pending-payments').textContent = '$' + pending.toFixed(2);
                } catch (e) {
                    console.log('Paiements non disponibles:', e);
                    document.getElementById('pending-payments').textContent = '$0.00';
                }
                
                // Charger l'activit√© r√©cente (historique des r√©servations)
                try {
                    const parkingStatus = await ApiService.getParkingStatus();
                    // Simuler l'activit√© r√©cente bas√©e sur les places occup√©es
                    const recentActivity = parkingStatus.places
                        ?.filter(p => p.etat === 'occupied' || p.etat === 'reserved')
                        ?.slice(0, 3)
                        ?.map(p => ({
                            spot_id: p.id,
                            status: p.etat === 'occupied' ? 'active' : 'reserved',
                            start_time: p.reserve_at || new Date().toISOString(),
                            end_time: p.reserve_until || new Date(Date.now() + 3600000).toISOString()
                        })) || [];
                    renderRecentActivity(recentActivity);
                } catch (e) {
                    console.log('Activit√© r√©cente non disponible');
                    renderRecentActivity([]);
                }
                
            } catch (error) {
                console.error('√âchec du chargement:', error);
                
                // Essayer les donn√©es hors ligne
                if (typeof StateService !== 'undefined') {
                    const cachedReservation = StateService.getLastReservation();
                    if (cachedReservation) {
                        renderCurrentReservation(cachedReservation);
                        showToast('Mode Hors Ligne', 'Affichage des donn√©es en cache', 'warning');
                    } else {
                        renderNoReservation();
                    }
                } else {
                    renderNoReservation();
                }
                renderRecentActivity([]);
            }
        }
        
        function renderCurrentReservation(reservation) {
            const content = document.getElementById('current-reservation-content');
            const now = new Date();
            const start = new Date(reservation.start_time);
            const end = new Date(reservation.end_time);
            
            const isActive = now >= start && now <= end;
            
            content.innerHTML = `
                <div class="flex gap-6" style="flex-wrap: wrap;">
                    <div class="parking-spot ${reservation.status}" style="min-width: 120px; cursor: default;">
                        <span class="parking-spot-id">${reservation.spot_id}</span>
                        <span class="parking-spot-status">${STATUS_FR[reservation.status] || reservation.status}</span>
                    </div>
                    <div class="flex-1" style="min-width: 200px;">
                        <div class="mb-4">
                            <span class="status-badge ${isActive ? 'success' : 'info'}">
                                ${isActive ? 'üü¢ Actuellement Actif' : 'üîµ √Ä Venir'}
                            </span>
                        </div>
                        <p><strong>D√©but:</strong> ${formatDateTime(start)}</p>
                        <p><strong>Fin:</strong> ${formatDateTime(end)}</p>
                        <p><strong>V√©hicule:</strong> ${reservation.vehicle_plate || 'N/A'}</p>
                        <p><strong>Temps Restant:</strong> <span id="time-remaining">${getTimeRemaining(end)}</span></p>
                    </div>
                    <div class="flex flex-col gap-2">
                        <a href="/frontend/pages/user/access-codes.html?reservation=${reservation.id}" class="btn btn-primary">
                            üîë Obtenir Code d'Acc√®s
                        </a>
                        ${!isActive ? `
                            <button class="btn btn-outline btn-danger" onclick="cancelReservation('${reservation.id}')">
                                ‚ùå Annuler R√©servation
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
            
            // Mettre √† jour le temps restant chaque seconde
            setInterval(() => {
                const el = document.getElementById('time-remaining');
                if (el) {
                    el.textContent = getTimeRemaining(end);
                }
            }, 1000);
        }
        
        function renderNoReservation() {
            const content = document.getElementById('current-reservation-content');
            content.innerHTML = `
                <div class="text-center p-6">
                    <div style="font-size: 4rem; margin-bottom: var(--spacing-4);">üÖøÔ∏è</div>
                    <h3>Aucune R√©servation Active</h3>
                    <p class="text-muted mb-4">Vous n'avez pas de r√©servation de parking active.</p>
                    <a href="/frontend/index.html#parking-status" class="btn btn-primary">üìÖ Faire une R√©servation</a>
                </div>
            `;
        }
        
        function renderRecentActivity(reservations) {
            const tbody = document.getElementById('recent-activity-body');
            
            if (reservations.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center text-muted p-6">Aucune activit√© r√©cente</td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = reservations.map(r => {
                const duration = r.start_time && r.end_time 
                    ? formatDuration(Math.round((new Date(r.end_time) - new Date(r.start_time)) / (1000 * 60)))
                    : 'N/A';
                const cost = r.start_time && r.end_time 
                    ? calculateParkingFee(r.start_time, r.end_time)
                    : 0;
                    
                return `
                    <tr>
                        <td>${formatDate(r.start_time)}</td>
                        <td><strong>${r.spot_id}</strong></td>
                        <td>${duration}</td>
                        <td>
                            <span class="status-badge ${getStatusBadgeClass(r.status)}">
                                ${STATUS_FR[r.status] || r.status}
                            </span>
                        </td>
                        <td>$${cost.toFixed(2)}</td>
                    </tr>
                `;
            }).join('');
        }
        
        function checkOfflineData() {
            if (!navigator.onLine) {
                document.getElementById('offline-banner').style.display = 'block';
                if (typeof StateService !== 'undefined') {
                    const lastCode = StateService.getLastAccessCode();
                    if (lastCode) {
                        document.getElementById('last-access-code-section').style.display = 'block';
                        renderLastAccessCode(lastCode);
                    }
                }
            }
        }
        
        function renderLastAccessCode(code) {
            const content = document.getElementById('last-access-code-content');
            content.innerHTML = `
                <div class="access-code-display">
                    <div class="access-code-label">Votre Code ${code.code_type === 'entry' ? 'd\'Entr√©e' : 'de Sortie'}</div>
                    <div class="access-code-value">${code.code}</div>
                    <div class="access-code-expires">
                        Expire: ${formatDateTime(new Date(code.expires_at))}
                    </div>
                </div>
            `;
        }
        
        async function cancelReservation(reservationId) {
            if (!confirm('√ätes-vous s√ªr de vouloir annuler cette r√©servation ?')) {
                return;
            }
            
            try {
                await ApiService.cancelReservation(reservationId);
                showToast('Succ√®s', 'R√©servation annul√©e avec succ√®s', 'success');
                location.reload();
            } catch (error) {
                showToast('Erreur', error.message || '√âchec de l\'annulation', 'error');
            }
        }
        
        // Fonctions utilitaires
        function formatDateTime(date) {
            return new Date(date).toLocaleString('fr-FR', {
                day: '2-digit', month: '2-digit', year: 'numeric',
                hour: '2-digit', minute: '2-digit'
            });
        }
        
        function formatDate(dateStr) {
            return new Date(dateStr).toLocaleDateString('fr-FR');
        }
        
        function formatDuration(minutes) {
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            return `${hours}h ${mins}m`;
        }
        
        function calculateParkingFee(start, end) {
            const hours = Math.ceil((new Date(end) - new Date(start)) / (1000 * 60 * 60));
            return hours * 5;
        }
        
        function getTimeRemaining(endDate) {
            const now = new Date();
            const end = new Date(endDate);
            const diff = end - now;
            
            if (diff <= 0) return 'Expir√©';
            
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            return `${hours}h ${minutes}m`;
        }
        
        function getStatusBadgeClass(status) {
            const classes = {
                active: 'success', reserved: 'info', completed: 'success',
                cancelled: 'danger', pending: 'warning'
            };
            return classes[status] || 'secondary';
        }
        
        function showToast(title, message, type = 'info') {
            const container = document.getElementById('toast-container');
            if (!container) return;
            
            const icons = { success: '‚úÖ', error: '‚ùå', warning: '‚ö†Ô∏è', info: '‚ÑπÔ∏è' };
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <span class="toast-icon">${icons[type]}</span>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    <div class="toast-message">${message}</div>
                </div>
                <button class="toast-close" onclick="this.parentElement.remove()">‚úï</button>
            `;
            
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 5000);
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Réserver - AeroPark GOMA</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="reservation-page">
    <!-- Navigation -->
    <nav class="navbar">
        <a href="../index.html" class="nav-brand">
            <img src="../logo/Logo_de_service_de_stationnement_aéroportuaire-removebg-preview.png" alt="AeroPark" style="height: 50px; width: auto;">
            <span>AeroPark GOMA</span>
        </a>
        <ul class="nav-links">
            <li><a href="../index.html"><i class="fas fa-home"></i> Accueil</a></li>
            <li><a href="reservation.html" class="active"><i class="fas fa-ticket-alt"></i> Réserver</a></li>
            <li id="auth-links">
                <a href="login.html" class="btn btn-outline"><i class="fas fa-sign-in-alt"></i> Connexion</a>
                <a href="register.html" class="btn btn-primary"><i class="fas fa-user-plus"></i> Inscription</a>
            </li>
            <li id="user-menu" class="hidden">
                <a href="profile.html" class="btn btn-outline"><i class="fas fa-user"></i> Profil</a>
                <a href="#" class="btn btn-outline" id="logout-btn"><i class="fas fa-sign-out-alt"></i> Déconnexion</a>
            </li>
        </ul>
        <div class="hamburger">
            <span></span>
            <span></span>
            <span></span>
        </div>
    </nav>

    <main class="reservation-container">
        <div class="container">
            <!-- Header -->
            <div class="reservation-header">
                <h1><i class="fas fa-parking"></i> Réserver une Place</h1>
                <p>Sélectionnez une place disponible sur le plan du parking</p>
            </div>

            <!-- Stats rapides -->
            <div class="stats-grid" style="max-width: 800px; margin: 0 auto 2rem;">
                <div class="stat-card">
                    <div class="stat-icon available">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="stat-info">
                        <span class="stat-number" id="available-count">0</span>
                        <span class="stat-label">Places Disponibles</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon occupied">
                        <i class="fas fa-car"></i>
                    </div>
                    <div class="stat-info">
                        <span class="stat-number" id="occupied-count">0</span>
                        <span class="stat-label">Places Occupées</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: var(--reserved-color);">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stat-info">
                        <span class="stat-number" id="reserved-count">0</span>
                        <span class="stat-label">Places Réservées</span>
                    </div>
                </div>
            </div>

            <!-- Légende -->
            <div class="map-legend" style="margin-bottom: 2rem;">
                <div class="legend-item">
                    <span class="legend-color available"></span>
                    <span>Disponible</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color occupied"></span>
                    <span>Occupée</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color reserved"></span>
                    <span>Réservée</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color" style="background: var(--primary-color);"></span>
                    <span>Sélectionnée</span>
                </div>
            </div>

            <!-- Grille du parking -->
            <div class="parking-grid" id="parking-grid">
                <!-- Générée par JavaScript -->
            </div>

            <!-- Formulaire de réservation -->
            <div class="reservation-form-container hidden" id="reservation-form-container">
                <h3><i class="fas fa-ticket-alt"></i> Confirmer la réservation</h3>
                
                <div class="selected-spot-info">
                    <p>Place sélectionnée :</p>
                    <span class="spot-number" id="selected-spot-display">-</span>
                </div>

                <div class="form-group">
                    <label for="vehicle-plate">Plaque d'immatriculation (optionnel)</label>
                    <div class="input-icon">
                        <i class="fas fa-car"></i>
                        <input 
                            type="text" 
                            id="vehicle-plate" 
                            placeholder="Ex: AB-123-CD"
                            maxlength="12"
                        >
                    </div>
                </div>

                <div class="form-group">
                    <label for="duration">Durée de stationnement (en heures)</label>
                    <div class="input-icon">
                        <i class="fas fa-clock"></i>
                        <input 
                            type="number" 
                            id="duration" 
                            min="1" 
                            max="168"
                            value="1"
                            placeholder="Nombre d'heures"
                            oninput="updatePaymentAmount()"
                            style="width: 100%; padding: 0.875rem 1rem 0.875rem 2.75rem; border: 2px solid var(--border-color); border-radius: var(--radius-md); font-size: 1rem; background: var(--bg-color);"
                        >
                    </div>
                    <p style="font-size: 0.85rem; color: var(--text-light); margin-top: 0.5rem;">
                        <i class="fas fa-info-circle"></i> Minimum 1 heure, maximum 168 heures (1 semaine)
                    </p>
                </div>

                <!-- Section Paiement -->
                <div class="payment-section">
                    <h4><i class="fas fa-credit-card"></i> Paiement</h4>
                    
                    <div class="pricing-info">
                        <div class="rate">1 000 FC <span>/ heure</span></div>
                    </div>

                    <div class="total-amount">
                        <div class="label">Montant à payer</div>
                        <div class="amount"><span id="payment-amount">1 000</span> <small>FC</small></div>
                    </div>

                    <div class="payment-methods">
                        <label>Choisir le mode de paiement :</label>
                        
                        <div class="payment-option" onclick="selectPaymentMethod('orange')">
                            <input type="radio" name="payment-method" id="pm-orange" value="orange">
                            <span class="radio-custom"></span>
                            <img src="../logo/orange_money_logo.png" alt="Orange Money" class="payment-logo">
                            <span class="payment-name">Orange Money</span>
                        </div>

                        <div class="payment-option" onclick="selectPaymentMethod('airtel')">
                            <input type="radio" name="payment-method" id="pm-airtel" value="airtel">
                            <span class="radio-custom"></span>
                            <img src="../logo/airtel-money.png" alt="Airtel Money" class="payment-logo">
                            <span class="payment-name">Airtel Money</span>
                        </div>

                        <div class="payment-option" onclick="selectPaymentMethod('mpesa')">
                            <input type="radio" name="payment-method" id="pm-mpesa" value="mpesa">
                            <span class="radio-custom"></span>
                            <img src="../logo/Mpesa.png" alt="M-Pesa" class="payment-logo">
                            <span class="payment-name">M-Pesa</span>
                        </div>
                    </div>

                    <div class="phone-input-group">
                        <label for="phone-number"><i class="fas fa-phone"></i> Numéro de téléphone</label>
                        <input 
                            type="tel" 
                            id="phone-number" 
                            placeholder="Ex: 0991234567"
                            maxlength="10"
                        >
                        <p class="hint">Entrez le numéro associé à votre compte Mobile Money</p>
                    </div>

                    <div class="payment-summary">
                        <div class="summary-row">
                            <span>Place</span>
                            <span id="summary-spot">-</span>
                        </div>
                        <div class="summary-row">
                            <span>Durée</span>
                            <span id="summary-duration">1 heure</span>
                        </div>
                        <div class="summary-row">
                            <span>Tarif</span>
                            <span>1 000 FC/h</span>
                        </div>
                        <div class="summary-row">
                            <span>Total</span>
                            <span id="summary-total">1 000 FC</span>
                        </div>
                    </div>
                </div>

                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                    <button type="button" class="btn btn-outline" id="cancel-selection" style="flex: 1;">
                        <i class="fas fa-times"></i> Annuler
                    </button>
                    <button type="button" class="btn-pay" id="confirm-reservation" onclick="processPayment()">
                        <i class="fas fa-lock"></i> Payer et Réserver
                    </button>
                </div>
            </div>

            <!-- Modal de paiement -->
            <div class="payment-modal" id="payment-modal">
                <div class="payment-modal-content">
                    <div class="modal-icon processing" id="modal-icon">
                        <i class="fas fa-spinner"></i>
                    </div>
                    <h3 id="modal-title">Traitement en cours...</h3>
                    <p id="modal-message">Veuillez confirmer le paiement sur votre téléphone</p>
                    <button class="btn btn-primary hidden" id="modal-btn" onclick="closePaymentModal()">
                        <i class="fas fa-check"></i> OK
                    </button>
                </div>
            </div>

            <!-- Modal de confirmation d'annulation -->
            <div class="payment-modal" id="cancel-modal">
                <div class="payment-modal-content" style="max-width: 450px;">
                    <div class="modal-icon" style="background: #fef3c7; color: #d97706;">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <h3>Confirmer l'annulation</h3>
                    <p style="margin-bottom: 0.5rem;">Voulez-vous vraiment annuler cette réservation ?</p>
                    <div style="background: #fee2e2; border: 1px solid #fecaca; border-radius: 8px; padding: 1rem; margin: 1rem 0;">
                        <p style="margin: 0; color: #dc2626; font-weight: 600;">
                            <i class="fas fa-info-circle"></i> Important
                        </p>
                        <p style="margin: 0.5rem 0 0; color: #7f1d1d; font-size: 0.9rem;">
                            Le paiement effectué ne sera <strong>pas remboursé</strong>.
                        </p>
                    </div>
                    <p id="cancel-spot-info" style="font-size: 0.9rem; color: #666;">Place: -</p>
                    <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                        <button class="btn btn-outline" onclick="closeCancelModal()" style="flex: 1;">
                            <i class="fas fa-arrow-left"></i> Retour
                        </button>
                        <button class="btn btn-danger" id="confirm-cancel-btn" style="flex: 1;">
                            <i class="fas fa-times"></i> Confirmer l'annulation
                        </button>
                    </div>
                </div>
            </div>

            <!-- Section Envoi Code Barrière -->
            <div class="reservation-form-card" id="barrier-code-section" style="margin-top: 2rem; display: none;">
                <h3 style="margin-bottom: 1rem;"><i class="fas fa-door-open"></i> Ouvrir la Barrière</h3>
                <p style="color: #666; font-size: 0.9rem; margin-bottom: 1rem;">Entrez votre code d'accès pour ouvrir la barrière lorsque vous êtes devant le parking.</p>
                <div class="form-group">
                    <label for="barrier-code-input"><i class="fas fa-key"></i> Code d'accès</label>
                    <div style="display: flex; gap: 1rem;">
                        <input type="text" id="barrier-code-input" class="form-control" placeholder="Ex: 5MJ" maxlength="10" style="flex: 1; text-transform: uppercase; font-size: 1.5rem; text-align: center; letter-spacing: 0.5rem;">
                        <button type="button" class="btn btn-primary" onclick="sendBarrierCode()" id="send-barrier-btn">
                            <i class="fas fa-paper-plane"></i> Envoyer
                        </button>
                    </div>
                </div>
                <div id="barrier-response" style="margin-top: 1rem; display: none;"></div>
            </div>

            <!-- Mes réservations -->
            <div class="user-reservations hidden" id="user-reservations">
                <h3><i class="fas fa-list"></i> Mes Réservations</h3>
                <div class="reservation-list" id="reservation-list">
                    <!-- Générée par JavaScript -->
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer style="background: #1e293b; color: #94a3b8; padding: 1rem 0; text-align: center; font-size: 0.85rem;">
        <div class="container" style="display: flex; align-items: center; justify-content: center; gap: 0.5rem; flex-wrap: wrap;">
            <i class="fas fa-plane" style="color: #2563eb;"></i>
            <span>AeroPark GOMA</span>
            <span style="opacity: 0.5;">|</span>
            <span>&copy; 2026 Tous droits réservés</span>
        </div>
    </footer>

    <script src="../js/api.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/main.js"></script>
    <script>
        // Check if logged in
        if (!Auth.isLoggedIn()) {
            sessionStorage.setItem('redirectAfterLogin', 'reservation.html');
            window.location.href = 'login.html';
        }
        
        document.addEventListener('DOMContentLoaded', async function() {
            Auth.updateNavigation();
            await initReservationPage();
            initNavigation();
            
            // Logout button
            var logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    Auth.logout();
                });
            }
        });

        // Variables
        var selectedSpot = null;
        var selectedPaymentMethod = null;
        var RATE_PER_HOUR = 1000;
        var parkingData = { places: [], stats: {} };

        async function initReservationPage() {
            await updateParkingGrid();
            await loadUserReservations();
            updatePaymentAmount();
            document.getElementById('cancel-selection').addEventListener('click', clearSelection);
            
            // Pré-remplir la plaque d'immatriculation depuis le profil
            prefillVehiclePlate();
            
            // Calcul automatique du prix quand la durée change
            var durationInput = document.getElementById('duration');
            durationInput.addEventListener('input', updatePaymentAmount);
            durationInput.addEventListener('change', updatePaymentAmount);
        }
        
        // Pré-remplir automatiquement la plaque d'immatriculation
        function prefillVehiclePlate() {
            var savedPlate = localStorage.getItem('aeropark_vehicle_plate');
            var plateInput = document.getElementById('vehicle-plate');
            if (savedPlate && plateInput) {
                plateInput.value = savedPlate;
            }
        }

        // Update quick stats
        function updateQuickStats(stats) {
            if (stats) {
                document.getElementById('available-count').textContent = stats.available || 0;
                document.getElementById('occupied-count').textContent = stats.occupied || 0;
                document.getElementById('reserved-count').textContent = stats.reserved || 0;
            }
        }

        // Generate parking grid
        async function updateParkingGrid() {
            var container = document.getElementById('parking-grid');
            container.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Chargement...</div>';
            
            try {
                var response = await API.getParkingStatus();
                parkingData = response;
                
                var spots = response.places || [];
                var user = Auth.getUser();
                
                container.innerHTML = '';
                
                spots.forEach(function(spot) {
                    var spotElement = document.createElement('div');
                    // Backend uses 'etat' field: free, reserved, occupied
                    var spotStatus = spot.etat || spot.status || 'free';
                    var statusClass = spotStatus === 'free' ? 'available' : spotStatus;
                    spotElement.className = 'parking-spot ' + statusClass;
                    spotElement.dataset.id = spot.id;
                    
                    var icon = 'fa-car';
                    if (spotStatus === 'free') {
                        icon = 'fa-plus';
                    } else if (spotStatus === 'reserved') {
                        icon = 'fa-clock';
                        if (user && spot.reserved_by === user.uid) {
                            spotElement.classList.add('my-reservation');
                        }
                    }

                    var spotId = spot.place_id || spot.id;
                    spotElement.innerHTML = '<i class="fas ' + icon + '"></i><span>' + spotId + '</span>';

                    if (spotStatus === 'free') {
                        spotElement.addEventListener('click', function() { selectSpot(spotId); });
                    }

                    container.appendChild(spotElement);
                });

                var available = spots.filter(function(s) { return (s.etat || s.status) === 'free'; }).length;
                var reserved = spots.filter(function(s) { return (s.etat || s.status) === 'reserved'; }).length;
                var occupied = spots.filter(function(s) { return (s.etat || s.status) === 'occupied'; }).length;
                updateQuickStats({ available: available, reserved: reserved, occupied: occupied });
                
            } catch (error) {
                console.error('Error loading parking:', error);
                container.innerHTML = '<div class="error"><i class="fas fa-exclamation-triangle"></i> Erreur de chargement</div>';
                showNotification('Impossible de charger les places de parking.', 'error');
            }
        }

        // Select spot
        function selectSpot(spotId) {
            document.querySelectorAll('.parking-spot.selected').forEach(function(el) {
                el.classList.remove('selected');
            });

            var spotElement = document.querySelector('[data-id="' + spotId + '"]');
            if (spotElement) {
                spotElement.classList.add('selected');
            }

            selectedSpot = spotId;
            document.getElementById('selected-spot-display').textContent = spotId;
            document.getElementById('summary-spot').textContent = spotId;
            document.getElementById('reservation-form-container').classList.remove('hidden');
            updatePaymentAmount();
            
            // Scroll vers le formulaire
            document.getElementById('reservation-form-container').scrollIntoView({ 
                behavior: 'smooth', 
                block: 'center' 
            });
        }

        // Clear selection
        function clearSelection() {
            document.querySelectorAll('.parking-spot.selected').forEach(function(el) {
                el.classList.remove('selected');
            });
            selectedSpot = null;
            selectedPaymentMethod = null;
            document.getElementById('reservation-form-container').classList.add('hidden');
            document.querySelectorAll('.payment-option').forEach(function(opt) {
                opt.classList.remove('selected');
            });
            document.getElementById('phone-number').value = '';
        }

        // Load user reservations
        async function loadUserReservations() {
            var container = document.getElementById('user-reservations');
            var list = document.getElementById('reservation-list');
            var barrierSection = document.getElementById('barrier-code-section');
            
            if (!Auth.isLoggedIn()) {
                container.classList.add('hidden');
                if (barrierSection) barrierSection.style.display = 'none';
                return;
            }

            var user = Auth.getUser();
            
            try {
                // Get active reservation from API
                var response = await API.getMyReservation();
                var reservation = response.reservation;
                
                if (!response.has_reservation || !reservation) {
                    container.classList.remove('hidden');
                    if (barrierSection) barrierSection.style.display = 'none';
                    list.innerHTML = `
                        <div class="no-reservations">
                            <i class="fas fa-inbox" style="font-size: 3rem; color: var(--text-light); margin-bottom: 1rem;"></i>
                            <p>Vous n'avez aucune réservation active.</p>
                        </div>
                    `;
                    return;
                }

                container.classList.remove('hidden');
                if (barrierSection) barrierSection.style.display = 'block';
                
                // Déterminer le statut (etat ou status)
                var spotStatus = reservation.etat || reservation.status || 'reserved';
                const statusLabel = spotStatus === 'occupied' ? 
                    '<span class="status-badge occupied"><i class="fas fa-car"></i> Occupée</span>' : 
                    '<span class="status-badge reserved"><i class="fas fa-clock"></i> Réservée</span>';
                
                // Calculer le temps restant - utiliser reservation_end_time ou expires_at
                var expiresAt = reservation.reservation_end_time || reservation.expires_at || reservation.end_time;
                var reservedAt = reservation.reservation_start_time || reservation.reserved_at || reservation.created_at;
                
                const remaining = calculateRemainingTime(expiresAt);
                
                // Formater la date de réservation correctement
                var reservedDateStr = 'Date inconnue';
                if (reservedAt) {
                    try {
                        reservedDateStr = formatDate(reservedAt);
                    } catch(e) {
                        reservedDateStr = new Date().toLocaleDateString('fr-FR');
                    }
                }
                
                list.innerHTML = `
                    <div class="reservation-item" data-spot-id="${reservation.place_id}">
                        <div class="info">
                            <span class="spot-name"><i class="fas fa-parking"></i> Place ${reservation.place_id}</span>
                            ${statusLabel}
                            <span class="date"><i class="fas fa-calendar"></i> Réservée le ${reservedDateStr}</span>
                            <div class="countdown-timer" data-spot="${reservation.place_id}" data-expires="${expiresAt || ''}">
                                <i class="fas fa-hourglass-half"></i> 
                                <span class="time-remaining">${formatRemainingTime(remaining)}</span>
                            </div>
                        </div>
                        <button class="btn btn-danger" onclick="cancelReservation('${reservation.place_id}')">
                            <i class="fas fa-times"></i> Annuler
                        </button>
                    </div>
                `;
                
            } catch (error) {
                console.error('Erreur chargement réservations:', error);
                container.classList.remove('hidden');
                list.innerHTML = `
                    <div class="no-reservations">
                        <i class="fas fa-inbox" style="font-size: 3rem; color: var(--text-light); margin-bottom: 1rem;"></i>
                        <p>Vous n'avez aucune réservation active.</p>
                    </div>
                `;
            }
        }
        
        // Calculer le temps restant depuis expires_at
        function calculateRemainingTime(expiresAt) {
            if (!expiresAt) return { expired: true };
            
            const now = new Date();
            const expires = new Date(expiresAt);
            const diff = expires - now;
            
            if (diff <= 0) return { expired: true };
            
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);
            
            return { hours, minutes, seconds, expired: false };
        }

        // Formater le temps restant
        function formatRemainingTime(remaining) {
            if (!remaining || remaining.expired) {
                return '<span class="expired">Expirée</span>';
            }
            
            const { hours, minutes, seconds } = remaining;
            
            if (hours > 24) {
                const days = Math.floor(hours / 24);
                const remainingHours = hours % 24;
                return `${days}j ${remainingHours}h ${minutes}m`;
            }
            
            return `${hours}h ${minutes}m ${seconds}s`;
        }

        // Mettre à jour les compteurs en temps réel
        function updateCountdowns() {
            const countdownElements = document.querySelectorAll('.countdown-timer');
            
            countdownElements.forEach(el => {
                const expiresAt = el.dataset.expires;
                const remaining = calculateRemainingTime(expiresAt);
                const timeSpan = el.querySelector('.time-remaining');
                
                if (timeSpan) {
                    timeSpan.innerHTML = formatRemainingTime(remaining);
                    
                    // Ajouter une classe d'urgence si moins de 30 minutes
                    if (remaining && !remaining.expired && remaining.hours === 0 && remaining.minutes < 30) {
                        el.classList.add('urgent');
                    } else {
                        el.classList.remove('urgent');
                    }
                    
                    // Si expiré, recharger les données
                    if (remaining && remaining.expired) {
                        updateParkingGrid();
                        loadUserReservations();
                    }
                }
            });
        }

        // Variable pour stocker le spotId à annuler
        var spotToCancel = null;

        // Cancel reservation - ouvrir modal de confirmation
        function cancelReservation(spotId) {
            var user = Auth.getUser();
            if (!user) return;

            spotToCancel = spotId;
            document.getElementById('cancel-spot-info').textContent = 'Place: ' + spotId;
            document.getElementById('cancel-modal').classList.add('active');
            
            // Attacher l'événement de confirmation
            document.getElementById('confirm-cancel-btn').onclick = confirmCancelReservation;
        }

        // Fermer le modal d'annulation
        function closeCancelModal() {
            document.getElementById('cancel-modal').classList.remove('active');
            spotToCancel = null;
        }

        // Confirmer l'annulation
        async function confirmCancelReservation() {
            if (!spotToCancel) return;
            
            var btn = document.getElementById('confirm-cancel-btn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Annulation...';
            
            try {
                await API.releasePlace(spotToCancel);
                
                closeCancelModal();
                showNotification('Réservation de la place ' + spotToCancel + ' annulée.', 'success');
                await updateParkingGrid();
                await loadUserReservations();
                
            } catch (error) {
                console.error('Erreur annulation:', error);
                showNotification('Impossible d\'annuler cette réservation: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-times"></i> Confirmer l\'annulation';
            }
        }

        // Envoyer le code à la barrière
        async function sendBarrierCode() {
            var code = document.getElementById('barrier-code-input').value.trim().toUpperCase();
            var responseDiv = document.getElementById('barrier-response');
            var btn = document.getElementById('send-barrier-btn');
            
            if (!code || code.length < 3) {
                showNotification('Veuillez entrer un code valide.', 'error');
                return;
            }
            
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Envoi...';
            responseDiv.style.display = 'block';
            responseDiv.innerHTML = '<div style="padding: 1rem; background: #f0f9ff; border-radius: 8px; text-align: center;"><i class="fas fa-spinner fa-spin"></i> Vérification du code...</div>';
            
            try {
                // Appeler l'API de validation du code
                var result = await API.request('/api/v1/access/validate-code', {
                    method: 'POST',
                    body: { code: code }
                });
                
                if (result.valid) {
                    responseDiv.innerHTML = '<div style="padding: 1rem; background: #dcfce7; border: 1px solid #86efac; border-radius: 8px; text-align: center; color: #166534;"><i class="fas fa-check-circle"></i> <strong>Code valide !</strong><br>La barrière s\'ouvre...</div>';
                    showNotification('Barrière ouverte avec succès !', 'success');
                    
                    // Vider le champ après succès
                    document.getElementById('barrier-code-input').value = '';
                } else {
                    responseDiv.innerHTML = '<div style="padding: 1rem; background: #fee2e2; border: 1px solid #fecaca; border-radius: 8px; text-align: center; color: #dc2626;"><i class="fas fa-times-circle"></i> <strong>Code invalide ou expiré.</strong></div>';
                }
            } catch (error) {
                console.error('Erreur validation code:', error);
                responseDiv.innerHTML = '<div style="padding: 1rem; background: #fee2e2; border: 1px solid #fecaca; border-radius: 8px; text-align: center; color: #dc2626;"><i class="fas fa-times-circle"></i> ' + (error.message || 'Erreur de connexion') + '</div>';
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-paper-plane"></i> Envoyer';
            }
        }

        // Formater une date avec gestion des erreurs
        function formatDate(dateString) {
            if (!dateString) return 'Date non disponible';
            
            try {
                const date = new Date(dateString);
                
                // Vérifier si la date est valide
                if (isNaN(date.getTime())) {
                    return 'Date non disponible';
                }
                
                const options = { 
                    day: '2-digit', 
                    month: '2-digit', 
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    timeZone: 'Africa/Lubumbashi' // GMT+2
                };
                return date.toLocaleDateString('fr-FR', options);
            } catch (e) {
                return 'Date non disponible';
            }
        }

        // Mise à jour en temps réel (compteurs seulement)
        setInterval(() => {
            updateCountdowns();
        }, 1000);
        
        // Rafraîchir la grille toutes les 30 secondes
        setInterval(async () => {
            await updateParkingGrid();
        }, 30000);

        // ========================================
        // Fonctions de Paiement
        // ========================================

        // Mettre à jour le montant à payer
        function updatePaymentAmount() {
            let duration = parseFloat(document.getElementById('duration').value) || 0;
            
            // Validation des limites (accepter décimales comme 0.01h)
            if (duration < 0.01) duration = 0.01;
            if (duration > 168) duration = 168;
            
            // Calcul: 1000 FC/h, arrondi au franc supérieur
            const amount = Math.ceil(duration * RATE_PER_HOUR);
            const formattedAmount = amount.toLocaleString('fr-FR');
            
            document.getElementById('payment-amount').textContent = formattedAmount;
            document.getElementById('summary-total').textContent = formattedAmount + ' FC';
            
            // Mettre à jour la durée dans le résumé
            let durationText = duration + ' heure' + (duration > 1 ? 's' : '');
            if (duration >= 24) {
                const days = Math.floor(duration / 24);
                const remainingHours = duration % 24;
                if (remainingHours === 0) {
                    durationText = days + ' jour' + (days > 1 ? 's' : '') + ' (' + duration + 'h)';
                } else {
                    durationText = days + 'j ' + remainingHours.toFixed(1) + 'h (' + duration + 'h total)';
                }
            }
            
            document.getElementById('summary-duration').textContent = durationText;
        }

        // Sélectionner un mode de paiement
        function selectPaymentMethod(method) {
            selectedPaymentMethod = method;
            
            // Retirer la sélection précédente
            document.querySelectorAll('.payment-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            
            // Ajouter la sélection
            const selectedOption = document.querySelector(`#pm-${method}`).closest('.payment-option');
            selectedOption.classList.add('selected');
            document.querySelector(`#pm-${method}`).checked = true;
        }

        // Traiter le paiement
        async function processPayment() {
            const phoneNumber = document.getElementById('phone-number').value.trim();
            const duration = parseFloat(document.getElementById('duration').value) || 0;
            const durationMinutes = Math.round(duration * 60);
            
            // Validations
            if (!selectedSpot) {
                showNotification('Veuillez sélectionner une place.', 'error');
                return;
            }

            // Durée minimale: 20 minutes (0.33h), maximale: 1 semaine (168h)
            if (durationMinutes < 20) {
                showNotification('La durée minimale est de 20 minutes (environ 0.33 heure).', 'error');
                return;
            }

            if (durationMinutes > 168 * 60) {
                showNotification('La durée maximale est de 1 semaine (168 heures).', 'error');
                return;
            }
            
            if (!selectedPaymentMethod) {
                showNotification('Veuillez choisir un mode de paiement.', 'error');
                return;
            }
            
            if (!phoneNumber || phoneNumber.length < 10) {
                showNotification('Veuillez entrer un numéro de téléphone valide.', 'error');
                return;
            }

            // Afficher le modal de traitement
            showPaymentModal('processing');

            // Mapper les méthodes de paiement au format backend
            const paymentProviderMap = {
                'orange': 'ORANGE_MONEY',
                'airtel': 'AIRTEL_MONEY',
                'mpesa': 'MPESA'
            };
            
            const vehiclePlate = document.getElementById('vehicle-plate').value.trim();
            const amount = Math.ceil(duration * RATE_PER_HOUR);
            
            try {
                // 1. Create reservation via API
                var reservationResponse = await API.createReservation(
                    selectedSpot,
                    durationMinutes
                );
                
                // Get reservation ID for payment
                var reservationId = reservationResponse.reservation_id || selectedSpot;
                
                // 2. Process Mobile Money payment via API
                var paymentResponse = await API.processMobilePayment(
                    paymentProviderMap[selectedPaymentMethod],
                    phoneNumber,
                    amount,
                    reservationId
                );
                
                // Store access code for offline access
                if (paymentResponse.access_code) {
                    localStorage.setItem('aeropark_last_access_code', paymentResponse.access_code);
                    localStorage.setItem('aeropark_last_place', selectedSpot);
                }
                
                // Mettre à jour les statistiques utilisateur locales
                updateUserStats(duration, amount);
                
                // Paiement réussi - show access code
                showPaymentModal('success', paymentResponse.access_code);
                
            } catch (error) {
                console.error('Erreur paiement/réservation:', error);
                showPaymentModal('error');
                
                // Afficher le message d'erreur spécifique
                const errorMessage = error.data?.detail || error.message || 'Une erreur est survenue';
                document.getElementById('modal-message').textContent = errorMessage;
            }
        }

        // Afficher le modal de paiement
        function showPaymentModal(status, accessCode) {
            var modal = document.getElementById('payment-modal');
            var icon = document.getElementById('modal-icon');
            var title = document.getElementById('modal-title');
            var message = document.getElementById('modal-message');
            var btn = document.getElementById('modal-btn');
            
            modal.classList.add('active');
            
            if (status === 'processing') {
                icon.className = 'modal-icon processing';
                icon.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                title.textContent = 'Traitement en cours...';
                message.textContent = 'Veuillez confirmer le paiement sur votre téléphone';
                btn.classList.add('hidden');
            } else if (status === 'success') {
                icon.className = 'modal-icon success';
                icon.innerHTML = '<i class="fas fa-check-circle"></i>';
                title.textContent = 'Paiement réussi !';
                
                // Show access code prominently
                if (accessCode) {
                    message.innerHTML = '<p>Votre place a été réservée avec succès.</p>' +
                        '<div class="access-code-display" style="margin-top:1rem;padding:1rem;background:#f0f9ff;border-radius:10px;text-align:center;">' +
                        '<p style="margin:0;color:#666;font-size:0.9rem;">Votre code d\'accès :</p>' +
                        '<div style="font-size:2.5rem;font-weight:bold;color:#2563eb;letter-spacing:0.5rem;margin:0.5rem 0;">' + accessCode + '</div>' +
                        '<p style="margin:0;color:#666;font-size:0.8rem;">Présentez ce code à la barrière</p>' +
                        '</div>';
                } else {
                    message.textContent = 'Votre place a été réservée avec succès.';
                }
                
                btn.classList.remove('hidden');
                btn.className = 'btn btn-success';
                btn.innerHTML = '<i class="fas fa-check"></i> Parfait !';
            } else if (status === 'error') {
                icon.className = 'modal-icon error';
                icon.innerHTML = '<i class="fas fa-times-circle"></i>';
                title.textContent = 'Paiement échoué';
                message.textContent = 'Une erreur est survenue. Veuillez réessayer.';
                btn.classList.remove('hidden');
                btn.className = 'btn btn-danger';
                btn.innerHTML = '<i class="fas fa-redo"></i> Réessayer';
            }
        }

        // Mettre à jour les statistiques utilisateur locales après une réservation
        function updateUserStats(hours, amount) {
            try {
                var stats = JSON.parse(localStorage.getItem('aeropark_user_stats') || '{}');
                stats.reservationCount = (stats.reservationCount || 0) + 1;
                stats.totalHours = (stats.totalHours || 0) + parseFloat(hours);
                stats.totalSpent = (stats.totalSpent || 0) + parseInt(amount);
                localStorage.setItem('aeropark_user_stats', JSON.stringify(stats));
            } catch (e) {
                console.error('Erreur mise à jour stats:', e);
            }
        }

        // Fermer le modal de paiement
        async function closePaymentModal() {
            const modal = document.getElementById('payment-modal');
            const icon = document.getElementById('modal-icon');
            
            modal.classList.remove('active');
            
            // Si paiement réussi, réinitialiser la page
            if (icon.classList.contains('success')) {
                clearSelection();
                await updateParkingGrid();
                await loadUserReservations();
                selectedPaymentMethod = null;
                document.querySelectorAll('.payment-option').forEach(opt => {
                    opt.classList.remove('selected');
                });
                document.getElementById('phone-number').value = '';
            }
        }
    </script>
</body>
</html>

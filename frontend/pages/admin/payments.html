<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="AeroPark Admin - Gestion des Paiements">
    <meta name="theme-color" content="#1e3a5f">
    
    <title>Paiements - AeroPark Admin</title>
    
    <link rel="icon" type="image/png" href="../../assets/icons/favicon-32x32.png">
    <link rel="manifest" href="../../manifest.json">
    <link rel="stylesheet" href="../../css/styles.css">
</head>
<body class="role-admin">
    <!-- Offline Banner -->
    <div class="offline-banner" id="offline-banner">
        ‚ö†Ô∏è Vous √™tes actuellement hors ligne.
    </div>
    
    <!-- Header -->
    <header class="header">
        <div class="header-container">
            <a href="/frontend/index.html" class="logo">
                <svg class="logo-icon" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="20" cy="20" r="18" stroke="currentColor" stroke-width="2" fill="none"/>
                    <path d="M20 8 L20 32 M12 16 L28 16 M14 24 L26 24" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    <circle cx="20" cy="20" r="4" fill="currentColor"/>
                </svg>
                <span>AeroPark <span style="font-weight: 400; opacity: 0.8;">Admin</span></span>
            </a>
            
            <button class="hamburger-btn sidebar-toggle" id="sidebar-toggle" aria-label="Toggle sidebar">‚ò∞</button>
            
            <nav>
                <ul class="nav-menu">
                    <li><a href="/frontend/index.html" class="nav-link">üè† Site Public</a></li>
                    <li><a href="#" class="nav-link" id="logout-btn">üö™ D√©connexion</a></li>
                </ul>
            </nav>
        </div>
    </header>
    
    <!-- Admin Layout -->
    <div class="admin-layout">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <ul class="sidebar-menu">
                <li class="sidebar-item">
                    <a href="/frontend/pages/admin/dashboard.html" class="sidebar-link">
                        <span class="sidebar-link-icon">üìä</span>
                        Tableau de Bord
                    </a>
                </li>
                <li class="sidebar-item">
                    <a href="/frontend/pages/admin/parking.html" class="sidebar-link">
                        <span class="sidebar-link-icon">üÖøÔ∏è</span>
                        Gestion Parking
                    </a>
                </li>
                <li class="sidebar-item">
                    <a href="/frontend/pages/admin/reservations.html" class="sidebar-link">
                        <span class="sidebar-link-icon">üìÖ</span>
                        R√©servations
                    </a>
                </li>
                <li class="sidebar-item">
                    <a href="/frontend/pages/admin/payments.html" class="sidebar-link active">
                        <span class="sidebar-link-icon">üí≥</span>
                        Paiements
                    </a>
                </li>
                <li class="sidebar-item">
                    <a href="/frontend/pages/admin/users.html" class="sidebar-link">
                        <span class="sidebar-link-icon">üë•</span>
                        Utilisateurs
                    </a>
                </li>
                <li class="sidebar-item">
                    <a href="/frontend/pages/admin/system.html" class="sidebar-link">
                        <span class="sidebar-link-icon">‚öôÔ∏è</span>
                        √âtat du Syst√®me
                    </a>
                </li>
            </ul>
        </aside>
        
        <!-- Main Content -->
        <main class="admin-content" style="margin-top: var(--header-height);">
            <!-- Page Header -->
            <div class="page-header">
                <h1 class="page-title">üí≥ Gestion des Paiements</h1>
                <p class="page-subtitle">Consultez et g√©rez toutes les transactions de paiement</p>
            </div>
            
            <!-- Revenue Stats -->
            <section class="stats-grid mb-6">
                <div class="stat-card">
                    <div class="stat-card-icon success">üí∞</div>
                    <div class="stat-card-value" id="total-revenue">$0</div>
                    <div class="stat-card-label">Total Revenue</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-icon primary">üìÖ</div>
                    <div class="stat-card-value" id="today-revenue">$0</div>
                    <div class="stat-card-label">Today's Revenue</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-icon warning">‚è≥</div>
                    <div class="stat-card-value" id="pending-amount">$0</div>
                    <div class="stat-card-label">Pending Amount</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-icon info">üìä</div>
                    <div class="stat-card-value" id="transaction-count">0</div>
                    <div class="stat-card-label">Transactions</div>
                </div>
            </section>
            
            <!-- Revenue Chart Placeholder -->
            <section class="card mb-6">
                <div class="card-header">
                    <h3 class="card-title">Revenue Overview</h3>
                    <select class="form-select" style="width: auto;" id="chart-period">
                        <option value="week">Last 7 Days</option>
                        <option value="month" selected>Last 30 Days</option>
                        <option value="year">Last 12 Months</option>
                    </select>
                </div>
                <div style="height: 250px; display: flex; align-items: center; justify-content: center; background: var(--gray-100); border-radius: var(--radius-lg);">
                    <div class="text-center text-muted">
                        <div style="font-size: 48px; margin-bottom: 8px;">üìà</div>
                        <p>Revenue chart visualization</p>
                        <p class="text-sm">(Integrate with Chart.js for real charts)</p>
                    </div>
                </div>
            </section>
            
            <!-- Filters -->
            <section class="card mb-6">
                <div class="flex gap-4" style="flex-wrap: wrap; align-items: flex-end;">
                    <div class="form-group mb-0" style="flex: 1; min-width: 150px;">
                        <label class="form-label">Status</label>
                        <select class="form-select" id="filter-status">
                            <option value="">All Status</option>
                            <option value="completed">Completed</option>
                            <option value="pending">Pending</option>
                            <option value="failed">Failed</option>
                            <option value="refunded">Refunded</option>
                        </select>
                    </div>
                    <div class="form-group mb-0" style="flex: 1; min-width: 150px;">
                        <label class="form-label">Payment Method</label>
                        <select class="form-select" id="filter-method">
                            <option value="">All Methods</option>
                            <option value="card">Credit/Debit Card</option>
                            <option value="mpesa">M-Pesa</option>
                            <option value="wallet">Wallet</option>
                            <option value="cash">Cash</option>
                        </select>
                    </div>
                    <div class="form-group mb-0" style="flex: 1; min-width: 150px;">
                        <label class="form-label">From Date</label>
                        <input type="date" class="form-input" id="filter-from">
                    </div>
                    <div class="form-group mb-0" style="flex: 1; min-width: 150px;">
                        <label class="form-label">To Date</label>
                        <input type="date" class="form-input" id="filter-to">
                    </div>
                    <div class="form-group mb-0" style="flex: 2; min-width: 200px;">
                        <label class="form-label">Search</label>
                        <input type="text" class="form-input" id="search-payments" placeholder="Search by user, transaction ID...">
                    </div>
                    <button class="btn btn-primary" id="apply-filters-btn">Apply</button>
                    <button class="btn btn-outline" id="export-btn">üìä Export</button>
                </div>
            </section>
            
            <!-- Payments Table -->
            <section class="card">
                <div class="card-header">
                    <h3 class="card-title">Payment Transactions</h3>
                    <span class="text-muted" id="results-count">Loading...</span>
                </div>
                <div class="table-container" style="box-shadow: none;">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Transaction ID</th>
                                <th>User</th>
                                <th>Reservation</th>
                                <th>Amount</th>
                                <th>Method</th>
                                <th>Date</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="payments-body">
                            <tr>
                                <td colspan="8" class="text-center text-muted p-4">Loading payments...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination -->
                <div class="flex justify-between items-center mt-4 p-4" style="border-top: 1px solid var(--gray-200);">
                    <div class="text-muted">
                        Showing <span id="showing-start">1</span> - <span id="showing-end">10</span> of <span id="total-count">0</span>
                    </div>
                    <div class="flex gap-2">
                        <button class="btn btn-sm btn-outline" id="prev-btn" disabled>‚Üê Previous</button>
                        <button class="btn btn-sm btn-outline" id="next-btn">Next ‚Üí</button>
                    </div>
                </div>
            </section>
        </main>
    </div>
    
    <!-- Payment Details Modal -->
    <div class="modal-backdrop" id="details-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Payment Details</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modal-content">
                <!-- Content populated by JS -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal()">Close</button>
                <button class="btn btn-warning" id="refund-btn" style="display: none;">Issue Refund</button>
            </div>
        </div>
    </div>
    
    <!-- Scripts -->
    <script src="../../js/services/api.js"></script>
    <script src="../../js/services/auth.js"></script>
    <script src="../../js/services/state.js"></script>
    <script src="../../js/services/notifications.js"></script>
    <script src="../../js/utils/helpers.js"></script>
    <script src="../../js/app.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <!-- Page Script -->
    <script>
        let allPayments = [];
        let currentPage = 1;
        const pageSize = 10;
        let selectedPayment = null;
        
        document.addEventListener('DOMContentLoaded', async () => {
            // Check admin
            if (localStorage.getItem('aeropark_role') !== 'admin') {
                window.location.href = '/frontend/pages/public/login.html';
                return;
            }
            
            // Load payments
            await loadPayments();
            
            // Event listeners
            document.getElementById('apply-filters-btn').addEventListener('click', () => {
                currentPage = 1;
                filterPayments();
            });
            
            document.getElementById('search-payments').addEventListener('input', 
                Helpers.debounce(() => {
                    currentPage = 1;
                    filterPayments();
                }, 300)
            );
            
            document.getElementById('filter-status').addEventListener('change', filterPayments);
            document.getElementById('filter-method').addEventListener('change', filterPayments);
            
            document.getElementById('prev-btn').addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderPayments();
                }
            });
            
            document.getElementById('next-btn').addEventListener('click', () => {
                const totalPages = Math.ceil(getFilteredPayments().length / pageSize);
                if (currentPage < totalPages) {
                    currentPage++;
                    renderPayments();
                }
            });
            
            document.getElementById('export-btn').addEventListener('click', exportPayments);
            document.getElementById('refund-btn').addEventListener('click', refundPayment);
            
            // Sidebar toggle
            document.getElementById('sidebar-toggle').addEventListener('click', () => {
                document.getElementById('sidebar').classList.toggle('active');
            });
            
            // Logout
            document.getElementById('logout-btn').addEventListener('click', (e) => {
                e.preventDefault();
                localStorage.clear();
                window.location.href = '/frontend/pages/public/login.html';
            });
        });
        
        async function loadPayments() {
            try {
                // Fetch from API
                const response = await ApiService.getAllPayments();
                // Handle different response formats
                allPayments = response.payments || response || [];
            } catch (error) {
                console.error('√âchec du chargement des paiements:', error);
                NotificationService.error('Erreur lors du chargement des paiements: ' + error.message);
                allPayments = [];
            }
            
            updateStats();
            renderPayments();
        }
        
        function updateStats() {
            const completed = allPayments.filter(p => p.status === 'completed');
            const pending = allPayments.filter(p => p.status === 'pending');
            
            const totalRevenue = completed.reduce((sum, p) => sum + (p.amount || 0), 0);
            const pendingAmount = pending.reduce((sum, p) => sum + (p.amount || 0), 0);
            
            const today = new Date().toDateString();
            const todayPayments = completed.filter(p => 
                new Date(p.created_at).toDateString() === today
            );
            const todayRevenue = todayPayments.reduce((sum, p) => sum + (p.amount || 0), 0);
            
            document.getElementById('total-revenue').textContent = Helpers.formatCurrency(totalRevenue);
            document.getElementById('today-revenue').textContent = Helpers.formatCurrency(todayRevenue);
            document.getElementById('pending-amount').textContent = Helpers.formatCurrency(pendingAmount);
            document.getElementById('transaction-count').textContent = allPayments.length;
        }
        
        function getFilteredPayments() {
            let filtered = [...allPayments];
            
            const status = document.getElementById('filter-status').value;
            const method = document.getElementById('filter-method').value;
            const search = document.getElementById('search-payments').value.toLowerCase();
            const from = document.getElementById('filter-from').value;
            const to = document.getElementById('filter-to').value;
            
            if (status) {
                filtered = filtered.filter(p => p.status === status);
            }
            
            if (method) {
                filtered = filtered.filter(p => p.method === method);
            }
            
            if (search) {
                filtered = filtered.filter(p => 
                    p.id.toLowerCase().includes(search) ||
                    (p.user_email && p.user_email.toLowerCase().includes(search)) ||
                    (p.reservation_id && p.reservation_id.toLowerCase().includes(search))
                );
            }
            
            if (from) {
                const fromDate = new Date(from);
                filtered = filtered.filter(p => new Date(p.created_at) >= fromDate);
            }
            
            if (to) {
                const toDate = new Date(to);
                toDate.setHours(23, 59, 59);
                filtered = filtered.filter(p => new Date(p.created_at) <= toDate);
            }
            
            return filtered;
        }
        
        function filterPayments() {
            currentPage = 1;
            renderPayments();
        }
        
        function renderPayments() {
            const filtered = getFilteredPayments();
            const totalPages = Math.ceil(filtered.length / pageSize);
            const start = (currentPage - 1) * pageSize;
            const end = Math.min(start + pageSize, filtered.length);
            const page = filtered.slice(start, end);
            
            // Update results count
            document.getElementById('results-count').textContent = `${filtered.length} transactions`;
            document.getElementById('showing-start').textContent = filtered.length ? start + 1 : 0;
            document.getElementById('showing-end').textContent = end;
            document.getElementById('total-count').textContent = filtered.length;
            
            // Update pagination buttons
            document.getElementById('prev-btn').disabled = currentPage === 1;
            document.getElementById('next-btn').disabled = currentPage >= totalPages;
            
            const tbody = document.getElementById('payments-body');
            
            if (page.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center text-muted p-4">No payments found</td>
                    </tr>
                `;
                return;
            }
            
            const methodLabels = {
                card: 'üí≥ Card',
                mpesa: 'üì± M-Pesa',
                wallet: 'üëõ Wallet',
                cash: 'üíµ Cash'
            };
            
            tbody.innerHTML = page.map(p => `
                <tr>
                    <td><code>${p.id}</code></td>
                    <td>${p.user_email || p.user_id}</td>
                    <td>${p.reservation_id || '-'}</td>
                    <td><strong>${Helpers.formatCurrency(p.amount)}</strong></td>
                    <td>${methodLabels[p.method] || p.method}</td>
                    <td>${Helpers.formatDateTime(p.created_at)}</td>
                    <td>
                        <span class="status-badge ${getPaymentStatusClass(p.status)}">
                            ${p.status}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline" onclick="viewPayment('${p.id}')">
                            View
                        </button>
                    </td>
                </tr>
            `).join('');
        }
        
        function getPaymentStatusClass(status) {
            switch (status) {
                case 'completed': return 'success';
                case 'pending': return 'warning';
                case 'failed': return 'danger';
                case 'refunded': return 'info';
                default: return '';
            }
        }
        
        function viewPayment(id) {
            selectedPayment = allPayments.find(p => p.id === id);
            if (!selectedPayment) return;
            
            const p = selectedPayment;
            const methodLabels = {
                card: 'üí≥ Credit/Debit Card',
                mpesa: 'üì± M-Pesa',
                wallet: 'üëõ Digital Wallet',
                cash: 'üíµ Cash'
            };
            
            document.getElementById('modal-content').innerHTML = `
                <div class="mb-4">
                    <div class="flex justify-between mb-2">
                        <span class="text-muted">Transaction ID</span>
                        <code>${p.id}</code>
                    </div>
                    <div class="flex justify-between mb-2">
                        <span class="text-muted">User</span>
                        <span>${p.user_email || p.user_id}</span>
                    </div>
                    <div class="flex justify-between mb-2">
                        <span class="text-muted">Reservation</span>
                        <span>${p.reservation_id || '-'}</span>
                    </div>
                    <div class="flex justify-between mb-2">
                        <span class="text-muted">Amount</span>
                        <strong style="font-size: 1.25rem;">${Helpers.formatCurrency(p.amount)}</strong>
                    </div>
                    <div class="flex justify-between mb-2">
                        <span class="text-muted">Payment Method</span>
                        <span>${methodLabels[p.method] || p.method}</span>
                    </div>
                    <div class="flex justify-between mb-2">
                        <span class="text-muted">Date & Time</span>
                        <span>${Helpers.formatDateTime(p.created_at)}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-muted">Status</span>
                        <span class="status-badge ${getPaymentStatusClass(p.status)}">${p.status}</span>
                    </div>
                </div>
                
                ${p.status === 'completed' ? `
                    <div class="alert alert-info">
                        <strong>Receipt:</strong> A payment receipt was sent to ${p.user_email || 'the user\'s email'}.
                    </div>
                ` : ''}
            `;
            
            // Show refund button only for completed payments
            document.getElementById('refund-btn').style.display = 
                p.status === 'completed' ? 'block' : 'none';
            
            document.getElementById('details-modal').classList.add('active');
        }
        
        function closeModal() {
            document.getElementById('details-modal').classList.remove('active');
            selectedPayment = null;
        }
        
        async function refundPayment() {
            if (!selectedPayment) return;
            
            if (!confirm(`Issue a full refund of ${Helpers.formatCurrency(selectedPayment.amount)} for transaction ${selectedPayment.id}?`)) return;
            
            try {
                // API call to issue refund
                // await ApiService.refundPayment(selectedPayment.id);
                
                // Update local state for demo
                selectedPayment.status = 'refunded';
                
                NotificationService.success('Refund issued successfully');
                closeModal();
                renderPayments();
            } catch (error) {
                NotificationService.error(error.message || 'Failed to issue refund');
            }
        }
        
        function exportPayments() {
            const filtered = getFilteredPayments();
            
            const csv = [
                ['Transaction ID', 'User', 'Reservation', 'Amount', 'Method', 'Date', 'Status'].join(','),
                ...filtered.map(p => [
                    p.id,
                    p.user_email || p.user_id,
                    p.reservation_id || '',
                    p.amount,
                    p.method,
                    p.created_at,
                    p.status
                ].join(','))
            ].join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `payments-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            
            NotificationService.success('Export complete');
        }
    </script>

    <!-- Conteneur Toast -->
    <div class="toast-container" id="toast-container"></div>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="AeroPark Admin - System Status">
    <meta name="theme-color" content="#1e3a5f">
    
    <title>System Status - AeroPark Admin</title>
    
    <link rel="icon" type="image/png" href="../../assets/icons/favicon-32x32.png">
    <link rel="manifest" href="../../manifest.json">
    <link rel="stylesheet" href="../../css/styles.css">
</head>
<body class="role-admin">
    <!-- Offline Banner -->
    <div class="offline-banner" id="offline-banner">
        ‚ö†Ô∏è You are currently offline.
    </div>
    
    <!-- Header -->
    <header class="header">
        <div class="header-container">
            <a href="/frontend/index.html" class="logo">
                <svg class="logo-icon" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="20" cy="20" r="18" stroke="currentColor" stroke-width="2" fill="none"/>
                    <path d="M20 8 L20 32 M12 16 L28 16 M14 24 L26 24" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    <circle cx="20" cy="20" r="4" fill="currentColor"/>
                </svg>
                <span>AeroPark <span style="font-weight: 400; opacity: 0.8;">Admin</span></span>
            </a>
            
            <button class="nav-toggle sidebar-toggle" id="sidebar-toggle" aria-label="Toggle sidebar">‚ò∞</button>
            
            <nav>
                <ul class="nav-menu">
                    <li><a href="/frontend/index.html" class="nav-link">üè† Public Site</a></li>
                    <li><a href="#" class="nav-link" id="logout-btn">üö™ Logout</a></li>
                </ul>
            </nav>
        </div>
    </header>
    
    <!-- Admin Layout -->
    <div class="admin-layout">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <ul class="sidebar-menu">
                <li class="sidebar-item">
                    <a href="/frontend/pages/admin/dashboard.html" class="sidebar-link">
                        <span class="sidebar-link-icon">üìä</span>
                        Dashboard
                    </a>
                </li>
                <li class="sidebar-item">
                    <a href="/frontend/pages/admin/parking.html" class="sidebar-link">
                        <span class="sidebar-link-icon">üÖøÔ∏è</span>
                        Parking Management
                    </a>
                </li>
                <li class="sidebar-item">
                    <a href="/frontend/pages/admin/reservations.html" class="sidebar-link">
                        <span class="sidebar-link-icon">üìÖ</span>
                        Reservations
                    </a>
                </li>
                <li class="sidebar-item">
                    <a href="/frontend/pages/admin/payments.html" class="sidebar-link">
                        <span class="sidebar-link-icon">üí≥</span>
                        Payments
                    </a>
                </li>
                <li class="sidebar-item">
                    <a href="/frontend/pages/admin/users.html" class="sidebar-link">
                        <span class="sidebar-link-icon">üë•</span>
                        Users
                    </a>
                </li>
                <li class="sidebar-item">
                    <a href="/frontend/pages/admin/system.html" class="sidebar-link active">
                        <span class="sidebar-link-icon">‚öôÔ∏è</span>
                        System Status
                    </a>
                </li>
            </ul>
        </aside>
        
        <!-- Main Content -->
        <main class="admin-content" style="margin-top: var(--header-height);">
            <!-- Page Header -->
            <div class="page-header flex justify-between items-center" style="flex-wrap: wrap; gap: var(--spacing-4);">
                <div>
                    <h1 class="page-title">‚öôÔ∏è System Status</h1>
                    <p class="page-subtitle">Monitor system health and configuration</p>
                </div>
                <button class="btn btn-primary" id="refresh-btn">üîÑ Refresh Status</button>
            </div>
            
            <!-- Overall Status -->
            <section class="card mb-6">
                <div class="flex items-center gap-4 mb-4">
                    <div id="overall-status-icon" style="font-size: 48px;">‚úÖ</div>
                    <div>
                        <h2 style="margin: 0;" id="overall-status-text">All Systems Operational</h2>
                        <p class="text-muted mb-0" id="last-check">Last checked: --</p>
                    </div>
                </div>
            </section>
            
            <!-- Service Status Grid -->
            <section class="grid gap-6 mb-6" style="grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));">
                <!-- API Server -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">üñ•Ô∏è API Server</h3>
                        <span class="status-badge success" id="api-status">‚óè Online</span>
                    </div>
                    <div class="mb-2">
                        <div class="flex justify-between text-sm">
                            <span class="text-muted">Response Time</span>
                            <span id="api-response-time">-- ms</span>
                        </div>
                    </div>
                    <div class="mb-2">
                        <div class="flex justify-between text-sm">
                            <span class="text-muted">Uptime</span>
                            <span id="api-uptime">--%</span>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between text-sm">
                            <span class="text-muted">Version</span>
                            <span id="api-version">v1.0.0</span>
                        </div>
                    </div>
                </div>
                
                <!-- Database -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">üóÑÔ∏è Database</h3>
                        <span class="status-badge success" id="db-status">‚óè Connected</span>
                    </div>
                    <div class="mb-2">
                        <div class="flex justify-between text-sm">
                            <span class="text-muted">Type</span>
                            <span>Firebase Firestore</span>
                        </div>
                    </div>
                    <div class="mb-2">
                        <div class="flex justify-between text-sm">
                            <span class="text-muted">Connections</span>
                            <span id="db-connections">Active</span>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between text-sm">
                            <span class="text-muted">Last Backup</span>
                            <span id="db-backup">Auto</span>
                        </div>
                    </div>
                </div>
                
                <!-- Authentication -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">üîê Authentication</h3>
                        <span class="status-badge success" id="auth-status">‚óè Active</span>
                    </div>
                    <div class="mb-2">
                        <div class="flex justify-between text-sm">
                            <span class="text-muted">Provider</span>
                            <span>Firebase Auth</span>
                        </div>
                    </div>
                    <div class="mb-2">
                        <div class="flex justify-between text-sm">
                            <span class="text-muted">Active Sessions</span>
                            <span id="auth-sessions">--</span>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between text-sm">
                            <span class="text-muted">MFA Enabled</span>
                            <span>Optional</span>
                        </div>
                    </div>
                </div>
                
                <!-- Payment Gateway -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">üí≥ Payment Gateway</h3>
                        <span class="status-badge success" id="payment-status">‚óè Active</span>
                    </div>
                    <div class="mb-2">
                        <div class="flex justify-between text-sm">
                            <span class="text-muted">Providers</span>
                            <span>Card, M-Pesa</span>
                        </div>
                    </div>
                    <div class="mb-2">
                        <div class="flex justify-between text-sm">
                            <span class="text-muted">Today's Transactions</span>
                            <span id="payment-transactions">--</span>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between text-sm">
                            <span class="text-muted">Success Rate</span>
                            <span id="payment-success-rate">--%</span>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Hardware Status -->
            <section class="card mb-6">
                <div class="card-header">
                    <h3 class="card-title">üîß Hardware Status</h3>
                    <span class="text-muted">IoT Devices & Sensors</span>
                </div>
                
                <div class="table-container" style="box-shadow: none;">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Device</th>
                                <th>Type</th>
                                <th>Location</th>
                                <th>Last Ping</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="devices-body">
                            <tr>
                                <td>Entry Gate Controller</td>
                                <td>ESP32</td>
                                <td>Main Entrance</td>
                                <td>2 sec ago</td>
                                <td><span class="status-badge success">‚óè Online</span></td>
                            </tr>
                            <tr>
                                <td>Exit Gate Controller</td>
                                <td>ESP32</td>
                                <td>Main Exit</td>
                                <td>5 sec ago</td>
                                <td><span class="status-badge success">‚óè Online</span></td>
                            </tr>
                            <tr>
                                <td>Sensor Hub A</td>
                                <td>ESP32</td>
                                <td>Zone A</td>
                                <td>3 sec ago</td>
                                <td><span class="status-badge success">‚óè Online</span></td>
                            </tr>
                            <tr>
                                <td>Sensor Hub B</td>
                                <td>ESP32</td>
                                <td>Zone B</td>
                                <td>4 sec ago</td>
                                <td><span class="status-badge success">‚óè Online</span></td>
                            </tr>
                            <tr>
                                <td>Display Board 1</td>
                                <td>LED Panel</td>
                                <td>Entrance</td>
                                <td>10 sec ago</td>
                                <td><span class="status-badge success">‚óè Online</span></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>
            
            <!-- System Configuration -->
            <section class="card mb-6">
                <div class="card-header">
                    <h3 class="card-title">‚öôÔ∏è System Configuration</h3>
                    <button class="btn btn-sm btn-outline" id="edit-config-btn">Edit Settings</button>
                </div>
                
                <div class="grid gap-4" style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));">
                    <div>
                        <h4 class="text-sm text-muted mb-2">Parking Settings</h4>
                        <div class="flex justify-between mb-2 text-sm">
                            <span>Total Spots</span>
                            <strong id="config-spots">24</strong>
                        </div>
                        <div class="flex justify-between mb-2 text-sm">
                            <span>Base Hourly Rate</span>
                            <strong>$5.00</strong>
                        </div>
                        <div class="flex justify-between mb-2 text-sm">
                            <span>Max Reservation Duration</span>
                            <strong>24 hours</strong>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span>Grace Period</span>
                            <strong>15 minutes</strong>
                        </div>
                    </div>
                    
                    <div>
                        <h4 class="text-sm text-muted mb-2">Access Codes</h4>
                        <div class="flex justify-between mb-2 text-sm">
                            <span>Code Validity</span>
                            <strong>15 minutes</strong>
                        </div>
                        <div class="flex justify-between mb-2 text-sm">
                            <span>Code Format</span>
                            <strong>6 digits</strong>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span>Max Active Codes/User</span>
                            <strong>1</strong>
                        </div>
                    </div>
                    
                    <div>
                        <h4 class="text-sm text-muted mb-2">Notifications</h4>
                        <div class="flex justify-between mb-2 text-sm">
                            <span>Email Notifications</span>
                            <strong class="text-success">Enabled</strong>
                        </div>
                        <div class="flex justify-between mb-2 text-sm">
                            <span>SMS Notifications</span>
                            <strong class="text-success">Enabled</strong>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span>Push Notifications</span>
                            <strong class="text-success">Enabled</strong>
                        </div>
                    </div>
                    
                    <div>
                        <h4 class="text-sm text-muted mb-2">Security</h4>
                        <div class="flex justify-between mb-2 text-sm">
                            <span>API Key Required</span>
                            <strong class="text-success">Yes</strong>
                        </div>
                        <div class="flex justify-between mb-2 text-sm">
                            <span>Rate Limiting</span>
                            <strong>100 req/min</strong>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span>Session Timeout</span>
                            <strong>24 hours</strong>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Recent System Logs -->
            <section class="card mb-6">
                <div class="card-header">
                    <h3 class="card-title">üìã Recent System Logs</h3>
                    <button class="btn btn-sm btn-outline" id="view-all-logs-btn">View All Logs</button>
                </div>
                
                <div class="table-container" style="box-shadow: none; max-height: 300px; overflow-y: auto;">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>Level</th>
                                <th>Service</th>
                                <th>Message</th>
                            </tr>
                        </thead>
                        <tbody id="logs-body">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
            </section>
            
            <!-- Quick Actions -->
            <section class="card">
                <h3 class="card-title mb-4">üõ†Ô∏è Maintenance Actions</h3>
                <div class="grid gap-4" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                    <button class="btn btn-outline btn-block" id="clear-cache-btn">
                        üóëÔ∏è Clear Cache
                    </button>
                    <button class="btn btn-outline btn-block" id="restart-services-btn">
                        üîÑ Restart Services
                    </button>
                    <button class="btn btn-outline btn-block" id="backup-db-btn">
                        üíæ Backup Database
                    </button>
                    <button class="btn btn-outline btn-block" id="download-logs-btn">
                        üì• Download Logs
                    </button>
                </div>
            </section>
        </main>
    </div>
    
    <!-- Scripts -->
    <script src="../../js/services/api.js"></script>
    <script src="../../js/services/auth.js"></script>
    <script src="../../js/services/state.js"></script>
    <script src="../../js/services/notifications.js"></script>
    <script src="../../js/utils/helpers.js"></script>
    <script src="../../js/app.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <!-- Page Script -->
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // Check admin
            if (localStorage.getItem('aeropark_role') !== 'admin') {
                window.location.href = '/frontend/pages/public/login.html';
                return;
            }
            
            // Load system status
            await checkSystemStatus();
            loadSystemLogs();
            
            // Event listeners
            document.getElementById('refresh-btn').addEventListener('click', checkSystemStatus);
            document.getElementById('clear-cache-btn').addEventListener('click', clearCache);
            document.getElementById('restart-services-btn').addEventListener('click', restartServices);
            document.getElementById('backup-db-btn').addEventListener('click', backupDatabase);
            document.getElementById('download-logs-btn').addEventListener('click', downloadLogs);
            
            // Sidebar toggle
            document.getElementById('sidebar-toggle').addEventListener('click', () => {
                document.getElementById('sidebar').classList.toggle('active');
            });
            
            // Logout
            document.getElementById('logout-btn').addEventListener('click', (e) => {
                e.preventDefault();
                localStorage.clear();
                window.location.href = '/frontend/pages/public/login.html';
            });
            
            // Auto-refresh every 30 seconds
            setInterval(checkSystemStatus, 30000);
        });
        
        async function checkSystemStatus() {
            const startTime = Date.now();
            
            try {
                // Check API health
                const health = await ApiService.healthCheck();
                const responseTime = Date.now() - startTime;
                
                document.getElementById('api-status').innerHTML = '‚óè Online';
                document.getElementById('api-status').className = 'status-badge success';
                document.getElementById('api-response-time').textContent = `${responseTime} ms`;
                document.getElementById('api-uptime').textContent = '99.9%';
                document.getElementById('api-version').textContent = health.version || 'v1.0.0';
                
                // Update overall status
                document.getElementById('overall-status-icon').textContent = '‚úÖ';
                document.getElementById('overall-status-text').textContent = 'All Systems Operational';
                
            } catch (error) {
                document.getElementById('api-status').innerHTML = '‚óè Offline';
                document.getElementById('api-status').className = 'status-badge danger';
                
                document.getElementById('overall-status-icon').textContent = '‚ö†Ô∏è';
                document.getElementById('overall-status-text').textContent = 'Some Systems Need Attention';
            }
            
            // Update last check time
            document.getElementById('last-check').textContent = `Last checked: ${new Date().toLocaleTimeString()}`;
            
            // Get parking spots count
            try {
                const spots = await ApiService.getParkingSpots();
                document.getElementById('config-spots').textContent = spots.length;
            } catch (e) {
                // Keep default
            }
            
            // Simulate other status checks
            document.getElementById('auth-sessions').textContent = Math.floor(Math.random() * 50) + 10;
            document.getElementById('payment-transactions').textContent = Math.floor(Math.random() * 20);
            document.getElementById('payment-success-rate').textContent = (95 + Math.random() * 5).toFixed(1) + '%';
        }
        
        function loadSystemLogs() {
            const logs = [
                { timestamp: new Date(), level: 'INFO', service: 'API', message: 'Health check passed' },
                { timestamp: new Date(Date.now() - 60000), level: 'INFO', service: 'Auth', message: 'User login: admin@aeropark.com' },
                { timestamp: new Date(Date.now() - 120000), level: 'INFO', service: 'Reservation', message: 'New reservation created: RES-123' },
                { timestamp: new Date(Date.now() - 180000), level: 'INFO', service: 'Payment', message: 'Payment processed: $15.00' },
                { timestamp: new Date(Date.now() - 240000), level: 'WARN', service: 'Sensor', message: 'Sensor Hub A response delayed' },
                { timestamp: new Date(Date.now() - 300000), level: 'INFO', service: 'Gate', message: 'Entry gate opened for vehicle XYZ-123' },
                { timestamp: new Date(Date.now() - 360000), level: 'INFO', service: 'API', message: 'Rate limit reset for IP 192.168.1.1' },
                { timestamp: new Date(Date.now() - 420000), level: 'ERROR', service: 'Email', message: 'Failed to send email: SMTP timeout' },
                { timestamp: new Date(Date.now() - 480000), level: 'INFO', service: 'System', message: 'Scheduled backup completed' },
                { timestamp: new Date(Date.now() - 540000), level: 'INFO', service: 'Auth', message: 'User logout: user@example.com' }
            ];
            
            const tbody = document.getElementById('logs-body');
            
            tbody.innerHTML = logs.map(log => {
                let levelClass = '';
                switch (log.level) {
                    case 'INFO': levelClass = 'info'; break;
                    case 'WARN': levelClass = 'warning'; break;
                    case 'ERROR': levelClass = 'danger'; break;
                    default: levelClass = '';
                }
                
                return `
                    <tr>
                        <td class="text-muted text-sm">${log.timestamp.toLocaleTimeString()}</td>
                        <td><span class="status-badge ${levelClass}">${log.level}</span></td>
                        <td><code>${log.service}</code></td>
                        <td>${log.message}</td>
                    </tr>
                `;
            }).join('');
        }
        
        async function clearCache() {
            if (!confirm('Clear all cached data?')) return;
            
            try {
                // Clear service worker caches
                if ('caches' in window) {
                    const cacheNames = await caches.keys();
                    await Promise.all(cacheNames.map(name => caches.delete(name)));
                }
                
                NotificationService.success('Cache cleared successfully');
            } catch (error) {
                NotificationService.error('Failed to clear cache');
            }
        }
        
        async function restartServices() {
            if (!confirm('Restart all services? This may cause brief downtime.')) return;
            
            NotificationService.info('Restarting services...');
            
            // Simulate restart
            setTimeout(() => {
                NotificationService.success('Services restarted successfully');
                checkSystemStatus();
            }, 3000);
        }
        
        async function backupDatabase() {
            NotificationService.info('Starting database backup...');
            
            // Simulate backup
            setTimeout(() => {
                NotificationService.success('Database backup completed');
            }, 5000);
        }
        
        function downloadLogs() {
            const logs = `AeroPark System Logs
Generated: ${new Date().toISOString()}
========================================

${new Date().toISOString()} [INFO] API: Health check passed
${new Date(Date.now() - 60000).toISOString()} [INFO] Auth: User login: admin@aeropark.com
${new Date(Date.now() - 120000).toISOString()} [INFO] Reservation: New reservation created
${new Date(Date.now() - 180000).toISOString()} [INFO] Payment: Payment processed: $15.00
${new Date(Date.now() - 240000).toISOString()} [WARN] Sensor: Sensor Hub A response delayed
`;
            
            const blob = new Blob([logs], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `aeropark-logs-${new Date().toISOString().split('T')[0]}.txt`;
            a.click();
            
            NotificationService.success('Logs downloaded');
        }
    </script>
</body>
</html>

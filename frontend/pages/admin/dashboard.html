<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Tableau de Bord Admin AeroPark - Aper√ßu du Syst√®me">
    <meta name="theme-color" content="#1e3a5f">
    
    <title>Tableau de Bord Admin - AeroPark GOMA</title>
    
    <link rel="icon" type="image/png" href="../../assets/icons/favicon-32x32.png">
    <link rel="manifest" href="../../manifest.json">
    <link rel="stylesheet" href="../../css/styles.css">
</head>
<body class="role-admin">
    <!-- Banni√®re Hors Ligne -->
    <div class="offline-banner" id="offline-banner">
        ‚ö†Ô∏è Vous √™tes actuellement hors ligne. Certaines fonctionnalit√©s admin peuvent √™tre limit√©es.
    </div>
    
    <!-- En-t√™te -->
    <header class="header">
        <div class="header-container">
            <a href="/frontend/index.html" class="logo">
                <svg class="logo-icon" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="20" cy="20" r="18" stroke="currentColor" stroke-width="2" fill="none"/>
                    <path d="M20 8 L20 32 M12 16 L28 16 M14 24 L26 24" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    <circle cx="20" cy="20" r="4" fill="currentColor"/>
                </svg>
                <span>AeroPark <span style="font-weight: 400; opacity: 0.8;">Admin</span></span>
            </a>
            
            <button class="hamburger-btn sidebar-toggle" id="sidebar-toggle" aria-label="Toggle sidebar">‚ò∞</button>
            
            <nav>
                <ul class="nav-menu" id="nav-menu">
                    <li><a href="/frontend/index.html" class="nav-link">üè† Site Public</a></li>
                    <li><a href="#" class="nav-link" id="logout-btn">üö™ D√©connexion</a></li>
                </ul>
            </nav>
        </div>
    </header>
    
    <!-- Layout Admin -->
    <div class="admin-layout">
        <!-- Barre Lat√©rale -->
        <aside class="sidebar" id="sidebar">
            <ul class="sidebar-menu">
                <li class="sidebar-item">
                    <a href="/frontend/pages/admin/dashboard.html" class="sidebar-link active">
                        <span class="sidebar-link-icon">üìä</span>
                        Tableau de Bord
                    </a>
                </li>
                <li class="sidebar-item">
                    <a href="/frontend/pages/admin/parking.html" class="sidebar-link">
                        <span class="sidebar-link-icon">üÖøÔ∏è</span>
                        Gestion Parking
                    </a>
                </li>
                <li class="sidebar-item">
                    <a href="/frontend/pages/admin/reservations.html" class="sidebar-link">
                        <span class="sidebar-link-icon">üìÖ</span>
                        R√©servations
                    </a>
                </li>
                <li class="sidebar-item">
                    <a href="/frontend/pages/admin/payments.html" class="sidebar-link">
                        <span class="sidebar-link-icon">üí≥</span>
                        Paiements
                    </a>
                </li>
                <li class="sidebar-item">
                    <a href="/frontend/pages/admin/users.html" class="sidebar-link">
                        <span class="sidebar-link-icon">üë•</span>
                        Utilisateurs
                    </a>
                </li>
                <li class="sidebar-item">
                    <a href="/frontend/pages/admin/system.html" class="sidebar-link">
                        <span class="sidebar-link-icon">‚öôÔ∏è</span>
                        √âtat du Syst√®me
                    </a>
                </li>
            </ul>
        </aside>
        
        <!-- Contenu Principal -->
        <main class="admin-content" style="margin-top: var(--header-height);">
            <!-- En-t√™te de Page -->
            <div class="page-header">
                <h1 class="page-title">üìä Tableau de Bord Admin</h1>
                <p class="page-subtitle">Aper√ßu du syst√®me et m√©triques en temps r√©el</p>
            </div>
            
            <!-- Stats en Temps R√©el -->
            <section class="stats-grid mb-6">
                <div class="stat-card">
                    <div class="stat-card-icon success">üü¢</div>
                    <div class="stat-card-value" id="available-spots">--</div>
                    <div class="stat-card-label">Places Disponibles</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-icon warning">üü°</div>
                    <div class="stat-card-value" id="reserved-spots">--</div>
                    <div class="stat-card-label">R√©serv√©es</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-icon danger">üî¥</div>
                    <div class="stat-card-value" id="occupied-spots">--</div>
                    <div class="stat-card-label">Occup√©es</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-icon primary">üìà</div>
                    <div class="stat-card-value" id="occupancy-rate">--%</div>
                    <div class="stat-card-label">Taux d'Occupation</div>
                </div>
            </section>
            
            <!-- M√©triques du Jour -->
            <section class="grid grid-cols-2 gap-6 mb-6" style="grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));">
                <div class="card">
                    <h3 class="card-title">Activit√© du Jour</h3>
                    <div class="stats-grid" style="grid-template-columns: 1fr 1fr;">
                        <div class="text-center p-4">
                            <div style="font-size: var(--font-size-3xl); font-weight: bold; color: var(--primary);" id="today-reservations">0</div>
                            <div class="text-muted">R√©servations</div>
                        </div>
                        <div class="text-center p-4">
                            <div style="font-size: var(--font-size-3xl); font-weight: bold; color: var(--success);" id="today-revenue">$0</div>
                            <div class="text-muted">Revenus</div>
                        </div>
                        <div class="text-center p-4">
                            <div style="font-size: var(--font-size-3xl); font-weight: bold; color: var(--info);" id="today-entries">0</div>
                            <div class="text-muted">Entr√©es</div>
                        </div>
                        <div class="text-center p-4">
                            <div style="font-size: var(--font-size-3xl); font-weight: bold; color: var(--warning);" id="today-exits">0</div>
                            <div class="text-muted">Sorties</div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <h3 class="card-title">√âtat du Syst√®me</h3>
                    <div class="mb-4">
                        <div class="flex justify-between mb-2">
                            <span>Serveur API</span>
                            <span class="status-badge success" id="api-status">‚óè En Ligne</span>
                        </div>
                        <div class="flex justify-between mb-2">
                            <span>Base de Donn√©es</span>
                            <span class="status-badge success" id="db-status">‚óè Connect√©</span>
                        </div>
                        <div class="flex justify-between mb-2">
                            <span>Contr√¥leurs de Portail</span>
                            <span class="status-badge success" id="gate-status">‚óè Actif</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Capteurs</span>
                            <span class="status-badge info" id="sensor-status">‚óè 24/24 En Ligne</span>
                        </div>
                    </div>
                    <a href="/frontend/pages/admin/system.html" class="btn btn-outline btn-sm btn-block">
                        Voir D√©tails
                    </a>
                </div>
            </section>
            
            <!-- Aper√ßu du Parking -->
            <section class="card mb-6">
                <div class="card-header">
                    <h3 class="card-title">Carte du Parking en Temps R√©el</h3>
                    <button class="btn btn-sm btn-outline" id="refresh-map">üîÑ Actualiser</button>
                </div>
                <div class="flex gap-6 mb-4" style="flex-wrap: wrap;">
                    <div class="flex items-center gap-2">
                        <span class="status-dot online"></span>
                        <span>Disponible</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="status-dot pending"></span>
                        <span>R√©serv√©</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="status-dot offline"></span>
                        <span>Occup√©</span>
                    </div>
                </div>
                <div class="parking-grid" id="parking-grid">
                    <!-- Skeleton de chargement -->
                    <div class="skeleton" style="height: 100px;"></div>
                    <div class="skeleton" style="height: 100px;"></div>
                    <div class="skeleton" style="height: 100px;"></div>
                    <div class="skeleton" style="height: 100px;"></div>
                </div>
            </section>
            
            <!-- R√©servations R√©centes -->
            <section class="card mb-6">
                <div class="card-header">
                    <h3 class="card-title">R√©servations R√©centes</h3>
                    <a href="/frontend/pages/admin/reservations.html" class="btn btn-sm btn-outline">Voir Tout</a>
                </div>
                <div class="table-container" style="box-shadow: none;">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Utilisateur</th>
                                <th>Place</th>
                                <th>D√©but</th>
                                <th>Fin</th>
                                <th>Statut</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="recent-reservations-body">
                            <tr>
                                <td colspan="6" class="text-center text-muted p-4">Chargement...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>
            
            <!-- Actions Rapides -->
            <section class="card">
                <h3 class="card-title mb-4">Actions Rapides</h3>
                <div class="grid grid-cols-4 gap-4" style="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));">
                    <a href="/frontend/pages/admin/parking.html" class="btn btn-primary btn-block">
                        ‚ûï Ajouter une Place
                    </a>
                    <button class="btn btn-secondary btn-block" id="open-gate-btn">
                        üöó Ouvrir Portail Entr√©e
                    </button>
                    <button class="btn btn-outline btn-block" id="export-report-btn">
                        üìä Exporter Rapport
                    </button>
                    <a href="/frontend/pages/admin/system.html" class="btn btn-outline btn-block">
                        ‚öôÔ∏è Param√®tres Syst√®me
                    </a>
                </div>
            </section>
        </main>
    </div>
    
    <!-- Conteneur Toast -->
    <div class="toast-container" id="toast-container"></div>
    
    <!-- Scripts -->
    <script src="../../js/services/api.js"></script>
    <script src="../../js/services/auth.js"></script>
    <script src="../../js/services/state.js"></script>
    <script src="../../js/services/notifications.js"></script>
    <script src="../../js/utils/helpers.js"></script>
    <script src="../../js/app.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <!-- Page Script -->
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // Check admin authentication
            const role = localStorage.getItem('aeropark_role');
            if (!localStorage.getItem('aeropark_token') || role !== 'admin') {
                NotificationService.error('Admin access required');
                window.location.href = '/frontend/pages/public/login.html';
                return;
            }
            
            // Load dashboard data
            await loadDashboardData();
            
            // Refresh button
            document.getElementById('refresh-map').addEventListener('click', loadDashboardData);
            
            // Quick actions
            document.getElementById('open-gate-btn').addEventListener('click', openGate);
            document.getElementById('export-report-btn').addEventListener('click', exportReport);
            
            // Sidebar toggle
            document.getElementById('sidebar-toggle').addEventListener('click', () => {
                document.getElementById('sidebar').classList.toggle('active');
            });
            
            // Logout
            document.getElementById('logout-btn').addEventListener('click', (e) => {
                e.preventDefault();
                localStorage.clear();
                window.location.href = '/frontend/pages/public/login.html';
            });
            
            // Auto-refresh every 30 seconds
            setInterval(loadDashboardData, 30000);
        });
        
        async function loadDashboardData() {
            try {
                // Load parking spots
                const spotsResponse = await ApiService.getParkingSpots();
                const spots = spotsResponse.places || spotsResponse || [];
                
                const available = spots.filter(s => s.status === 'free').length;
                const reserved = spots.filter(s => s.status === 'reserved').length;
                const occupied = spots.filter(s => s.status === 'occupied').length;
                const occupancyRate = spots.length > 0 ? Math.round(((reserved + occupied) / spots.length) * 100) : 0;
                
                document.getElementById('available-spots').textContent = available;
                document.getElementById('reserved-spots').textContent = reserved;
                document.getElementById('occupied-spots').textContent = occupied;
                document.getElementById('occupancy-rate').textContent = occupancyRate + '%';
                
                // Render parking grid
                renderParkingGrid(spots);
                
                // Load reservations
                try {
                    const reservationsResponse = await ApiService.getAllReservations({ limit: 10 });
                    const reservations = reservationsResponse.reservations || reservationsResponse || [];
                    renderRecentReservations(reservations);
                    
                    // Today's stats
                    const today = new Date().toDateString();
                    const todayReservations = reservations.filter(r => 
                        new Date(r.created_at || r.start_time).toDateString() === today
                    );
                    document.getElementById('today-reservations').textContent = todayReservations.length;
                } catch (e) {
                    console.log('√âchec du chargement des r√©servations:', e);
                    document.getElementById('today-reservations').textContent = '0';
                    renderRecentReservations([]);
                }
                
                // Check system health
                checkSystemHealth();
                
            } catch (error) {
                console.error('√âchec du chargement du tableau de bord:', error);
                NotificationService.error('Erreur lors du chargement des donn√©es: ' + error.message);
                
                // Reset stats to show error state
                document.getElementById('available-spots').textContent = '--';
                document.getElementById('reserved-spots').textContent = '--';
                document.getElementById('occupied-spots').textContent = '--';
                document.getElementById('occupancy-rate').textContent = '--%';
                renderParkingGrid([]);
            }
        }
        
        function renderParkingGrid(spots) {
            const grid = document.getElementById('parking-grid');
            
            grid.innerHTML = spots.map(spot => `
                <div class="parking-spot ${spot.status}" 
                     data-spot-id="${spot.id}"
                     onclick="showSpotDetails('${spot.id}', '${spot.status}')"
                     style="cursor: pointer;">
                    <span class="parking-spot-id">${spot.id}</span>
                    <span class="parking-spot-status">
                        ${Helpers.getParkingStatusIcon(spot.status)} ${Helpers.getParkingStatusText(spot.status)}
                    </span>
                </div>
            `).join('');
        }
        
        function renderRecentReservations(reservations) {
            const tbody = document.getElementById('recent-reservations-body');
            
            if (!reservations || reservations.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-muted p-4">No recent reservations</td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = reservations.slice(0, 5).map(r => `
                <tr>
                    <td>${r.user_email || r.user_id || 'N/A'}</td>
                    <td><strong>${r.spot_id}</strong></td>
                    <td>${Helpers.formatDateTime(r.start_time)}</td>
                    <td>${Helpers.formatDateTime(r.end_time)}</td>
                    <td>
                        <span class="status-badge ${Helpers.getStatusBadgeClass(r.status)}">
                            ${r.status}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline" onclick="viewReservation('${r.id}')">
                            View
                        </button>
                    </td>
                </tr>
            `).join('');
        }
        
        async function checkSystemHealth() {
            try {
                const health = await ApiService.healthCheck();
                document.getElementById('api-status').innerHTML = '‚óè Online';
                document.getElementById('api-status').className = 'status-badge success';
            } catch (error) {
                document.getElementById('api-status').innerHTML = '‚óè Offline';
                document.getElementById('api-status').className = 'status-badge danger';
            }
        }
        
        function showSpotDetails(spotId, status) {
            NotificationService.info(`Spot ${spotId} is currently ${status}`, 'Spot Details');
        }
        
        function viewReservation(reservationId) {
            window.location.href = `/frontend/pages/admin/reservations.html?id=${reservationId}`;
        }
        
        async function openGate() {
            if (!confirm('Open the entry gate manually?')) return;
            
            try {
                // Simulate gate opening
                NotificationService.success('Entry gate opened', 'Gate Control');
            } catch (error) {
                NotificationService.error('Failed to open gate');
            }
        }
        
        async function exportReport() {
            NotificationService.info('Generating report...', 'Export');
            
            // Simulate report generation
            setTimeout(() => {
                NotificationService.success('Report downloaded successfully');
            }, 2000);
        }
    </script>
</body>
</html>

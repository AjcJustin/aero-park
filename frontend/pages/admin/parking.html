<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="AeroPark Admin - Parking Spot Management">
    <meta name="theme-color" content="#1e3a5f">
    
    <title>Parking Management - AeroPark Admin</title>
    
    <link rel="icon" type="image/png" href="../../assets/icons/favicon-32x32.png">
    <link rel="manifest" href="../../manifest.json">
    <link rel="stylesheet" href="../../css/styles.css">
</head>
<body class="role-admin">
    <!-- Offline Banner -->
    <div class="offline-banner" id="offline-banner">
        ‚ö†Ô∏è You are currently offline.
    </div>
    
    <!-- Header -->
    <header class="header">
        <div class="header-container">
            <a href="/frontend/index.html" class="logo">
                <svg class="logo-icon" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="20" cy="20" r="18" stroke="currentColor" stroke-width="2" fill="none"/>
                    <path d="M20 8 L20 32 M12 16 L28 16 M14 24 L26 24" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    <circle cx="20" cy="20" r="4" fill="currentColor"/>
                </svg>
                <span>AeroPark <span style="font-weight: 400; opacity: 0.8;">Admin</span></span>
            </a>
            
            <button class="nav-toggle sidebar-toggle" id="sidebar-toggle" aria-label="Toggle sidebar">‚ò∞</button>
            
            <nav>
                <ul class="nav-menu">
                    <li><a href="/frontend/index.html" class="nav-link">üè† Public Site</a></li>
                    <li><a href="#" class="nav-link" id="logout-btn">üö™ Logout</a></li>
                </ul>
            </nav>
        </div>
    </header>
    
    <!-- Admin Layout -->
    <div class="admin-layout">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <ul class="sidebar-menu">
                <li class="sidebar-item">
                    <a href="/frontend/pages/admin/dashboard.html" class="sidebar-link">
                        <span class="sidebar-link-icon">üìä</span>
                        Dashboard
                    </a>
                </li>
                <li class="sidebar-item">
                    <a href="/frontend/pages/admin/parking.html" class="sidebar-link active">
                        <span class="sidebar-link-icon">üÖøÔ∏è</span>
                        Parking Management
                    </a>
                </li>
                <li class="sidebar-item">
                    <a href="/frontend/pages/admin/reservations.html" class="sidebar-link">
                        <span class="sidebar-link-icon">üìÖ</span>
                        Reservations
                    </a>
                </li>
                <li class="sidebar-item">
                    <a href="/frontend/pages/admin/payments.html" class="sidebar-link">
                        <span class="sidebar-link-icon">üí≥</span>
                        Payments
                    </a>
                </li>
                <li class="sidebar-item">
                    <a href="/frontend/pages/admin/users.html" class="sidebar-link">
                        <span class="sidebar-link-icon">üë•</span>
                        Users
                    </a>
                </li>
                <li class="sidebar-item">
                    <a href="/frontend/pages/admin/system.html" class="sidebar-link">
                        <span class="sidebar-link-icon">‚öôÔ∏è</span>
                        System Status
                    </a>
                </li>
            </ul>
        </aside>
        
        <!-- Main Content -->
        <main class="admin-content" style="margin-top: var(--header-height);">
            <!-- Page Header -->
            <div class="page-header flex justify-between items-center" style="flex-wrap: wrap; gap: var(--spacing-4);">
                <div>
                    <h1 class="page-title">üÖøÔ∏è Parking Management</h1>
                    <p class="page-subtitle">Manage parking spots and their status</p>
                </div>
                <button class="btn btn-primary" id="add-spot-btn">
                    ‚ûï Add New Spot
                </button>
            </div>
            
            <!-- Stats -->
            <section class="stats-grid mb-6">
                <div class="stat-card">
                    <div class="stat-card-icon primary">üÖøÔ∏è</div>
                    <div class="stat-card-value" id="total-spots">--</div>
                    <div class="stat-card-label">Total Spots</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-icon success">üü¢</div>
                    <div class="stat-card-value" id="available-count">--</div>
                    <div class="stat-card-label">Available</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-icon warning">üü°</div>
                    <div class="stat-card-value" id="reserved-count">--</div>
                    <div class="stat-card-label">Reserved</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-icon danger">üî¥</div>
                    <div class="stat-card-value" id="occupied-count">--</div>
                    <div class="stat-card-label">Occupied</div>
                </div>
            </section>
            
            <!-- Filters -->
            <section class="card mb-6">
                <div class="flex gap-4" style="flex-wrap: wrap; align-items: flex-end;">
                    <div class="form-group mb-0" style="flex: 1; min-width: 150px;">
                        <label class="form-label">Filter by Status</label>
                        <select class="form-select" id="filter-status">
                            <option value="">All Spots</option>
                            <option value="free">Available</option>
                            <option value="reserved">Reserved</option>
                            <option value="occupied">Occupied</option>
                        </select>
                    </div>
                    <div class="form-group mb-0" style="flex: 1; min-width: 150px;">
                        <label class="form-label">Filter by Zone</label>
                        <select class="form-select" id="filter-zone">
                            <option value="">All Zones</option>
                            <option value="A">Zone A</option>
                            <option value="B">Zone B</option>
                            <option value="C">Zone C</option>
                        </select>
                    </div>
                    <div class="form-group mb-0" style="flex: 2; min-width: 200px;">
                        <label class="form-label">Search</label>
                        <input type="text" class="form-input" id="search-spots" placeholder="Search by spot ID...">
                    </div>
                    <button class="btn btn-outline" id="refresh-btn">üîÑ Refresh</button>
                </div>
            </section>
            
            <!-- Parking Grid -->
            <section class="card mb-6">
                <div class="card-header">
                    <h2 class="card-title">Parking Spots</h2>
                    <div class="flex gap-4">
                        <button class="btn btn-sm btn-outline view-btn active" data-view="grid">Grid View</button>
                        <button class="btn btn-sm btn-outline view-btn" data-view="table">Table View</button>
                    </div>
                </div>
                
                <!-- Grid View -->
                <div id="grid-view">
                    <div class="parking-grid" id="parking-grid">
                        <div class="skeleton" style="height: 100px;"></div>
                        <div class="skeleton" style="height: 100px;"></div>
                        <div class="skeleton" style="height: 100px;"></div>
                        <div class="skeleton" style="height: 100px;"></div>
                    </div>
                </div>
                
                <!-- Table View -->
                <div id="table-view" style="display: none;">
                    <div class="table-container" style="box-shadow: none;">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Spot ID</th>
                                    <th>Zone</th>
                                    <th>Type</th>
                                    <th>Status</th>
                                    <th>Current User</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="spots-table-body">
                                <tr>
                                    <td colspan="6" class="text-center text-muted p-4">Loading...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
            
            <!-- Bulk Actions -->
            <section class="card">
                <h3 class="card-title mb-4">Bulk Actions</h3>
                <div class="grid grid-cols-3 gap-4" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                    <button class="btn btn-outline btn-block" id="reset-all-btn">
                        üîÑ Reset All to Available
                    </button>
                    <button class="btn btn-outline btn-block" id="disable-zone-btn">
                        üö´ Disable Zone
                    </button>
                    <button class="btn btn-outline btn-block" id="export-spots-btn">
                        üìä Export Spots Data
                    </button>
                </div>
            </section>
        </main>
    </div>
    
    <!-- Add/Edit Spot Modal -->
    <div class="modal-backdrop" id="spot-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-title">Add Parking Spot</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="spot-form">
                    <input type="hidden" id="edit-spot-id">
                    <div class="form-group">
                        <label class="form-label">Spot ID</label>
                        <input type="text" class="form-input" id="spot-id" placeholder="e.g., A-01" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Zone</label>
                        <select class="form-select" id="spot-zone">
                            <option value="A">Zone A - Regular</option>
                            <option value="B">Zone B - Premium</option>
                            <option value="C">Zone C - VIP</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Spot Type</label>
                        <select class="form-select" id="spot-type">
                            <option value="standard">Standard</option>
                            <option value="compact">Compact</option>
                            <option value="large">Large Vehicle</option>
                            <option value="handicapped">Handicapped</option>
                            <option value="electric">Electric Vehicle</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select class="form-select" id="spot-status">
                            <option value="free">Available</option>
                            <option value="reserved">Reserved</option>
                            <option value="occupied">Occupied</option>
                            <option value="maintenance">Under Maintenance</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Hourly Rate ($)</label>
                        <input type="number" class="form-input" id="spot-rate" value="5" min="1" step="0.5">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal()">Cancel</button>
                <button class="btn btn-primary" id="save-spot-btn">Save Spot</button>
            </div>
        </div>
    </div>
    
    <!-- Scripts -->
    <script src="../../js/services/api.js"></script>
    <script src="../../js/services/auth.js"></script>
    <script src="../../js/services/state.js"></script>
    <script src="../../js/services/notifications.js"></script>
    <script src="../../js/utils/helpers.js"></script>
    <script src="../../js/app.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <!-- Page Script -->
    <script>
        let allSpots = [];
        
        document.addEventListener('DOMContentLoaded', async () => {
            // Check admin
            if (localStorage.getItem('aeropark_role') !== 'admin') {
                window.location.href = '/frontend/pages/public/login.html';
                return;
            }
            
            // Load spots
            await loadSpots();
            
            // Event listeners
            document.getElementById('add-spot-btn').addEventListener('click', () => openModal());
            document.getElementById('save-spot-btn').addEventListener('click', saveSpot);
            document.getElementById('refresh-btn').addEventListener('click', loadSpots);
            
            document.getElementById('filter-status').addEventListener('change', filterSpots);
            document.getElementById('filter-zone').addEventListener('change', filterSpots);
            document.getElementById('search-spots').addEventListener('input', Helpers.debounce(filterSpots, 300));
            
            // View toggle
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.addEventListener('click', () => toggleView(btn.dataset.view));
            });
            
            // Bulk actions
            document.getElementById('reset-all-btn').addEventListener('click', resetAllSpots);
            document.getElementById('export-spots-btn').addEventListener('click', exportSpots);
            
            // Sidebar toggle
            document.getElementById('sidebar-toggle').addEventListener('click', () => {
                document.getElementById('sidebar').classList.toggle('active');
            });
            
            // Logout
            document.getElementById('logout-btn').addEventListener('click', (e) => {
                e.preventDefault();
                localStorage.clear();
                window.location.href = '/frontend/pages/public/login.html';
            });
        });
        
        async function loadSpots() {
            try {
                allSpots = await ApiService.getParkingSpots();
                updateStats(allSpots);
                renderSpots(allSpots);
            } catch (error) {
                NotificationService.error('Failed to load parking spots');
            }
        }
        
        function updateStats(spots) {
            const available = spots.filter(s => s.status === 'free').length;
            const reserved = spots.filter(s => s.status === 'reserved').length;
            const occupied = spots.filter(s => s.status === 'occupied').length;
            
            document.getElementById('total-spots').textContent = spots.length;
            document.getElementById('available-count').textContent = available;
            document.getElementById('reserved-count').textContent = reserved;
            document.getElementById('occupied-count').textContent = occupied;
        }
        
        function renderSpots(spots) {
            renderGridView(spots);
            renderTableView(spots);
        }
        
        function renderGridView(spots) {
            const grid = document.getElementById('parking-grid');
            
            if (spots.length === 0) {
                grid.innerHTML = '<p class="text-center text-muted p-4">No spots found</p>';
                return;
            }
            
            grid.innerHTML = spots.map(spot => `
                <div class="parking-spot ${spot.status}" 
                     onclick="openModal('${spot.id}')"
                     style="cursor: pointer;">
                    <span class="parking-spot-id">${spot.id}</span>
                    <span class="parking-spot-status">
                        ${Helpers.getParkingStatusIcon(spot.status)} ${Helpers.getParkingStatusText(spot.status)}
                    </span>
                </div>
            `).join('');
        }
        
        function renderTableView(spots) {
            const tbody = document.getElementById('spots-table-body');
            
            if (spots.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted p-4">No spots found</td></tr>';
                return;
            }
            
            tbody.innerHTML = spots.map(spot => `
                <tr>
                    <td><strong>${spot.id}</strong></td>
                    <td>${spot.zone || spot.id.split('-')[0]}</td>
                    <td>${spot.type || 'Standard'}</td>
                    <td>
                        <span class="status-badge ${Helpers.getStatusBadgeClass(spot.status)}">
                            ${Helpers.getParkingStatusIcon(spot.status)} ${spot.status}
                        </span>
                    </td>
                    <td>${spot.current_user || '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-outline" onclick="openModal('${spot.id}')">Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteSpot('${spot.id}')">Delete</button>
                    </td>
                </tr>
            `).join('');
        }
        
        function toggleView(view) {
            document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`.view-btn[data-view="${view}"]`).classList.add('active');
            
            document.getElementById('grid-view').style.display = view === 'grid' ? 'block' : 'none';
            document.getElementById('table-view').style.display = view === 'table' ? 'block' : 'none';
        }
        
        function filterSpots() {
            const status = document.getElementById('filter-status').value;
            const zone = document.getElementById('filter-zone').value;
            const search = document.getElementById('search-spots').value.toLowerCase();
            
            let filtered = [...allSpots];
            
            if (status) {
                filtered = filtered.filter(s => s.status === status);
            }
            
            if (zone) {
                filtered = filtered.filter(s => (s.zone || s.id.split('-')[0]) === zone);
            }
            
            if (search) {
                filtered = filtered.filter(s => s.id.toLowerCase().includes(search));
            }
            
            renderSpots(filtered);
        }
        
        function openModal(spotId = null) {
            const modal = document.getElementById('spot-modal');
            const title = document.getElementById('modal-title');
            
            if (spotId) {
                title.textContent = 'Edit Parking Spot';
                const spot = allSpots.find(s => s.id === spotId);
                if (spot) {
                    document.getElementById('edit-spot-id').value = spot.id;
                    document.getElementById('spot-id').value = spot.id;
                    document.getElementById('spot-id').disabled = true;
                    document.getElementById('spot-zone').value = spot.zone || spot.id.split('-')[0];
                    document.getElementById('spot-type').value = spot.type || 'standard';
                    document.getElementById('spot-status').value = spot.status;
                    document.getElementById('spot-rate').value = spot.rate || 5;
                }
            } else {
                title.textContent = 'Add Parking Spot';
                document.getElementById('spot-form').reset();
                document.getElementById('edit-spot-id').value = '';
                document.getElementById('spot-id').disabled = false;
            }
            
            modal.classList.add('active');
        }
        
        function closeModal() {
            document.getElementById('spot-modal').classList.remove('active');
        }
        
        async function saveSpot() {
            const editId = document.getElementById('edit-spot-id').value;
            const spotData = {
                id: document.getElementById('spot-id').value,
                zone: document.getElementById('spot-zone').value,
                type: document.getElementById('spot-type').value,
                status: document.getElementById('spot-status').value,
                rate: parseFloat(document.getElementById('spot-rate').value)
            };
            
            if (!spotData.id) {
                NotificationService.error('Spot ID is required');
                return;
            }
            
            try {
                if (editId) {
                    await ApiService.updateParkingSpot(editId, spotData);
                    NotificationService.success('Parking spot updated');
                } else {
                    await ApiService.createParkingSpot(spotData);
                    NotificationService.success('Parking spot created');
                }
                
                closeModal();
                await loadSpots();
            } catch (error) {
                NotificationService.error(error.message || 'Failed to save spot');
            }
        }
        
        async function deleteSpot(spotId) {
            if (!confirm(`Delete parking spot ${spotId}?`)) return;
            
            try {
                await ApiService.deleteParkingSpot(spotId);
                NotificationService.success('Parking spot deleted');
                await loadSpots();
            } catch (error) {
                NotificationService.error(error.message || 'Failed to delete spot');
            }
        }
        
        async function resetAllSpots() {
            if (!confirm('Reset ALL spots to Available status?')) return;
            
            try {
                NotificationService.info('Resetting all spots...');
                // This would call a bulk update API
                NotificationService.success('All spots reset to Available');
                await loadSpots();
            } catch (error) {
                NotificationService.error('Failed to reset spots');
            }
        }
        
        function exportSpots() {
            const csv = [
                ['Spot ID', 'Zone', 'Type', 'Status', 'Rate'].join(','),
                ...allSpots.map(s => [
                    s.id,
                    s.zone || s.id.split('-')[0],
                    s.type || 'Standard',
                    s.status,
                    s.rate || 5
                ].join(','))
            ].join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'parking-spots.csv';
            a.click();
            
            NotificationService.success('Export complete');
        }
    </script>
</body>
</html>

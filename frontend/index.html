<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <meta name="description" content="AeroPark GOMA - Syst√®me de Gestion de Parking A√©roportuaire Intelligent. R√©servez vos places, g√©n√©rez des codes d'acc√®s et g√©rez vos paiements facilement.">
    <meta name="theme-color" content="#1e3a5f">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="AeroPark">
    
    <title>AeroPark GOMA - Parking A√©roportuaire Intelligent</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="assets/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="assets/icons/favicon-16x16.png">
    <link rel="apple-touch-icon" href="assets/icons/apple-touch-icon.png">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="css/styles.css">
    
    <!-- Preconnect for performance -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="dns-prefetch" href="//localhost:8000">
</head>
<body>
    <!-- Banni√®re Hors Ligne -->
    <div class="offline-banner" id="offline-banner">
        ‚ö†Ô∏è Vous √™tes actuellement hors ligne. Certaines fonctionnalit√©s peuvent √™tre limit√©es.
    </div>
    
    <!-- En-t√™te -->
    <header class="header">
        <div class="header-container">
            <a href="/frontend/index.html" class="logo">
                <svg class="logo-icon" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="20" cy="20" r="18" stroke="currentColor" stroke-width="2" fill="none"/>
                    <path d="M12 24 L20 8 L28 24 M15 20 L25 20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <circle cx="20" cy="28" r="3" fill="currentColor"/>
                </svg>
                <span>AeroPark <span style="font-weight: 400; opacity: 0.8;">GOMA</span></span>
            </a>
            
            <button class="nav-toggle" id="nav-toggle" aria-label="Menu de navigation" aria-expanded="false">
                <span id="nav-toggle-icon">‚ò∞</span>
            </button>
            
            <nav>
                <ul class="nav-menu" id="nav-menu">
                    <li><a href="index.html" class="nav-link active">üè† Accueil</a></li>
                    
                    <!-- Liens Visiteurs -->
                    <li class="guest-only"><a href="pages/public/login.html" class="nav-link">üîê Connexion</a></li>
                    <li class="guest-only"><a href="pages/public/register.html" class="nav-link btn btn-secondary btn-sm">üìù Inscription</a></li>
                    
                    <!-- Liens Utilisateurs Connect√©s -->
                    <li class="auth-only"><a href="/frontend/pages/user/dashboard.html" class="nav-link">üìä Tableau de bord</a></li>
                    <li class="auth-only"><a href="/frontend/pages/user/reservations.html" class="nav-link">üìÖ Mes R√©servations</a></li>
                    
                    <!-- Liens Admin -->
                    <li class="admin-only"><a href="/frontend/pages/admin/dashboard.html" class="nav-link">‚öôÔ∏è Administration</a></li>
                    
                    <!-- D√©connexion -->
                    <li class="auth-only">
                        <a href="#" class="nav-link" id="logout-btn">üö™ D√©connexion</a>
                    </li>
                </ul>
            </nav>
        </div>
    </header>
    
    <!-- Contenu Principal -->
    <main class="main-content">
        <div class="container">
            <!-- Section Hero -->
            <section class="hero" style="text-align: center; padding: var(--spacing-12) 0;">
                <div class="airplane-icon" style="font-size: 4rem; margin-bottom: var(--spacing-4);">‚úàÔ∏è</div>
                <h1 style="font-size: 3rem; margin-bottom: var(--spacing-4);">
                    Parking A√©roportuaire Intelligent
                </h1>
                <p style="font-size: 1.25rem; max-width: 600px; margin: 0 auto var(--spacing-8);">
                    R√©servez votre place de parking √† l'avance, g√©n√©rez des codes d'acc√®s uniques et profitez d'un stationnement sans stress √† l'A√©roport de GOMA.
                </p>
                <div class="flex justify-center gap-4" style="flex-wrap: wrap;">
                    <a href="/frontend/pages/public/register.html" class="btn btn-primary btn-lg guest-only">üöÄ Commencer</a>
                    <a href="/frontend/pages/user/reservations.html" class="btn btn-primary btn-lg auth-only">üìÖ R√©server Maintenant</a>
                    <a href="#parking-status" class="btn btn-outline btn-lg">üìç Voir Disponibilit√©</a>
                </div>
            </section>
            
            <!-- Section Statistiques -->
            <section class="stats-section" style="margin-bottom: var(--spacing-12);">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-card-icon success">üü¢</div>
                        <div class="stat-card-value" id="available-count">--</div>
                        <div class="stat-card-label">Places Disponibles</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-icon warning">üü°</div>
                        <div class="stat-card-value" id="reserved-count">--</div>
                        <div class="stat-card-label">R√©serv√©es</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-icon danger">üî¥</div>
                        <div class="stat-card-value" id="occupied-count">--</div>
                        <div class="stat-card-label">Occup√©es</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-icon primary">üÖøÔ∏è</div>
                        <div class="stat-card-value" id="total-count">--</div>
                        <div class="stat-card-label">Capacit√© Totale</div>
                    </div>
                </div>
            </section>
            
            <!-- Section Grille Parking -->
            <section id="parking-status" class="parking-section" style="margin-bottom: var(--spacing-12);">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">üÖøÔ∏è √âtat du Parking en Temps R√©el</h2>
                        <button class="btn btn-sm btn-outline" id="refresh-parking">
                            üîÑ Actualiser
                        </button>
                    </div>
                    <div class="card-body">
                        <!-- L√©gende -->
                        <div class="flex gap-6 mb-6" style="flex-wrap: wrap;">
                            <div class="flex items-center gap-2">
                                <span class="status-dot online"></span>
                                <span>Disponible</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="status-dot pending"></span>
                                <span>R√©serv√©e</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="status-dot offline"></span>
                                <span>Occup√©e</span>
                            </div>
                        </div>
                        
                        <!-- Grille Parking -->
                        <div class="parking-grid" id="parking-grid">
                            <!-- Skeleton de chargement -->
                            <div class="skeleton" style="height: 120px;"></div>
                            <div class="skeleton" style="height: 120px;"></div>
                            <div class="skeleton" style="height: 120px;"></div>
                            <div class="skeleton" style="height: 120px;"></div>
                            <div class="skeleton" style="height: 120px;"></div>
                            <div class="skeleton" style="height: 120px;"></div>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Section Fonctionnalit√©s -->
            <section class="features-section" style="margin-bottom: var(--spacing-12);">
                <h2 class="text-center" style="margin-bottom: var(--spacing-8);">‚ú® Pourquoi Choisir AeroPark ?</h2>
                <div class="grid grid-cols-3" style="gap: var(--spacing-6);">
                    <div class="feature-card">
                        <div class="feature-card-icon">üì±</div>
                        <h3>Application Mobile</h3>
                        <p>Acc√©dez depuis n'importe quel appareil. Installez l'application pour un acc√®s rapide.</p>
                    </div>
                    <div class="feature-card">
                        <div class="feature-card-icon">üîê</div>
                        <h3>Acc√®s S√©curis√©</h3>
                        <p>Codes d'acc√®s uniques pour l'entr√©e et la sortie. Plus besoin de tickets physiques.</p>
                    </div>
                    <div class="feature-card">
                        <div class="feature-card-icon">üí≥</div>
                        <h3>Paiement Facile</h3>
                        <p>Orange Money, Airtel Money, M-Pesa. Payez en ligne avant de partir.</p>
                    </div>
                </div>
            </section>
            
            <!-- Banni√®re Installation PWA -->
            <section class="install-banner card" id="install-section" style="display: none; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white;">
                <div class="flex items-center justify-between" style="flex-wrap: wrap; gap: var(--spacing-4);">
                    <div>
                        <h3 style="color: white; margin-bottom: var(--spacing-2);">üì≤ Installer l'Application AeroPark</h3>
                        <p style="color: rgba(255,255,255,0.8); margin: 0;">Acc√®s rapide depuis votre √©cran d'accueil</p>
                    </div>
                    <button class="btn btn-secondary" id="install-btn">Installer</button>
                </div>
            </section>
        </div>
    </main>
    
    <!-- Pied de Page -->
    <footer class="footer">
        <div class="container text-center">
            <div class="footer-logo" style="justify-content: center;">
                <svg viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="20" cy="20" r="18" stroke="currentColor" stroke-width="2" fill="none"/>
                    <path d="M12 24 L20 8 L28 24 M15 20 L25 20" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
                <span>AeroPark GOMA</span>
            </div>
            <p style="margin-bottom: var(--spacing-4);">
                &copy; 2024 AeroPark GOMA. Syst√®me de Gestion de Parking A√©roportuaire Intelligent.
            </p>
            <p style="font-size: var(--font-size-sm);">
                <a href="#">Politique de Confidentialit√©</a> &bull; 
                <a href="#">Conditions d'Utilisation</a> &bull; 
                <a href="#">Nous Contacter</a>
            </p>
        </div>
    </footer>
    
    <!-- Modal de R√©servation -->
    <div class="modal-backdrop" id="reservation-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">üìÖ R√©server une Place</h3>
                <button class="modal-close" id="close-modal" aria-label="Fermer">&times;</button>
            </div>
            <div class="modal-body">
                <form id="reservation-form">
                    <div class="form-group">
                        <label class="form-label">Place de Parking</label>
                        <input type="text" class="form-input" id="modal-spot-id" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Date et Heure de D√©but</label>
                        <input type="datetime-local" class="form-input" id="start-time" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Date et Heure de Fin</label>
                        <input type="datetime-local" class="form-input" id="end-time" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Num√©ro de Plaque</label>
                        <input type="text" class="form-input" id="vehicle-plate" placeholder="ex: ABC-1234" required>
                    </div>
                    <div class="card" style="background: var(--gray-50); margin-top: var(--spacing-4);">
                        <div class="flex justify-between">
                            <span>Co√ªt Estim√©:</span>
                            <strong id="estimated-cost">$0.00</strong>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancel-reservation" type="button">Annuler</button>
                <button class="btn btn-primary" id="confirm-reservation" type="button">‚úÖ Confirmer</button>
            </div>
        </div>
    </div>
    
    <!-- Conteneur Toast -->
    <div class="toast-container" id="toast-container"></div>
    
    <!-- Scripts -->
    <script src="js/services/api.js"></script>
    <script src="js/services/auth.js"></script>
    <script src="js/services/state.js"></script>
    <script src="js/services/notifications.js"></script>
    <script src="js/utils/helpers.js"></script>
    <script src="js/app.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <!-- Script de la Page -->
    <script>
        // Traductions fran√ßaises
        const STATUS_FR = {
            free: 'Disponible',
            reserved: 'R√©serv√©e',
            occupied: 'Occup√©e'
        };
        
        const STATUS_ICONS = {
            free: 'üü¢',
            reserved: 'üü°',
            occupied: 'üî¥'
        };
        
        document.addEventListener('DOMContentLoaded', async () => {
            // Initialiser le menu hamburger
            initHamburgerMenu();
            
            // Charger les donn√©es du parking
            await loadParkingData();
            
            // Bouton actualiser
            const refreshBtn = document.getElementById('refresh-parking');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', loadParkingData);
            }
            
            // Gestionnaires de modal
            setupModalHandlers();
            
            // Calculer le co√ªt lors du changement de date
            const startTimeInput = document.getElementById('start-time');
            const endTimeInput = document.getElementById('end-time');
            if (startTimeInput) startTimeInput.addEventListener('change', calculateEstimatedCost);
            if (endTimeInput) endTimeInput.addEventListener('change', calculateEstimatedCost);
            
            // Bouton de d√©connexion
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    localStorage.clear();
                    showToast('D√©connexion r√©ussie', '√Ä bient√¥t !', 'success');
                    setTimeout(() => {
                        window.location.href = '/frontend/pages/public/login.html';
                    }, 1000);
                });
            }
        });
        
        // Initialiser le menu hamburger
        function initHamburgerMenu() {
            const navToggle = document.getElementById('nav-toggle');
            const navMenu = document.getElementById('nav-menu');
            const navToggleIcon = document.getElementById('nav-toggle-icon');
            
            if (navToggle && navMenu) {
                navToggle.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const isActive = navMenu.classList.toggle('active');
                    navToggle.classList.toggle('active', isActive);
                    navToggle.setAttribute('aria-expanded', isActive);
                    if (navToggleIcon) navToggleIcon.textContent = isActive ? '‚úï' : '‚ò∞';
                });
                
                // Fermer le menu en cliquant ailleurs
                document.addEventListener('click', (e) => {
                    if (!navMenu.contains(e.target) && !navToggle.contains(e.target)) {
                        navMenu.classList.remove('active');
                        navToggle.classList.remove('active');
                        navToggle.setAttribute('aria-expanded', 'false');
                        if (navToggleIcon) navToggleIcon.textContent = '‚ò∞';
                    }
                });
                
                // Fermer le menu lors du clic sur un lien
                navMenu.querySelectorAll('.nav-link').forEach(link => {
                    link.addEventListener('click', () => {
                        navMenu.classList.remove('active');
                        navToggle.classList.remove('active');
                        if (navToggleIcon) navToggleIcon.textContent = '‚ò∞';
                    });
                });
            }
        }
        
        async function loadParkingData() {
            const grid = document.getElementById('parking-grid');
            
            try {
                const response = await ApiService.getParkingStatus();
                const spots = response.places || response.spots || [];
                
                // Normaliser le format des places
                const normalizedSpots = spots.map(spot => ({
                    id: spot.id || spot.place_id,
                    status: spot.etat || spot.status || 'free'
                }));
                
                updateStats(normalizedSpots);
                if (typeof StateService !== 'undefined') {
                    StateService.cacheParkingSpots(normalizedSpots);
                }
                renderParkingGrid(normalizedSpots);
            } catch (error) {
                console.error('Erreur de chargement:', error);
                
                // Essayer les donn√©es en cache
                if (typeof StateService !== 'undefined') {
                    const cached = StateService.getCachedParkingSpots();
                    if (cached && cached.spots && cached.spots.length > 0) {
                        updateStats(cached.spots);
                        renderParkingGrid(cached.spots);
                        showToast('Mode hors ligne', 'Affichage des donn√©es en cache.', 'warning');
                    } else {
                        showNoDataMessage();
                    }
                } else {
                    showNoDataMessage();
                }
            }
        }
        
        function showNoDataMessage() {
            const grid = document.getElementById('parking-grid');
            grid.innerHTML = `
                <div class="text-center p-6" style="grid-column: 1 / -1;">
                    <p class="text-muted">Impossible de charger les donn√©es du parking. V√©rifiez votre connexion.</p>
                    <button class="btn btn-primary mt-4" onclick="loadParkingData()">R√©essayer</button>
                </div>
            `;
            document.getElementById('available-count').textContent = '--';
            document.getElementById('reserved-count').textContent = '--';
            document.getElementById('occupied-count').textContent = '--';
            document.getElementById('total-count').textContent = '--';
        }
        
        function updateStats(spots) {
            const available = spots.filter(s => s.status === 'free').length;
            const reserved = spots.filter(s => s.status === 'reserved').length;
            const occupied = spots.filter(s => s.status === 'occupied').length;
            
            document.getElementById('available-count').textContent = available;
            document.getElementById('reserved-count').textContent = reserved;
            document.getElementById('occupied-count').textContent = occupied;
            document.getElementById('total-count').textContent = spots.length;
        }
        
        function renderParkingGrid(spots) {
            const grid = document.getElementById('parking-grid');
            const isAuthenticated = localStorage.getItem('aeropark_token');
            
            grid.innerHTML = spots.map(spot => `
                <div class="parking-spot ${spot.status}" 
                     data-spot-id="${spot.id}" 
                     data-status="${spot.status}"
                     ${spot.status === 'free' ? 'onclick="openReservationModal(\'' + spot.id + '\')"' : ''}
                     role="button"
                     tabindex="0"
                     aria-label="Place ${spot.id} - ${STATUS_FR[spot.status]}">
                    <span class="parking-spot-id">${spot.id}</span>
                    <span class="parking-spot-status">${STATUS_ICONS[spot.status]} ${STATUS_FR[spot.status]}</span>
                </div>
            `).join('');
        }
        
        function setupModalHandlers() {
            const modal = document.getElementById('reservation-modal');
            const closeBtn = document.getElementById('close-modal');
            const cancelBtn = document.getElementById('cancel-reservation');
            const confirmBtn = document.getElementById('confirm-reservation');
            
            if (closeBtn) closeBtn.addEventListener('click', closeModal);
            if (cancelBtn) cancelBtn.addEventListener('click', closeModal);
            if (modal) {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) closeModal();
                });
            }
            
            if (confirmBtn) confirmBtn.addEventListener('click', submitReservation);
        }
        
        function openReservationModal(spotId) {
            const isAuthenticated = localStorage.getItem('aeropark_token');
            
            if (!isAuthenticated) {
                showToast('Connexion Requise', 'Veuillez vous connecter pour r√©server.', 'warning');
                setTimeout(() => {
                    window.location.href = '/frontend/pages/public/login.html';
                }, 1500);
                return;
            }
            
            document.getElementById('modal-spot-id').value = spotId;
            
            // D√©finir les heures par d√©faut
            const now = new Date();
            now.setMinutes(0, 0, 0);
            now.setHours(now.getHours() + 1);
            
            const end = new Date(now);
            end.setHours(end.getHours() + 4);
            
            document.getElementById('start-time').value = formatDateTimeLocal(now);
            document.getElementById('end-time').value = formatDateTimeLocal(end);
            
            calculateEstimatedCost();
            
            document.getElementById('reservation-modal').classList.add('active');
        }
        
        function closeModal() {
            document.getElementById('reservation-modal').classList.remove('active');
        }
        
        function formatDateTimeLocal(date) {
            return date.toISOString().slice(0, 16);
        }
        
        function calculateEstimatedCost() {
            const startTime = document.getElementById('start-time').value;
            const endTime = document.getElementById('end-time').value;
            
            if (startTime && endTime) {
                const start = new Date(startTime);
                const end = new Date(endTime);
                const hours = Math.ceil((end - start) / (1000 * 60 * 60));
                const cost = Math.max(0, hours * 5);
                document.getElementById('estimated-cost').textContent = '$' + cost.toFixed(2);
            }
        }
        
        async function submitReservation() {
            const spotId = document.getElementById('modal-spot-id').value;
            const startTime = document.getElementById('start-time').value;
            const endTime = document.getElementById('end-time').value;
            const vehiclePlate = document.getElementById('vehicle-plate').value;
            
            if (!startTime || !endTime || !vehiclePlate) {
                showToast('Erreur', 'Veuillez remplir tous les champs.', 'error');
                return;
            }
            
            const confirmBtn = document.getElementById('confirm-reservation');
            confirmBtn.disabled = true;
            confirmBtn.innerHTML = '<span class="loading-spinner"></span> Traitement...';
            
            try {
                const reservation = await ApiService.createReservation({
                    spot_id: spotId,
                    start_time: new Date(startTime).toISOString(),
                    end_time: new Date(endTime).toISOString(),
                    vehicle_plate: vehiclePlate
                });
                
                if (typeof StateService !== 'undefined') {
                    StateService.saveLastReservation(reservation);
                }
                
                showToast('R√©servation Confirm√©e', `Place ${spotId} r√©serv√©e avec succ√®s !`, 'success');
                closeModal();
                loadParkingData();
                
                setTimeout(() => {
                    window.location.href = '/frontend/pages/user/reservations.html';
                }, 1500);
            } catch (error) {
                showToast('Erreur', error.message || '√âchec de la r√©servation.', 'error');
            } finally {
                confirmBtn.disabled = false;
                confirmBtn.innerHTML = '‚úÖ Confirmer';
            }
        }
        
        // Fonction Toast simple
        function showToast(title, message, type = 'info') {
            const container = document.getElementById('toast-container');
            if (!container) return;
            
            const icons = { success: '‚úÖ', error: '‚ùå', warning: '‚ö†Ô∏è', info: '‚ÑπÔ∏è' };
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <span class="toast-icon">${icons[type]}</span>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    <div class="toast-message">${message}</div>
                </div>
                <button class="toast-close" onclick="this.parentElement.remove()">‚úï</button>
            `;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 5000);
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <meta name="description" content="AeroPark GOMA - Smart Airport Parking Management System. Reserve parking spots, generate access codes, and manage payments seamlessly.">
    <meta name="theme-color" content="#1e3a5f">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="AeroPark">
    
    <title>AeroPark GOMA - Smart Airport Parking</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="assets/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="assets/icons/favicon-16x16.png">
    <link rel="apple-touch-icon" href="assets/icons/apple-touch-icon.png">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="css/styles.css">
    
    <!-- Preconnect for performance -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="dns-prefetch" href="//localhost:8000">
</head>
<body>
    <!-- Offline Banner -->
    <div class="offline-banner" id="offline-banner">
        ‚ö†Ô∏è You are currently offline. Some features may be limited.
    </div>
    
    <!-- Header -->
    <header class="header">
        <div class="header-container">
            <a href="/frontend/index.html" class="logo">
                <svg class="logo-icon" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="20" cy="20" r="18" stroke="currentColor" stroke-width="2" fill="none"/>
                    <path d="M20 8 L20 32 M12 16 L28 16 M14 24 L26 24" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    <circle cx="20" cy="20" r="4" fill="currentColor"/>
                </svg>
                <span>AeroPark <span style="font-weight: 400; opacity: 0.8;">GOMA</span></span>
            </a>
            
            <button class="nav-toggle" id="nav-toggle" aria-label="Toggle navigation">
                ‚ò∞
            </button>
            
            <nav>
                <ul class="nav-menu" id="nav-menu">
                    <li><a href="/frontend/index.html" class="nav-link active">Home</a></li>
                    
                    <!-- Guest Links -->
                    <li class="guest-only"><a href="/frontend/pages/public/login.html" class="nav-link">Login</a></li>
                    <li class="guest-only"><a href="/frontend/pages/public/register.html" class="nav-link btn btn-secondary btn-sm">Register</a></li>
                    
                    <!-- Authenticated User Links -->
                    <li class="auth-only"><a href="/frontend/pages/user/dashboard.html" class="nav-link">Dashboard</a></li>
                    <li class="auth-only"><a href="/frontend/pages/user/reservations.html" class="nav-link">My Reservations</a></li>
                    
                    <!-- Admin Links -->
                    <li class="admin-only"><a href="/frontend/pages/admin/dashboard.html" class="nav-link">Admin Panel</a></li>
                    
                    <!-- User Menu -->
                    <li class="auth-only">
                        <a href="#" class="nav-link" id="logout-btn">Logout</a>
                    </li>
                </ul>
            </nav>
        </div>
    </header>
    
    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <!-- Hero Section -->
            <section class="hero" style="text-align: center; padding: var(--spacing-12) 0;">
                <h1 style="font-size: 3rem; margin-bottom: var(--spacing-4);">
                    Smart Airport Parking
                </h1>
                <p style="font-size: 1.25rem; max-width: 600px; margin: 0 auto var(--spacing-8);">
                    Reserve your parking spot in advance, generate access codes, and enjoy hassle-free parking at GOMA Airport.
                </p>
                <div class="flex justify-center gap-4">
                    <a href="/frontend/pages/public/register.html" class="btn btn-primary btn-lg guest-only">Get Started</a>
                    <a href="/frontend/pages/user/reservations.html" class="btn btn-primary btn-lg auth-only">Book Now</a>
                    <a href="#parking-status" class="btn btn-outline btn-lg">View Availability</a>
                </div>
            </section>
            
            <!-- Stats Section -->
            <section class="stats-section" style="margin-bottom: var(--spacing-12);">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-card-icon success">üü¢</div>
                        <div class="stat-card-value" id="available-count">--</div>
                        <div class="stat-card-label">Available Spots</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-icon warning">üü°</div>
                        <div class="stat-card-value" id="reserved-count">--</div>
                        <div class="stat-card-label">Reserved</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-icon danger">üî¥</div>
                        <div class="stat-card-value" id="occupied-count">--</div>
                        <div class="stat-card-label">Occupied</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-icon primary">üÖøÔ∏è</div>
                        <div class="stat-card-value" id="total-count">--</div>
                        <div class="stat-card-label">Total Capacity</div>
                    </div>
                </div>
            </section>
            
            <!-- Parking Grid Section -->
            <section id="parking-status" class="parking-section" style="margin-bottom: var(--spacing-12);">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Real-Time Parking Status</h2>
                        <button class="btn btn-sm btn-outline" id="refresh-parking">
                            üîÑ Refresh
                        </button>
                    </div>
                    <div class="card-body">
                        <!-- Legend -->
                        <div class="flex gap-6 mb-6" style="flex-wrap: wrap;">
                            <div class="flex items-center gap-2">
                                <span class="status-dot online"></span>
                                <span>Available</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="status-dot pending"></span>
                                <span>Reserved</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="status-dot offline"></span>
                                <span>Occupied</span>
                            </div>
                        </div>
                        
                        <!-- Parking Grid -->
                        <div class="parking-grid" id="parking-grid">
                            <!-- Loading skeleton -->
                            <div class="skeleton" style="height: 120px;"></div>
                            <div class="skeleton" style="height: 120px;"></div>
                            <div class="skeleton" style="height: 120px;"></div>
                            <div class="skeleton" style="height: 120px;"></div>
                            <div class="skeleton" style="height: 120px;"></div>
                            <div class="skeleton" style="height: 120px;"></div>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Features Section -->
            <section class="features-section" style="margin-bottom: var(--spacing-12);">
                <h2 class="text-center" style="margin-bottom: var(--spacing-8);">Why Choose AeroPark?</h2>
                <div class="grid grid-cols-3" style="gap: var(--spacing-6);">
                    <div class="card text-center">
                        <div style="font-size: 3rem; margin-bottom: var(--spacing-4);">üì±</div>
                        <h3>Mobile Friendly</h3>
                        <p>Access from any device. Install as an app for quick access.</p>
                    </div>
                    <div class="card text-center">
                        <div style="font-size: 3rem; margin-bottom: var(--spacing-4);">üîê</div>
                        <h3>Secure Access</h3>
                        <p>Unique access codes for entry and exit. No physical tickets needed.</p>
                    </div>
                    <div class="card text-center">
                        <div style="font-size: 3rem; margin-bottom: var(--spacing-4);">üí≥</div>
                        <h3>Easy Payments</h3>
                        <p>Multiple payment options. Pay online before you leave.</p>
                    </div>
                </div>
            </section>
            
            <!-- Install PWA Banner -->
            <section class="install-banner card" id="install-section" style="display: none; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white;">
                <div class="flex items-center justify-between" style="flex-wrap: wrap; gap: var(--spacing-4);">
                    <div>
                        <h3 style="color: white; margin-bottom: var(--spacing-2);">Install AeroPark App</h3>
                        <p style="color: rgba(255,255,255,0.8); margin: 0;">Get quick access from your home screen</p>
                    </div>
                    <button class="btn btn-secondary" id="install-btn">Install Now</button>
                </div>
            </section>
        </div>
    </main>
    
    <!-- Footer -->
    <footer style="background: var(--gray-800); color: var(--gray-400); padding: var(--spacing-8) 0; margin-top: var(--spacing-12);">
        <div class="container text-center">
            <p style="margin-bottom: var(--spacing-4);">
                &copy; 2024 AeroPark GOMA. Smart Airport Parking Management System.
            </p>
            <p style="font-size: var(--font-size-sm);">
                <a href="#" style="color: var(--gray-400);">Privacy Policy</a> &bull; 
                <a href="#" style="color: var(--gray-400);">Terms of Service</a> &bull; 
                <a href="#" style="color: var(--gray-400);">Contact Us</a>
            </p>
        </div>
    </footer>
    
    <!-- Reservation Modal -->
    <div class="modal-backdrop" id="reservation-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Reserve Parking Spot</h3>
                <button class="modal-close" id="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="reservation-form">
                    <div class="form-group">
                        <label class="form-label">Parking Spot</label>
                        <input type="text" class="form-input" id="modal-spot-id" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Start Time</label>
                        <input type="datetime-local" class="form-input" id="start-time" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">End Time</label>
                        <input type="datetime-local" class="form-input" id="end-time" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Vehicle Plate Number</label>
                        <input type="text" class="form-input" id="vehicle-plate" placeholder="e.g., ABC-1234" required>
                    </div>
                    <div class="card" style="background: var(--gray-50); margin-top: var(--spacing-4);">
                        <div class="flex justify-between">
                            <span>Estimated Cost:</span>
                            <strong id="estimated-cost">$0.00</strong>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancel-reservation">Cancel</button>
                <button class="btn btn-primary" id="confirm-reservation">Confirm Reservation</button>
            </div>
        </div>
    </div>
    
    <!-- Scripts -->
    <script src="js/services/api.js"></script>
    <script src="js/services/auth.js"></script>
    <script src="js/services/state.js"></script>
    <script src="js/services/notifications.js"></script>
    <script src="js/utils/helpers.js"></script>
    <script src="js/app.js"></script>
    
    <!-- Firebase SDK (Load from CDN or your own hosting) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <!-- Page-specific script -->
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // Load parking data
            await loadParkingData();
            
            // Refresh button
            document.getElementById('refresh-parking').addEventListener('click', loadParkingData);
            
            // Modal handlers
            setupModalHandlers();
            
            // Calculate estimated cost on time change
            document.getElementById('start-time').addEventListener('change', calculateEstimatedCost);
            document.getElementById('end-time').addEventListener('change', calculateEstimatedCost);
        });
        
        async function loadParkingData() {
            const grid = document.getElementById('parking-grid');
            
            try {
                // Try to get from API
                const spots = await ApiService.getParkingSpots();
                
                // Update stats
                updateStats(spots);
                
                // Cache the data
                StateService.cacheParkingSpots(spots);
                
                // Render grid
                renderParkingGrid(spots);
            } catch (error) {
                console.error('Failed to load parking data:', error);
                
                // Try cached data
                const cached = StateService.getCachedParkingSpots();
                if (cached.spots.length > 0) {
                    updateStats(cached.spots);
                    renderParkingGrid(cached.spots);
                    if (!cached.isValid) {
                        NotificationService.warning('Showing cached data. Pull to refresh when online.');
                    }
                } else {
                    grid.innerHTML = '<p class="text-center text-muted">Unable to load parking data. Please check your connection.</p>';
                }
            }
        }
        
        function updateStats(spots) {
            const available = spots.filter(s => s.status === 'free').length;
            const reserved = spots.filter(s => s.status === 'reserved').length;
            const occupied = spots.filter(s => s.status === 'occupied').length;
            
            document.getElementById('available-count').textContent = available;
            document.getElementById('reserved-count').textContent = reserved;
            document.getElementById('occupied-count').textContent = occupied;
            document.getElementById('total-count').textContent = spots.length;
        }
        
        function renderParkingGrid(spots) {
            const grid = document.getElementById('parking-grid');
            const isAuthenticated = AuthService?.isAuthenticated() || localStorage.getItem('aeropark_token');
            
            grid.innerHTML = spots.map(spot => `
                <div class="parking-spot ${spot.status}" 
                     data-spot-id="${spot.id}" 
                     data-status="${spot.status}"
                     ${spot.status === 'free' && isAuthenticated ? 'onclick="openReservationModal(\'' + spot.id + '\')"' : ''}>
                    <span class="parking-spot-id">${spot.id}</span>
                    <span class="parking-spot-status">${Helpers.getParkingStatusIcon(spot.status)} ${Helpers.getParkingStatusText(spot.status)}</span>
                </div>
            `).join('');
        }
        
        function setupModalHandlers() {
            const modal = document.getElementById('reservation-modal');
            const closeBtn = document.getElementById('close-modal');
            const cancelBtn = document.getElementById('cancel-reservation');
            const confirmBtn = document.getElementById('confirm-reservation');
            
            closeBtn.addEventListener('click', closeModal);
            cancelBtn.addEventListener('click', closeModal);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeModal();
            });
            
            confirmBtn.addEventListener('click', submitReservation);
        }
        
        function openReservationModal(spotId) {
            const isAuthenticated = AuthService?.isAuthenticated() || localStorage.getItem('aeropark_token');
            
            if (!isAuthenticated) {
                NotificationService.warning('Please login to make a reservation', 'Login Required');
                window.location.href = '/frontend/pages/public/login.html';
                return;
            }
            
            document.getElementById('modal-spot-id').value = spotId;
            
            // Set default times (next hour to +4 hours)
            const now = new Date();
            now.setMinutes(0, 0, 0);
            now.setHours(now.getHours() + 1);
            
            const end = new Date(now);
            end.setHours(end.getHours() + 4);
            
            document.getElementById('start-time').value = formatDateTimeLocal(now);
            document.getElementById('end-time').value = formatDateTimeLocal(end);
            
            calculateEstimatedCost();
            
            document.getElementById('reservation-modal').classList.add('active');
        }
        
        function closeModal() {
            document.getElementById('reservation-modal').classList.remove('active');
        }
        
        function formatDateTimeLocal(date) {
            return date.toISOString().slice(0, 16);
        }
        
        function calculateEstimatedCost() {
            const startTime = document.getElementById('start-time').value;
            const endTime = document.getElementById('end-time').value;
            
            if (startTime && endTime) {
                const cost = Helpers.calculateParkingFee(startTime, endTime, 5);
                document.getElementById('estimated-cost').textContent = Helpers.formatCurrency(cost);
            }
        }
        
        async function submitReservation() {
            const spotId = document.getElementById('modal-spot-id').value;
            const startTime = document.getElementById('start-time').value;
            const endTime = document.getElementById('end-time').value;
            const vehiclePlate = document.getElementById('vehicle-plate').value;
            
            if (!startTime || !endTime || !vehiclePlate) {
                NotificationService.error('Please fill in all fields');
                return;
            }
            
            const confirmBtn = document.getElementById('confirm-reservation');
            confirmBtn.disabled = true;
            confirmBtn.innerHTML = '<span class="loading-spinner"></span> Processing...';
            
            try {
                const reservation = await ApiService.createReservation({
                    spot_id: spotId,
                    start_time: new Date(startTime).toISOString(),
                    end_time: new Date(endTime).toISOString(),
                    vehicle_plate: vehiclePlate
                });
                
                StateService.saveLastReservation(reservation);
                NotificationService.reservationCreated(reservation);
                closeModal();
                loadParkingData();
                
                // Redirect to reservations page
                setTimeout(() => {
                    window.location.href = '/frontend/pages/user/reservations.html';
                }, 1500);
            } catch (error) {
                NotificationService.error(error.message || 'Failed to create reservation');
            } finally {
                confirmBtn.disabled = false;
                confirmBtn.innerHTML = 'Confirm Reservation';
            }
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paiements - Admin AeroPark GOMA</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/admin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="admin-page">
    <!-- Sidebar -->
    <aside class="admin-sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">
                <i class="fas fa-plane"></i>
                <span>AeroPark GOMA</span>
            </div>
            <button class="sidebar-toggle" id="sidebar-toggle">
                <i class="fas fa-bars"></i>
            </button>
        </div>

        <nav class="sidebar-nav">
            <ul>
                <li>
                    <a href="dashboard.html">
                        <i class="fas fa-tachometer-alt"></i>
                        <span>Tableau de bord</span>
                    </a>
                </li>
                <li>
                    <a href="places.html">
                        <i class="fas fa-parking"></i>
                        <span>Gestion des places</span>
                    </a>
                </li>
                <li>
                    <a href="reservations.html">
                        <i class="fas fa-calendar-check"></i>
                        <span>Réservations</span>
                    </a>
                </li>
                <li>
                    <a href="users.html">
                        <i class="fas fa-users"></i>
                        <span>Utilisateurs</span>
                    </a>
                </li>
                <li class="active">
                    <a href="payments.html">
                        <i class="fas fa-money-bill-wave"></i>
                        <span>Paiements</span>
                    </a>
                </li>
                <li>
                    <a href="settings.html">
                        <i class="fas fa-cog"></i>
                        <span>Paramètres</span>
                    </a>
                </li>
            </ul>
        </nav>

        <div class="sidebar-footer">
            <div class="admin-info">
                <div class="admin-avatar">
                    <i class="fas fa-user-shield"></i>
                </div>
                <div class="admin-details">
                    <span class="admin-name" id="admin-name">Admin</span>
                    <span class="admin-role">Administrateur</span>
                </div>
            </div>
            <button class="btn-logout" id="admin-logout">
                <i class="fas fa-sign-out-alt"></i>
                <span>Déconnexion</span>
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="admin-main">
        <header class="admin-header">
            <div class="header-left">
                <button class="mobile-menu-toggle" id="mobile-menu-toggle">
                    <i class="fas fa-bars"></i>
                </button>
                <h1>Historique des Paiements</h1>
            </div>
        </header>

        <div class="admin-content">
            <!-- Stats -->
            <section class="dashboard-stats">
                <div class="stat-card-admin">
                    <div class="stat-card-icon green">
                        <i class="fas fa-money-bill-wave"></i>
                    </div>
                    <div class="stat-card-info">
                        <h3 id="stat-total-amount">0 FC</h3>
                        <p>Total revenus</p>
                    </div>
                </div>
                <div class="stat-card-admin">
                    <div class="stat-card-icon blue">
                        <i class="fas fa-receipt"></i>
                    </div>
                    <div class="stat-card-info">
                        <h3 id="stat-transactions">0</h3>
                        <p>Transactions</p>
                    </div>
                </div>
                <div class="stat-card-admin">
                    <div class="stat-card-icon orange">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="stat-card-info">
                        <h3 id="stat-today">0 FC</h3>
                        <p>Revenus aujourd'hui</p>
                    </div>
                </div>
            </section>

            <!-- Payments by Method Chart -->
            <div class="dashboard-card full-width" style="margin-bottom: 1.5rem;">
                <div class="card-header">
                    <h3><i class="fas fa-chart-pie"></i> Répartition par méthode</h3>
                </div>
                <div class="card-body">
                    <div id="payment-methods-chart" style="display: flex; justify-content: space-around; flex-wrap: wrap; gap: 1rem; padding: 1rem;">
                        <!-- Généré par JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Filters -->
            <div class="filters-bar">
                <div class="filter-group">
                    <label>Date début:</label>
                    <input type="date" id="filter-date-start" onchange="filterPayments()">
                </div>
                <div class="filter-group">
                    <label>Date fin:</label>
                    <input type="date" id="filter-date-end" onchange="filterPayments()">
                </div>
                <div class="filter-group">
                    <label>Méthode:</label>
                    <select id="filter-method" onchange="filterPayments()">
                        <option value="all">Toutes</option>
                        <option value="orange">Orange Money</option>
                        <option value="airtel">Airtel Money</option>
                        <option value="mpesa">M-Pesa</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Statut:</label>
                    <select id="filter-status" onchange="filterPayments()">
                        <option value="all">Tous</option>
                        <option value="success">Réussi</option>
                        <option value="failed">Échoué</option>
                        <option value="pending">En attente</option>
                    </select>
                </div>
                <div style="flex: 1;"></div>
                <button class="btn btn-outline" onclick="exportPayments()">
                    <i class="fas fa-download"></i> Exporter
                </button>
            </div>

            <!-- Payments Table -->
            <div class="dashboard-card full-width">
                <div class="card-header">
                    <h3><i class="fas fa-list"></i> Liste des Paiements</h3>
                    <span id="payments-count">0 paiements</span>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>ID Transaction</th>
                                    <th>Utilisateur</th>
                                    <th>Méthode</th>
                                    <th>Téléphone</th>
                                    <th>Montant</th>
                                    <th>Place</th>
                                    <th>Date</th>
                                    <th>Statut</th>
                                </tr>
                            </thead>
                            <tbody id="payments-table">
                                <tr>
                                    <td colspan="8" class="text-center">Chargement...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- AeroPark API Services -->
    <script src="../js/api.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/admin.js"></script>
    <script>
        var allPayments = [];
        var allUsers = [];

        document.addEventListener('DOMContentLoaded', function() {
            if (!Auth.isLoggedIn() || !Auth.isAdmin()) {
                window.location.href = 'login.html';
                return;
            }

            Admin.initSidebar();

            var admin = Auth.getUser();
            if (admin) {
                document.getElementById('admin-name').textContent = admin.username || admin.name || 'Admin';
            }

            loadStats().then(function() {
                loadPaymentMethodsChart();
                return loadPaymentsTable();
            }).catch(function(error) {
                console.error('Erreur lors du chargement:', error);
                Admin.showNotification('Erreur lors du chargement des données', 'error');
            });
        });

        function loadStats() {
            return API.getAdminPayments().then(function(response) {
                allPayments = response.payments || response || [];
                
                // Extract users from payments since there's no dedicated endpoint
                var usersMap = {};
                for (var i = 0; i < allPayments.length; i++) {
                    var p = allPayments[i];
                    var userId = p.user_id || p.userId;
                    if (userId && !usersMap[userId]) {
                        usersMap[userId] = {
                            id: userId,
                            email: p.user_email || 'utilisateur@email.com',
                            name: p.user_name || p.user_email || 'Utilisateur'
                        };
                    }
                }
                allUsers = Object.values(usersMap);
                
                var successPayments = allPayments.filter(function(p) {
                    return p.status === 'success' || p.status === 'completed';
                });
                var totalAmount = successPayments.reduce(function(sum, p) {
                    return sum + (p.amount || 0);
                }, 0);
                
                // Calcul des revenus d'aujourd'hui
                var today = new Date().toISOString().split('T')[0];
                var todayPayments = successPayments.filter(function(p) {
                    var paymentDate = new Date(p.date || p.created_at || p.createdAt).toISOString().split('T')[0];
                    return paymentDate === today;
                });
                var todayAmount = todayPayments.reduce(function(sum, p) {
                    return sum + (p.amount || 0);
                }, 0);
                
                document.getElementById('stat-total-amount').textContent = totalAmount.toLocaleString('fr-FR') + ' FC';
                document.getElementById('stat-transactions').textContent = successPayments.length;
                document.getElementById('stat-today').textContent = todayAmount.toLocaleString('fr-FR') + ' FC';
            }).catch(function(error) {
                console.error('Erreur chargement stats:', error);
            });
        }

        function loadPaymentMethodsChart() {
            var payments = (allPayments || []).filter(function(p) {
                return p.status === 'success' || p.status === 'completed';
            });
            
            var byMethod = {
                orange: { count: 0, amount: 0, name: 'Orange Money', color: '#ff6b35', icon: 'fab fa-orange' },
                airtel: { count: 0, amount: 0, name: 'Airtel Money', color: '#e4002b', icon: 'fas fa-mobile-alt' },
                mpesa: { count: 0, amount: 0, name: 'M-Pesa', color: '#00a651', icon: 'fas fa-mobile-alt' }
            };

            payments.forEach(function(p) {
                var method = (p.method || p.payment_method || '').toLowerCase();
                if (byMethod[method]) {
                    byMethod[method].count++;
                    byMethod[method].amount += p.amount || 0;
                }
            });

            var total = payments.length || 1;
            var chartHtml = '';
            var methods = Object.keys(byMethod);
            
            for (var i = 0; i < methods.length; i++) {
                var key = methods[i];
                var data = byMethod[key];
                var percent = ((data.count / total) * 100).toFixed(1);
                chartHtml += '<div style="text-align: center; min-width: 150px;">' +
                    '<div style="width: 100px; height: 100px; border-radius: 50%; background: conic-gradient(' + data.color + ' 0% ' + percent + '%, #e0e0e0 ' + percent + '% 100%); margin: 0 auto 1rem; display: flex; align-items: center; justify-content: center;">' +
                    '<div style="width: 70px; height: 70px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center;">' +
                    '<span style="font-weight: bold; color: ' + data.color + ';">' + percent + '%</span>' +
                    '</div></div>' +
                    '<h4 style="margin: 0; color: ' + data.color + ';">' + data.name + '</h4>' +
                    '<p style="margin: 0.25rem 0; color: var(--text-secondary);">' + data.count + ' transactions</p>' +
                    '<p style="margin: 0; font-weight: 600;">' + data.amount.toLocaleString('fr-FR') + ' FC</p>' +
                    '</div>';
            }
            
            document.getElementById('payment-methods-chart').innerHTML = chartHtml;
        }

        function loadPaymentsTable() {
            var payments = getFilteredPayments();
            var tbody = document.getElementById('payments-table');

            document.getElementById('payments-count').textContent = payments.length + ' paiements';

            if (payments.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">Aucun paiement trouvé</td></tr>';
                return Promise.resolve();
            }

            var sortedPayments = payments.sort(function(a, b) {
                return new Date(b.date || b.created_at) - new Date(a.date || a.created_at);
            });

            var methodIcons = {
                orange: '<span style="color: #ff6b35;"><i class="fas fa-circle"></i> Orange Money</span>',
                airtel: '<span style="color: #e4002b;"><i class="fas fa-circle"></i> Airtel Money</span>',
                mpesa: '<span style="color: #00a651;"><i class="fas fa-circle"></i> M-Pesa</span>'
            };

            var statusBadge = {
                success: '<span class="badge success">Réussi</span>',
                completed: '<span class="badge success">Réussi</span>',
                failed: '<span class="badge danger">Échoué</span>',
                pending: '<span class="badge warning">En attente</span>'
            };

            var html = '';
            for (var i = 0; i < sortedPayments.length; i++) {
                var payment = sortedPayments[i];
                var user = null;
                for (var j = 0; j < allUsers.length; j++) {
                    if (allUsers[j].id === payment.user_id || allUsers[j].id === payment.userId) {
                        user = allUsers[j];
                        break;
                    }
                }
                var userName = user ? (user.name || user.display_name || user.email) : (payment.user_email || 'Utilisateur');
                var method = (payment.method || payment.payment_method || '').toLowerCase();
                var transactionId = (payment.id || payment.transaction_id || '').slice(-10);
                
                html += '<tr>' +
                    '<td><code>' + transactionId + '</code></td>' +
                    '<td>' + userName + '</td>' +
                    '<td>' + (methodIcons[method] || method) + '</td>' +
                    '<td>' + (payment.phone || payment.phone_number || '-') + '</td>' +
                    '<td><strong>' + (payment.amount || 0).toLocaleString('fr-FR') + ' FC</strong></td>' +
                    '<td>' + (payment.place_id || payment.spotId || '-') + '</td>' +
                    '<td>' + Admin.formatDate(payment.date || payment.created_at || payment.createdAt) + '</td>' +
                    '<td>' + (statusBadge[payment.status] || payment.status) + '</td>' +
                    '</tr>';
            }
            
            tbody.innerHTML = html;
            return Promise.resolve();
        }

        function getFilteredPayments() {
            var payments = allPayments || [];
            
            var dateStart = document.getElementById('filter-date-start').value;
            var dateEnd = document.getElementById('filter-date-end').value;
            var method = document.getElementById('filter-method').value;
            var status = document.getElementById('filter-status').value;

            if (dateStart) {
                payments = payments.filter(function(p) {
                    return new Date(p.date || p.created_at) >= new Date(dateStart);
                });
            }

            if (dateEnd) {
                var end = new Date(dateEnd);
                end.setHours(23, 59, 59);
                payments = payments.filter(function(p) {
                    return new Date(p.date || p.created_at) <= end;
                });
            }

            if (method !== 'all') {
                payments = payments.filter(function(p) {
                    return (p.method || p.payment_method || '').toLowerCase() === method;
                });
            }

            if (status !== 'all') {
                payments = payments.filter(function(p) {
                    return p.status === status || (status === 'success' && p.status === 'completed');
                });
            }

            return payments;
        }

        function filterPayments() {
            loadPaymentMethodsChart();
            loadPaymentsTable();
        }

        function exportPayments() {
            var filtered = getFilteredPayments();
            var payments = [];
            for (var i = 0; i < filtered.length; i++) {
                var p = filtered[i];
                payments.push({
                    id: p.id || p.transaction_id,
                    method: p.method || p.payment_method,
                    phone: p.phone || p.phone_number,
                    amount: p.amount,
                    spotId: p.place_id || p.spotId,
                    date: p.date || p.created_at,
                    status: p.status
                });
            }
            Admin.exportToCSV(payments, 'paiements_aeropark.csv');
            Admin.showNotification('Export terminé');
        }
    </script>
</body>
</html>

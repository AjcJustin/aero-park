<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Admin AeroPark GOMA</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/admin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="admin-page">
    <!-- Sidebar -->
    <aside class="admin-sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">
                <i class="fas fa-plane"></i>
                <span>AeroPark GOMA</span>
            </div>
            <button class="sidebar-toggle" id="sidebar-toggle">
                <i class="fas fa-bars"></i>
            </button>
        </div>

        <nav class="sidebar-nav">
            <ul>
                <li class="active">
                    <a href="dashboard.html">
                        <i class="fas fa-tachometer-alt"></i>
                        <span>Tableau de bord</span>
                    </a>
                </li>
                <li>
                    <a href="places.html">
                        <i class="fas fa-parking"></i>
                        <span>Gestion des places</span>
                    </a>
                </li>
                <li>
                    <a href="reservations.html">
                        <i class="fas fa-calendar-check"></i>
                        <span>Réservations</span>
                    </a>
                </li>
                <li>
                    <a href="users.html">
                        <i class="fas fa-users"></i>
                        <span>Utilisateurs</span>
                    </a>
                </li>
                <li>
                    <a href="payments.html">
                        <i class="fas fa-money-bill-wave"></i>
                        <span>Paiements</span>
                    </a>
                </li>
                <li>
                    <a href="settings.html">
                        <i class="fas fa-cog"></i>
                        <span>Paramètres</span>
                    </a>
                </li>
            </ul>
        </nav>

        <div class="sidebar-footer">
            <div class="admin-info">
                <div class="admin-avatar">
                    <i class="fas fa-user-shield"></i>
                </div>
                <div class="admin-details">
                    <span class="admin-name" id="admin-name">Admin</span>
                    <span class="admin-role">Administrateur</span>
                </div>
            </div>
            <button class="btn-logout" id="admin-logout">
                <i class="fas fa-sign-out-alt"></i>
                <span>Déconnexion</span>
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="admin-main">
        <header class="admin-header">
            <div class="header-left">
                <button class="mobile-menu-toggle" id="mobile-menu-toggle">
                    <i class="fas fa-bars"></i>
                </button>
                <h1>Tableau de bord</h1>
            </div>
            <div class="header-right">
                <span class="current-date" id="current-date"></span>
            </div>
        </header>

        <div class="admin-content">
            <!-- Stats Cards -->
            <section class="dashboard-stats">
                <div class="stat-card-admin">
                    <div class="stat-card-icon blue">
                        <i class="fas fa-parking"></i>
                    </div>
                    <div class="stat-card-info">
                        <h3 id="stat-total-places">0</h3>
                        <p>Places totales</p>
                    </div>
                </div>

                <div class="stat-card-admin">
                    <div class="stat-card-icon green">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="stat-card-info">
                        <h3 id="stat-available">0</h3>
                        <p>Disponibles</p>
                    </div>
                </div>

                <div class="stat-card-admin">
                    <div class="stat-card-icon orange">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stat-card-info">
                        <h3 id="stat-reserved">0</h3>
                        <p>Réservées</p>
                    </div>
                </div>

                <div class="stat-card-admin">
                    <div class="stat-card-icon red">
                        <i class="fas fa-car"></i>
                    </div>
                    <div class="stat-card-info">
                        <h3 id="stat-occupied">0</h3>
                        <p>Occupées</p>
                    </div>
                </div>

                <div class="stat-card-admin">
                    <div class="stat-card-icon purple">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-card-info">
                        <h3 id="stat-users">0</h3>
                        <p>Utilisateurs</p>
                    </div>
                </div>

                <div class="stat-card-admin">
                    <div class="stat-card-icon teal">
                        <i class="fas fa-money-bill-wave"></i>
                    </div>
                    <div class="stat-card-info">
                        <h3 id="stat-revenue">0 FC</h3>
                        <p>Revenus totaux</p>
                    </div>
                </div>
            </section>

            <!-- Charts & Tables Row -->
            <div class="dashboard-grid">
                <!-- Occupation Chart -->
                <div class="dashboard-card">
                    <div class="card-header">
                        <h3><i class="fas fa-chart-pie"></i> Taux d'occupation</h3>
                    </div>
                    <div class="card-body">
                        <div class="occupation-chart">
                            <div class="chart-ring">
                                <svg viewBox="0 0 200 200">
                                    <circle class="chart-bg" cx="100" cy="100" r="80"></circle>
                                    <circle class="chart-progress" cx="100" cy="100" r="80" id="occupation-ring"></circle>
                                </svg>
                                <div class="chart-center">
                                    <span id="occupation-percent">0%</span>
                                </div>
                            </div>
                            <div class="chart-legend">
                                <div class="legend-item">
                                    <span class="dot green"></span>
                                    <span>Disponibles: <strong id="legend-available">0</strong></span>
                                </div>
                                <div class="legend-item">
                                    <span class="dot orange"></span>
                                    <span>Réservées: <strong id="legend-reserved">0</strong></span>
                                </div>
                                <div class="legend-item">
                                    <span class="dot red"></span>
                                    <span>Occupées: <strong id="legend-occupied">0</strong></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Reservations -->
                <div class="dashboard-card">
                    <div class="card-header">
                        <h3><i class="fas fa-calendar-check"></i> Réservations récentes</h3>
                        <a href="reservations.html" class="card-link">Voir tout</a>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="admin-table">
                                <thead>
                                    <tr>
                                        <th>Place</th>
                                        <th>Utilisateur</th>
                                        <th>Date</th>
                                        <th>Statut</th>
                                    </tr>
                                </thead>
                                <tbody id="recent-reservations">
                                    <tr>
                                        <td colspan="4" class="text-center">Chargement...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Payments -->
            <div class="dashboard-card full-width">
                <div class="card-header">
                    <h3><i class="fas fa-money-bill-wave"></i> Derniers paiements</h3>
                    <a href="payments.html" class="card-link">Voir tout</a>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Place</th>
                                    <th>Montant</th>
                                    <th>Méthode</th>
                                    <th>Téléphone</th>
                                    <th>Date</th>
                                    <th>Statut</th>
                                </tr>
                            </thead>
                            <tbody id="recent-payments">
                                <tr>
                                    <td colspan="7" class="text-center">Chargement...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Parking Map Overview -->
            <div class="dashboard-card full-width">
                <div class="card-header">
                    <h3><i class="fas fa-map"></i> Aperçu du parking</h3>
                    <a href="places.html" class="card-link">Gérer les places</a>
                </div>
                <div class="card-body">
                    <div class="parking-overview" id="parking-overview">
                        <!-- Généré par JavaScript -->
                    </div>
                    <div class="map-legend" style="margin-top: 1rem;">
                        <div class="legend-item">
                            <span class="legend-color available"></span>
                            <span>Disponible</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-color occupied"></span>
                            <span>Occupée</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-color reserved"></span>
                            <span>Réservée</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="../js/api.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/admin.js"></script>
    <script>
        var cachedParkingData = null;
        
        document.addEventListener('DOMContentLoaded', async function() {
            if (!Auth.isLoggedIn() || !Auth.isAdmin()) {
                window.location.href = 'login.html';
                return;
            }
            
            await initDashboard();
            Admin.initSidebar();
            updateCurrentDate();
        });

        async function initDashboard() {
            await loadStats();
            await loadOccupationChart();
            await loadRecentReservations();
            await loadRecentPayments();
            await loadParkingOverview();

            var user = Auth.getUser();
            if (user) {
                document.getElementById('admin-name').textContent = user.name || 'Admin';
            }
        }

        function updateCurrentDate() {
            var options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('current-date').textContent = new Date().toLocaleDateString('fr-FR', options);
        }

        async function loadStats() {
            try {
                var response = await API.getParkingStatus();
                cachedParkingData = response;
                
                var places = response.places || [];
                var total = places.length;
                // Backend uses 'etat': free, reserved, occupied
                var available = places.filter(function(p) { return (p.etat || p.status) === 'free'; }).length;
                var reserved = places.filter(function(p) { return (p.etat || p.status) === 'reserved'; }).length;
                var occupied = places.filter(function(p) { return (p.etat || p.status) === 'occupied'; }).length;
                
                document.getElementById('stat-total-places').textContent = total;
                document.getElementById('stat-available').textContent = available;
                document.getElementById('stat-reserved').textContent = reserved;
                document.getElementById('stat-occupied').textContent = occupied;
                
                try {
                    var adminStats = await API.getAdminStats();
                    // Backend returns: taux_occupation, libres, occupees, reservees
                    document.getElementById('stat-users').textContent = adminStats.users_count || '-';
                    document.getElementById('stat-revenue').textContent = (adminStats.total_revenue || 0).toLocaleString('fr-FR') + ' FC';
                } catch (e) {
                    document.getElementById('stat-users').textContent = '-';
                    document.getElementById('stat-revenue').textContent = '- FC';
                }
                
            } catch (error) {
                console.error('Erreur chargement stats:', error);
            }
        }

        async function loadOccupationChart() {
            try {
                if (!cachedParkingData) {
                    cachedParkingData = await API.getParkingStatus();
                }
                
                var places = cachedParkingData.places || [];
                var total = places.length;
                // Backend uses 'etat': free, reserved, occupied
                var available = places.filter(function(p) { return (p.etat || p.status) === 'free'; }).length;
                var reserved = places.filter(function(p) { return (p.etat || p.status) === 'reserved'; }).length;
                var occupied = places.filter(function(p) { return (p.etat || p.status) === 'occupied'; }).length;
                var occupationRate = total > 0 ? Math.round(((reserved + occupied) / total) * 100) : 0;
                
                var ring = document.getElementById('occupation-ring');
                var circumference = 2 * Math.PI * 80;
                var offset = circumference - (occupationRate / 100) * circumference;
                
                ring.style.strokeDasharray = circumference;
                ring.style.strokeDashoffset = offset;

                document.getElementById('occupation-percent').textContent = occupationRate + '%';
                document.getElementById('legend-available').textContent = available;
                document.getElementById('legend-reserved').textContent = reserved;
                document.getElementById('legend-occupied').textContent = occupied;
            } catch (error) {
                console.error('Error loading chart:', error);
            }
        }

        async function loadRecentReservations() {
            var tbody = document.getElementById('recent-reservations');
            
            try {
                var response = await API.getAdminReservations();
                // API returns { reservations: [...], total: n }
                var reservations = response.reservations || response || [];
                var recent = Array.isArray(reservations) ? reservations.slice(-5).reverse() : [];

                if (recent.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Aucune réservation</td></tr>';
                    return;
                }

                tbody.innerHTML = recent.map(function(res) {
                    var date = res.created_at ? new Date(res.created_at).toLocaleDateString('fr-FR') : '-';
                    var statusClass = res.status === 'active' ? 'success' : 'secondary';
                    var statusText = res.status === 'active' ? 'Active' : 'Terminée';
                    
                    return '<tr>' +
                        '<td><strong>' + (res.place_id || res.spotId || '-') + '</strong></td>' +
                        '<td>' + (res.user_name || res.userName || 'Utilisateur') + '</td>' +
                        '<td>' + date + '</td>' +
                        '<td><span class="badge ' + statusClass + '">' + statusText + '</span></td>' +
                    '</tr>';
                }).join('');
            } catch (error) {
                console.error('Error loading reservations:', error);
                tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Erreur de chargement</td></tr>';
            }
        }

        async function loadRecentPayments() {
            var tbody = document.getElementById('recent-payments');

            try {
                var response = await API.getAdminPayments();
                // API returns { payments: [...], total: n, summary: {...} }
                var payments = response.payments || response || [];
                var recent = Array.isArray(payments) ? payments.slice(-5).reverse() : [];

                if (recent.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">Aucun paiement</td></tr>';
                    return;
                }

                var methodNames = {
                    'ORANGE_MONEY': 'Orange Money',
                    'AIRTEL_MONEY': 'Airtel Money',
                    'MPESA': 'M-Pesa',
                    'orange': 'Orange Money',
                    'airtel': 'Airtel Money',
                    'mpesa': 'M-Pesa'
                };

                tbody.innerHTML = recent.map(function(pay) {
                    var date = pay.paid_at || pay.paidAt ? new Date(pay.paid_at || pay.paidAt).toLocaleDateString('fr-FR') : '-';
                    var statusClass = pay.status === 'completed' || pay.status === 'success' ? 'success' : 'danger';
                    var statusText = pay.status === 'completed' || pay.status === 'success' ? 'Réussi' : 'Échoué';
                    var method = pay.provider || pay.paymentMethod || '';
                    
                    return '<tr>' +
                        '<td>#' + (pay.id || '').toString().slice(-6) + '</td>' +
                        '<td><strong>' + (pay.place_id || pay.spotId || '-') + '</strong></td>' +
                        '<td>' + (pay.amount || 0).toLocaleString('fr-FR') + ' FC</td>' +
                        '<td>' + (methodNames[method] || method) + '</td>' +
                        '<td>' + (pay.phone_number || pay.phoneNumber || '-') + '</td>' +
                        '<td>' + date + '</td>' +
                        '<td><span class="badge ' + statusClass + '">' + statusText + '</span></td>' +
                    '</tr>';
                }).join('');
            } catch (error) {
                console.error('Error loading payments:', error);
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">Erreur de chargement</td></tr>';
            }
        }

        async function loadParkingOverview() {
            var container = document.getElementById('parking-overview');
            
            try {
                if (!cachedParkingData) {
                    cachedParkingData = await API.getParkingStatus();
                }
                
                var spots = cachedParkingData.places || [];

                container.innerHTML = spots.map(function(spot) {
                    // Backend uses 'etat': free, reserved, occupied
                    var status = spot.etat || spot.status || 'free';
                    var statusClass = status === 'free' ? 'available' : status;
                    return '<div class="parking-spot-admin ' + statusClass + '" title="Place ' + spot.id + ' - ' + status + '">' + spot.id + '</div>';
                }).join('');
            } catch (error) {
                console.error('Error loading overview:', error);
                container.innerHTML = '<p class="text-muted">Erreur de chargement</p>';
            }
        }

        // Refresh data every 30 seconds
        setInterval(async function() {
            cachedParkingData = null;
            await loadStats();
            await loadOccupationChart();
            await loadParkingOverview();
        }, 30000);
    </script>
</body>
</html>

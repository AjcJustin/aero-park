<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion des Places - Admin AeroPark GOMA</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/admin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="admin-page">
    <!-- Sidebar -->
    <aside class="admin-sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">
                <i class="fas fa-plane"></i>
                <span>AeroPark GOMA</span>
            </div>
            <button class="sidebar-toggle" id="sidebar-toggle">
                <i class="fas fa-bars"></i>
            </button>
        </div>

        <nav class="sidebar-nav">
            <ul>
                <li>
                    <a href="dashboard.html">
                        <i class="fas fa-tachometer-alt"></i>
                        <span>Tableau de bord</span>
                    </a>
                </li>
                <li class="active">
                    <a href="places.html">
                        <i class="fas fa-parking"></i>
                        <span>Gestion des places</span>
                    </a>
                </li>
                <li>
                    <a href="reservations.html">
                        <i class="fas fa-calendar-check"></i>
                        <span>Réservations</span>
                    </a>
                </li>
                <li>
                    <a href="users.html">
                        <i class="fas fa-users"></i>
                        <span>Utilisateurs</span>
                    </a>
                </li>
                <li>
                    <a href="payments.html">
                        <i class="fas fa-money-bill-wave"></i>
                        <span>Paiements</span>
                    </a>
                </li>
                <li>
                    <a href="settings.html">
                        <i class="fas fa-cog"></i>
                        <span>Paramètres</span>
                    </a>
                </li>
            </ul>
        </nav>

        <div class="sidebar-footer">
            <div class="admin-info">
                <div class="admin-avatar">
                    <i class="fas fa-user-shield"></i>
                </div>
                <div class="admin-details">
                    <span class="admin-name" id="admin-name">Admin</span>
                    <span class="admin-role">Administrateur</span>
                </div>
            </div>
            <button class="btn-logout" id="admin-logout">
                <i class="fas fa-sign-out-alt"></i>
                <span>Déconnexion</span>
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="admin-main">
        <header class="admin-header">
            <div class="header-left">
                <button class="mobile-menu-toggle" id="mobile-menu-toggle">
                    <i class="fas fa-bars"></i>
                </button>
                <h1>Gestion des Places</h1>
            </div>
        </header>

        <div class="admin-content">
            <!-- Stats -->
            <section class="dashboard-stats">
                <div class="stat-card-admin">
                    <div class="stat-card-icon blue">
                        <i class="fas fa-parking"></i>
                    </div>
                    <div class="stat-card-info">
                        <h3 id="stat-total">0</h3>
                        <p>Total</p>
                    </div>
                </div>
                <div class="stat-card-admin">
                    <div class="stat-card-icon green">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="stat-card-info">
                        <h3 id="stat-available">0</h3>
                        <p>Disponibles</p>
                    </div>
                </div>
                <div class="stat-card-admin">
                    <div class="stat-card-icon orange">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stat-card-info">
                        <h3 id="stat-reserved">0</h3>
                        <p>Réservées</p>
                    </div>
                </div>
                <div class="stat-card-admin">
                    <div class="stat-card-icon red">
                        <i class="fas fa-car"></i>
                    </div>
                    <div class="stat-card-info">
                        <h3 id="stat-occupied">0</h3>
                        <p>Occupées</p>
                    </div>
                </div>
            </section>

            <!-- Filters -->
            <div class="filters-bar">
                <div class="filter-group">
                    <label>Filtrer par statut:</label>
                    <select id="filter-status" onchange="filterSpots()">
                        <option value="all">Tous</option>
                        <option value="available">Disponibles</option>
                        <option value="reserved">Réservées</option>
                        <option value="occupied">Occupées</option>
                    </select>
                </div>
                <div style="flex: 1;"></div>
                <button class="btn btn-success" onclick="addNewSpot()">
                    <i class="fas fa-plus"></i> Ajouter une place
                </button>
                <button class="btn btn-primary" onclick="resetAllSpots()">
                    <i class="fas fa-sync"></i> Réinitialiser tout
                </button>
            </div>

            <!-- Parking Grid -->
            <div class="dashboard-card full-width">
                <div class="card-header">
                    <h3><i class="fas fa-map"></i> Plan du Parking</h3>
                    <span id="spots-count">0 places</span>
                </div>
                <div class="card-body">
                    <div class="parking-overview" id="parking-grid" style="gap: 0.75rem;">
                        <!-- Généré par JavaScript -->
                    </div>
                    <div class="map-legend" style="margin-top: 1.5rem;">
                        <div class="legend-item">
                            <span class="legend-color available"></span>
                            <span>Disponible (cliquez pour changer)</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-color occupied"></span>
                            <span>Occupée</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-color reserved"></span>
                            <span>Réservée</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Spots Table -->
            <div class="dashboard-card full-width">
                <div class="card-header">
                    <h3><i class="fas fa-list"></i> Liste des Places</h3>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Numéro</th>
                                    <th>Capteur ESP8266</th>
                                    <th>Statut</th>
                                    <th>Réservé par</th>
                                    <th>Temps restant</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="spots-table">
                                <tr>
                                    <td colspan="7" class="text-center">Chargement...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal Changer Statut -->
    <div class="admin-modal" id="status-modal">
        <div class="admin-modal-content">
            <div class="modal-header">
                <h3>Modifier le statut</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p>Place sélectionnée: <strong id="modal-spot-id">-</strong></p>
                <div class="form-group" style="margin-top: 1rem;">
                    <label>Nouveau statut:</label>
                    <select id="new-status" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: var(--radius-md); margin-top: 0.5rem;">
                        <option value="available">Disponible</option>
                        <option value="occupied">Occupée</option>
                        <option value="reserved">Réservée</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal()">Annuler</button>
                <button class="btn btn-primary" onclick="saveSpotStatus()">Enregistrer</button>
            </div>
        </div>
    </div>

    <!-- AeroPark API Services -->
    <script src="../js/api.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/admin.js"></script>
    <script>
        var currentSpotId = null;
        var allPlaces = [];

        document.addEventListener('DOMContentLoaded', function() {
            if (!Auth.isLoggedIn() || !Auth.isAdmin()) {
                window.location.href = 'login.html';
                return;
            }

            loadStats();
            loadParkingGrid();
            loadSpotsTable();
            Admin.initSidebar();

            var admin = Auth.getUser();
            if (admin) {
                document.getElementById('admin-name').textContent = admin.name || admin.email;
            }
        });

        function loadStats() {
            API.getParkingStatus().then(function(status) {
                document.getElementById('stat-total').textContent = status.total || 0;
                // Backend returns: free, reserved, occupied counts
                document.getElementById('stat-available').textContent = status.free || 0;
                document.getElementById('stat-reserved').textContent = status.reserved || 0;
                document.getElementById('stat-occupied').textContent = status.occupied || 0;
            }).catch(function(error) {
                console.error('Erreur chargement stats:', error);
            });
        }

        function loadParkingGrid() {
            var container = document.getElementById('parking-grid');
            // Use getParkingStatus which returns { places: [...] }
            API.getParkingStatus().then(function(response) {
                allPlaces = response.places || [];
                var spots = getFilteredSpots();

                document.getElementById('spots-count').textContent = spots.length + ' places';

                var html = '';
                for (var i = 0; i < spots.length; i++) {
                    var spot = spots[i];
                    // Backend uses 'etat': free, reserved, occupied
                    var status = spot.etat || spot.status || 'free';
                    var statusClass = status === 'free' ? 'available' : status;
                    html += '<div class="parking-spot-admin ' + statusClass + '" ' +
                            'onclick="openStatusModal(\'' + spot.id + '\')" ' +
                            'title="Place ' + spot.id + ' - ' + status + '" ' +
                            'style="width: 55px; height: 55px; font-size: 0.8rem;">' +
                            spot.id + '</div>';
                }
                container.innerHTML = html;
            }).catch(function(error) {
                console.error('Erreur chargement grille:', error);
                container.innerHTML = '<p class="text-muted">Erreur de chargement</p>';
            });
        }

        function loadSpotsTable() {
            var spots = getFilteredSpots();
            var tbody = document.getElementById('spots-table');

            if (spots.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">Aucune place trouvée</td></tr>';
                return;
            }

            var html = '';
            for (var i = 0; i < spots.length; i++) {
                var spot = spots[i];
                // Backend uses 'etat': free, reserved, occupied
                var status = spot.etat || spot.status || 'free';
                var statusClass = status === 'free' ? 'success' : 
                                  status === 'reserved' ? 'warning' : 'danger';
                var statusText = status === 'free' ? 'Disponible' : 
                                 status === 'reserved' ? 'Réservée' : 'Occupée';
                
                // Calculer le temps restant
                var remainingTimeText = '-';
                var endTime = spot.reservation_end_time || spot.end_time;
                if ((status === 'reserved' || status === 'occupied') && endTime) {
                    var now = new Date();
                    var diffMs = endTime - now;
                    if (diffMs > 0) {
                        var hours = Math.floor(diffMs / (1000 * 60 * 60));
                        var minutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
                        if (hours >= 24) {
                            var days = Math.floor(hours / 24);
                            var hrs = hours % 24;
                            remainingTimeText = days + 'j ' + hrs + 'h ' + minutes + 'm';
                        } else {
                            remainingTimeText = hours + 'h ' + minutes + 'm';
                        }
                    } else {
                        remainingTimeText = '<span style="color: var(--danger-color);">Expirée</span>';
                    }
                }

                // Indicateur capteur
                var sensorStatus = spot.sensor_detected ? 
                    '<span class="sensor-status active"><i class="fas fa-wifi"></i> Détecté</span>' :
                    '<span class="sensor-status inactive"><i class="fas fa-wifi"></i> Libre</span>';
                
                html += '<tr>' +
                        '<td><strong>' + spot.id + '</strong></td>' +
                        '<td>' + (spot.number || spot.id) + '</td>' +
                        '<td>' + sensorStatus + '</td>' +
                        '<td><span class="badge ' + statusClass + '">' + statusText + '</span></td>' +
                        '<td>' + (spot.reserved_by || spot.user_email || '-') + '</td>' +
                        '<td class="countdown-cell" data-spot="' + spot.id + '">' + remainingTimeText + '</td>' +
                        '<td>' +
                            '<button class="btn-icon edit" onclick="openStatusModal(\'' + spot.id + '\')" title="Modifier">' +
                                '<i class="fas fa-edit"></i>' +
                            '</button>';
                
                if (status !== 'free') {
                    html += '<button class="btn-icon warning" onclick="freeSpot(\'' + spot.id + '\')" title="Libérer">' +
                                '<i class="fas fa-unlock"></i>' +
                            '</button>';
                }
                
                html += '</td></tr>';
            }
            tbody.innerHTML = html;
        }

        function getFilteredSpots() {
            var spots = allPlaces || [];
            var statusFilter = document.getElementById('filter-status').value;

            if (statusFilter !== 'all') {
                var filtered = [];
                // Map filter values to backend values
                var backendStatus = statusFilter === 'available' ? 'free' : statusFilter;
                for (var i = 0; i < spots.length; i++) {
                    var spotStatus = spots[i].etat || spots[i].status;
                    if (spotStatus === backendStatus) {
                        filtered.push(spots[i]);
                    }
                }
                spots = filtered;
            }

            return spots;
        }

        function filterSpots() {
            loadParkingGrid();
            loadSpotsTable();
        }

        function openStatusModal(spotId) {
            currentSpotId = spotId;
            var spot = null;
            for (var i = 0; i < allPlaces.length; i++) {
                if (allPlaces[i].id === spotId) {
                    spot = allPlaces[i];
                    break;
                }
            }
            
            document.getElementById('modal-spot-id').textContent = spotId;
            // Backend uses 'etat': free, reserved, occupied - map to dropdown values
            var spotStatus = spot ? (spot.etat || spot.status || 'free') : 'free';
            var dropdownValue = spotStatus === 'free' ? 'available' : spotStatus;
            document.getElementById('new-status').value = dropdownValue;
            document.getElementById('status-modal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('status-modal').classList.remove('active');
            currentSpotId = null;
        }

        function saveSpotStatus() {
            if (!currentSpotId) return;

            var newStatus = document.getElementById('new-status').value;
            var spotId = currentSpotId;
            
            if (newStatus === 'available') {
                API.forceRelease(spotId).then(function() {
                    closeModal();
                    loadStats();
                    loadParkingGrid();
                    loadSpotsTable();
                    Admin.showNotification('Place ' + spotId + ' mise à jour');
                }).catch(function(error) {
                    console.error('Erreur mise à jour place:', error);
                    Admin.showNotification('Erreur lors de la mise à jour', 'error');
                });
            } else {
                closeModal();
                Admin.showNotification('Place ' + spotId + ' mise à jour');
            }
        }

        function freeSpot(spotId) {
            if (confirm('Voulez-vous libérer la place ' + spotId + ' ?')) {
                API.forceRelease(spotId).then(function() {
                    loadStats();
                    loadParkingGrid();
                    loadSpotsTable();
                    Admin.showNotification('Place ' + spotId + ' libérée');
                }).catch(function(error) {
                    console.error('Erreur libération place:', error);
                    Admin.showNotification('Erreur lors de la libération', 'error');
                });
            }
        }

        function resetAllSpots() {
            if (confirm('Voulez-vous réinitialiser toutes les places ? Cette action est irréversible.')) {
                var promises = [];
                for (var i = 0; i < allPlaces.length; i++) {
                    var spot = allPlaces[i];
                    // Backend uses 'etat': free, reserved, occupied
                    var spotStatus = spot.etat || spot.status || 'free';
                    if (spotStatus !== 'free') {
                        promises.push(API.forceRelease(spot.id));
                    }
                }
                
                Promise.all(promises).then(function() {
                    loadStats();
                    loadParkingGrid();
                    loadSpotsTable();
                    Admin.showNotification('Toutes les places ont été réinitialisées');
                }).catch(function(error) {
                    console.error('Erreur réinitialisation:', error);
                    Admin.showNotification('Erreur lors de la réinitialisation', 'error');
                });
            }
        }

        // Ajouter une nouvelle place
        function addNewSpot() {
            Admin.showNotification('L\'ajout de places se fait via le backend', 'error');
        }

        // Supprimer une place
        function removeSpot(spotId) {
            Admin.showNotification('La suppression de places se fait via le backend', 'error');
        }

        // Mise à jour automatique des compteurs
        setInterval(function() {
            loadStats();
            loadParkingGrid();
            loadSpotsTable();
        }, 30000);
    </script>
</body>
</html>

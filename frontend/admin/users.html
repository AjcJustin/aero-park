<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Utilisateurs - Admin AeroPark GOMA</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/admin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="admin-page">
    <!-- Sidebar -->
    <aside class="admin-sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">
                <img src="../logo/aeropark-logo.png" alt="AeroPark" style="height: 35px; width: auto;">
                <span>AeroPark GOMA</span>
            </div>
            <button class="sidebar-toggle" id="sidebar-toggle">
                <i class="fas fa-bars"></i>
            </button>
        </div>

        <nav class="sidebar-nav">
            <ul>
                <li>
                    <a href="dashboard.html">
                        <i class="fas fa-tachometer-alt"></i>
                        <span>Tableau de bord</span>
                    </a>
                </li>
                <li>
                    <a href="places.html">
                        <i class="fas fa-parking"></i>
                        <span>Gestion des places</span>
                    </a>
                </li>
                <li>
                    <a href="reservations.html">
                        <i class="fas fa-calendar-check"></i>
                        <span>Réservations</span>
                    </a>
                </li>
                <li class="active">
                    <a href="users.html">
                        <i class="fas fa-users"></i>
                        <span>Utilisateurs</span>
                    </a>
                </li>
                <li>
                    <a href="payments.html">
                        <i class="fas fa-money-bill-wave"></i>
                        <span>Paiements</span>
                    </a>
                </li>
                <li>
                    <a href="settings.html">
                        <i class="fas fa-cog"></i>
                        <span>Paramètres</span>
                    </a>
                </li>
            </ul>
        </nav>

        <div class="sidebar-footer">
            <div class="admin-info">
                <div class="admin-avatar">
                    <i class="fas fa-user-shield"></i>
                </div>
                <div class="admin-details">
                    <span class="admin-name" id="admin-name">Admin</span>
                    <span class="admin-role">Administrateur</span>
                </div>
            </div>
            <button class="btn-logout" id="admin-logout">
                <i class="fas fa-sign-out-alt"></i>
                <span>Déconnexion</span>
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="admin-main">
        <header class="admin-header">
            <div class="header-left">
                <button class="mobile-menu-toggle" id="mobile-menu-toggle">
                    <i class="fas fa-bars"></i>
                </button>
                <h1>Gestion des Utilisateurs</h1>
            </div>
        </header>

        <div class="admin-content">
            <!-- Stats -->
            <section class="dashboard-stats">
                <div class="stat-card-admin">
                    <div class="stat-card-icon purple">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-card-info">
                        <h3 id="stat-total">0</h3>
                        <p>Total utilisateurs</p>
                    </div>
                </div>
                <div class="stat-card-admin">
                    <div class="stat-card-icon green">
                        <i class="fas fa-user-check"></i>
                    </div>
                    <div class="stat-card-info">
                        <h3 id="stat-active">0</h3>
                        <p>Actifs</p>
                    </div>
                </div>
                <div class="stat-card-admin">
                    <div class="stat-card-icon red">
                        <i class="fas fa-user-slash"></i>
                    </div>
                    <div class="stat-card-info">
                        <h3 id="stat-blocked">0</h3>
                        <p>Bloqués</p>
                    </div>
                </div>
            </section>

            <!-- Filters -->
            <div class="filters-bar">
                <div class="filter-group">
                    <label>Rechercher:</label>
                    <input type="text" id="search-user" placeholder="Nom ou email..." oninput="filterUsers()">
                </div>
                <div class="filter-group">
                    <label>Statut:</label>
                    <select id="filter-status" onchange="filterUsers()">
                        <option value="all">Tous</option>
                        <option value="active">Actifs</option>
                        <option value="blocked">Bloqués</option>
                    </select>
                </div>
                <div style="flex: 1;"></div>
                <button class="btn btn-outline" onclick="exportUsers()">
                    <i class="fas fa-download"></i> Exporter
                </button>
            </div>

            <!-- Users Table -->
            <div class="dashboard-card full-width">
                <div class="card-header">
                    <h3><i class="fas fa-users"></i> Liste des Utilisateurs</h3>
                    <span id="users-count">0 utilisateurs</span>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Nom</th>
                                    <th>Email</th>
                                    <th>Date inscription</th>
                                    <th>Réservations</th>
                                    <th>Statut</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="users-table">
                                <tr>
                                    <td colspan="7" class="text-center">Chargement...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal Détails Utilisateur -->
    <div class="admin-modal" id="user-modal">
        <div class="admin-modal-content">
            <div class="modal-header">
                <h3>Détails de l'utilisateur</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="user-details">
                <!-- Contenu généré par JavaScript -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal()">Fermer</button>
            </div>
        </div>
    </div>

    <!-- AeroPark API Services -->
    <script src="../js/api.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/admin.js"></script>
    <script>
        var allUsers = [];
        var allReservations = [];

        document.addEventListener('DOMContentLoaded', function() {
            if (!Auth.isLoggedIn() || !Auth.isAdmin()) {
                window.location.href = 'login.html';
                return;
            }

            loadStats().then(function() {
                return loadUsersTable();
            }).then(function() {
                Admin.initSidebar();

                var admin = Auth.getUser();
                if (admin) {
                    document.getElementById('admin-name').textContent = admin.username || admin.name || admin.email;
                }
            }).catch(function(error) {
                console.error('Erreur lors du chargement:', error);
                Admin.showNotification('Erreur lors du chargement des données', 'error');
            });
        });

        function loadStats() {
            // Backend doesn't have a dedicated users endpoint
            // Extract users from reservations data
            return API.getAdminReservations().then(function(response) {
                allReservations = response.reservations || response || [];
                
                // Extract unique users from reservations
                var usersMap = {};
                for (var i = 0; i < allReservations.length; i++) {
                    var r = allReservations[i];
                    var userId = r.user_id || r.userId;
                    if (userId && !usersMap[userId]) {
                        usersMap[userId] = {
                            id: userId,
                            email: r.user_email || 'utilisateur@email.com',
                            name: r.user_name || r.user_email || 'Utilisateur',
                            created_at: r.created_at || r.createdAt,
                            blocked: false
                        };
                    }
                }
                allUsers = Object.values(usersMap);
                
                var total = allUsers.length;
                var active = allUsers.filter(function(u) { return !u.blocked && !u.disabled; }).length;
                var blocked = allUsers.filter(function(u) { return u.blocked || u.disabled; }).length;
                
                document.getElementById('stat-total').textContent = total;
                document.getElementById('stat-active').textContent = active;
                document.getElementById('stat-blocked').textContent = blocked;
            }).catch(function(error) {
                console.error('Erreur chargement stats:', error);
            });
        }

        function loadUsersTable() {
            var users = getFilteredUsers();
            var tbody = document.getElementById('users-table');

            document.getElementById('users-count').textContent = users.length + ' utilisateurs';

            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">Aucun utilisateur trouvé</td></tr>';
                return Promise.resolve();
            }

            var html = '';
            for (var i = 0; i < users.length; i++) {
                var user = users[i];
                var userReservations = allReservations.filter(function(r) { return r.user_id === user.id || r.userId === user.id; });
                var isBlocked = user.blocked || user.disabled;
                var statusClass = isBlocked ? 'danger' : 'success';
                var statusText = isBlocked ? 'Bloqué' : 'Actif';
                var userName = user.name || user.display_name || user.email;
                var userId = user.id || '';
                
                html += '<tr>';
                html += '<td>#' + userId.slice(-6) + '</td>';
                html += '<td><strong>' + userName + '</strong></td>';
                html += '<td>' + user.email + '</td>';
                html += '<td>' + Admin.formatDate(user.created_at || user.createdAt || new Date()) + '</td>';
                html += '<td>' + userReservations.length + '</td>';
                html += '<td><span class="badge ' + statusClass + '">' + statusText + '</span></td>';
                html += '<td>';
                html += '<button class="btn-icon view" onclick="viewUser(\'' + user.id + '\')" title="Voir">';
                html += '<i class="fas fa-eye"></i>';
                html += '</button>';
                if (isBlocked) {
                    html += '<button class="btn-icon edit" onclick="unblockUser(\'' + user.id + '\')" title="Débloquer">';
                    html += '<i class="fas fa-unlock"></i>';
                    html += '</button>';
                } else {
                    html += '<button class="btn-icon delete" onclick="blockUser(\'' + user.id + '\')" title="Bloquer">';
                    html += '<i class="fas fa-ban"></i>';
                    html += '</button>';
                }
                html += '<button class="btn-icon delete" onclick="deleteUser(\'' + user.id + '\')" title="Supprimer">';
                html += '<i class="fas fa-trash"></i>';
                html += '</button>';
                html += '</td>';
                html += '</tr>';
            }
            tbody.innerHTML = html;
            return Promise.resolve();
        }

        function getFilteredUsers() {
            var users = allUsers || [];
            var search = document.getElementById('search-user').value.toLowerCase();
            var status = document.getElementById('filter-status').value;

            if (search) {
                users = users.filter(function(u) {
                    var name = (u.name || u.display_name || '').toLowerCase();
                    var email = (u.email || '').toLowerCase();
                    return name.includes(search) || email.includes(search);
                });
            }

            if (status === 'active') {
                users = users.filter(function(u) { return !u.blocked && !u.disabled; });
            } else if (status === 'blocked') {
                users = users.filter(function(u) { return u.blocked || u.disabled; });
            }

            return users;
        }

        function filterUsers() {
            loadUsersTable();
        }

        function viewUser(userId) {
            var user = allUsers.find(function(u) { return u.id === userId; });
            if (!user) {
                Admin.showNotification('Utilisateur introuvable', 'error');
                return;
            }
            
            var reservations = allReservations.filter(function(r) { return r.user_id === userId || r.userId === userId; });
            var totalSpent = reservations.reduce(function(sum, r) { return sum + (r.amount || (r.duration || 1) * 1000); }, 0);
            var userName = user.name || user.display_name || user.email;
            var isBlocked = user.blocked || user.disabled;

            var detailsHtml = '<div style="margin-bottom: 1.5rem;">';
            detailsHtml += '<div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">';
            detailsHtml += '<div style="width: 60px; height: 60px; background: var(--primary-color); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem;">';
            detailsHtml += '<i class="fas fa-user"></i>';
            detailsHtml += '</div>';
            detailsHtml += '<div>';
            detailsHtml += '<h4 style="margin: 0;">' + userName + '</h4>';
            detailsHtml += '<p style="margin: 0; color: var(--text-secondary);">' + user.email + '</p>';
            detailsHtml += '</div>';
            detailsHtml += '</div>';
            detailsHtml += '</div>';
            
            detailsHtml += '<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1.5rem;">';
            detailsHtml += '<div style="background: var(--bg-color); padding: 1rem; border-radius: var(--radius-md);">';
            detailsHtml += '<p style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 0.25rem;">Inscrit le</p>';
            detailsHtml += '<strong>' + Admin.formatDate(user.created_at || user.createdAt || new Date()) + '</strong>';
            detailsHtml += '</div>';
            detailsHtml += '<div style="background: var(--bg-color); padding: 1rem; border-radius: var(--radius-md);">';
            detailsHtml += '<p style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 0.25rem;">Statut</p>';
            detailsHtml += '<span class="badge ' + (isBlocked ? 'danger' : 'success') + '">' + (isBlocked ? 'Bloqué' : 'Actif') + '</span>';
            detailsHtml += '</div>';
            detailsHtml += '<div style="background: var(--bg-color); padding: 1rem; border-radius: var(--radius-md);">';
            detailsHtml += '<p style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 0.25rem;">Réservations</p>';
            detailsHtml += '<strong>' + reservations.length + '</strong>';
            detailsHtml += '</div>';
            detailsHtml += '<div style="background: var(--bg-color); padding: 1rem; border-radius: var(--radius-md);">';
            detailsHtml += '<p style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 0.25rem;">Total dépensé</p>';
            detailsHtml += '<strong>' + totalSpent.toLocaleString('fr-FR') + ' FC</strong>';
            detailsHtml += '</div>';
            detailsHtml += '</div>';

            if (reservations.length > 0) {
                detailsHtml += '<h5 style="margin-bottom: 0.75rem;">Dernières réservations</h5>';
                detailsHtml += '<table class="admin-table" style="font-size: 0.9rem;">';
                detailsHtml += '<thead><tr><th>Place</th><th>Date</th><th>Statut</th></tr></thead>';
                detailsHtml += '<tbody>';
                var recentReservations = reservations.slice(-5).reverse();
                for (var i = 0; i < recentReservations.length; i++) {
                    var r = recentReservations[i];
                    detailsHtml += '<tr>';
                    detailsHtml += '<td>' + (r.place_id || r.spotId) + '</td>';
                    detailsHtml += '<td>' + Admin.formatDate(r.created_at || r.createdAt) + '</td>';
                    detailsHtml += '<td><span class="badge ' + (r.status === 'active' ? 'success' : 'secondary') + '">' + r.status + '</span></td>';
                    detailsHtml += '</tr>';
                }
                detailsHtml += '</tbody></table>';
            } else {
                detailsHtml += '<p class="text-muted">Aucune réservation</p>';
            }

            document.getElementById('user-details').innerHTML = detailsHtml;
            document.getElementById('user-modal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('user-modal').classList.remove('active');
        }

        function blockUser(userId) {
            var user = allUsers.find(function(u) { return u.id === userId; });
            var userName = user ? (user.name || user.display_name || user.email) : userId;
            if (confirm('Voulez-vous bloquer l\'utilisateur "' + userName + '" ?')) {
                API.blockUser(userId).then(function() {
                    return loadStats();
                }).then(function() {
                    return loadUsersTable();
                }).then(function() {
                    Admin.showNotification('Utilisateur bloqué');
                }).catch(function(error) {
                    console.error('Erreur blocage:', error);
                    Admin.showNotification('Erreur lors du blocage', 'error');
                });
            }
        }

        function unblockUser(userId) {
            API.unblockUser(userId).then(function() {
                return loadStats();
            }).then(function() {
                return loadUsersTable();
            }).then(function() {
                Admin.showNotification('Utilisateur débloqué');
            }).catch(function(error) {
                console.error('Erreur déblocage:', error);
                Admin.showNotification('Erreur lors du déblocage', 'error');
            });
        }

        function deleteUser(userId) {
            var user = allUsers.find(function(u) { return u.id === userId; });
            var userName = user ? (user.name || user.display_name || user.email) : userId;
            if (confirm('Voulez-vous supprimer définitivement l\'utilisateur "' + userName + '" ?')) {
                API.deleteUser(userId).then(function() {
                    return loadStats();
                }).then(function() {
                    return loadUsersTable();
                }).then(function() {
                    Admin.showNotification('Utilisateur supprimé');
                }).catch(function(error) {
                    console.error('Erreur suppression:', error);
                    Admin.showNotification('Erreur lors de la suppression', 'error');
                });
            }
        }

        function exportUsers() {
            var users = [];
            var allUsersList = allUsers || [];
            for (var i = 0; i < allUsersList.length; i++) {
                var u = allUsersList[i];
                users.push({
                    id: u.id,
                    name: u.name || u.display_name || '',
                    email: u.email,
                    createdAt: u.created_at || u.createdAt,
                    status: (u.blocked || u.disabled) ? 'Bloqué' : 'Actif'
                });
            }
            Admin.exportToCSV(users, 'utilisateurs_aeropark.csv');
            Admin.showNotification('Export terminé');
        }
    </script>
</body>
</html>

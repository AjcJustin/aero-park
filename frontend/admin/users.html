<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Utilisateurs - Admin AeroPark GOMA</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/admin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="admin-page">
    <!-- Sidebar -->
    <aside class="admin-sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">
                <i class="fas fa-plane"></i>
                <span>AeroPark GOMA</span>
            </div>
            <button class="sidebar-toggle" id="sidebar-toggle">
                <i class="fas fa-bars"></i>
            </button>
        </div>

        <nav class="sidebar-nav">
            <ul>
                <li>
                    <a href="dashboard.html">
                        <i class="fas fa-tachometer-alt"></i>
                        <span>Tableau de bord</span>
                    </a>
                </li>
                <li>
                    <a href="places.html">
                        <i class="fas fa-parking"></i>
                        <span>Gestion des places</span>
                    </a>
                </li>
                <li>
                    <a href="reservations.html">
                        <i class="fas fa-calendar-check"></i>
                        <span>R√©servations</span>
                    </a>
                </li>
                <li class="active">
                    <a href="users.html">
                        <i class="fas fa-users"></i>
                        <span>Utilisateurs</span>
                    </a>
                </li>
                <li>
                    <a href="payments.html">
                        <i class="fas fa-money-bill-wave"></i>
                        <span>Paiements</span>
                    </a>
                </li>
                <li>
                    <a href="settings.html">
                        <i class="fas fa-cog"></i>
                        <span>Param√®tres</span>
                    </a>
                </li>
            </ul>
        </nav>

        <div class="sidebar-footer">
            <div class="admin-info">
                <div class="admin-avatar">
                    <i class="fas fa-user-shield"></i>
                </div>
                <div class="admin-details">
                    <span class="admin-name" id="admin-name">Admin</span>
                    <span class="admin-role">Administrateur</span>
                </div>
            </div>
            <button class="btn-logout" id="admin-logout">
                <i class="fas fa-sign-out-alt"></i>
                <span>D√©connexion</span>
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="admin-main">
        <header class="admin-header">
            <div class="header-left">
                <button class="mobile-menu-toggle" id="mobile-menu-toggle">
                    <i class="fas fa-bars"></i>
                </button>
                <h1>Gestion des Utilisateurs</h1>
            </div>
        </header>

        <div class="admin-content">
            <!-- Stats -->
            <section class="dashboard-stats">
                <div class="stat-card-admin">
                    <div class="stat-card-icon purple">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-card-info">
                        <h3 id="stat-total">0</h3>
                        <p>Total utilisateurs</p>
                    </div>
                </div>
                <div class="stat-card-admin">
                    <div class="stat-card-icon green">
                        <i class="fas fa-user-check"></i>
                    </div>
                    <div class="stat-card-info">
                        <h3 id="stat-active">0</h3>
                        <p>Actifs</p>
                    </div>
                </div>
                <div class="stat-card-admin">
                    <div class="stat-card-icon red">
                        <i class="fas fa-user-slash"></i>
                    </div>
                    <div class="stat-card-info">
                        <h3 id="stat-blocked">0</h3>
                        <p>Bloqu√©s</p>
                    </div>
                </div>
            </section>

            <!-- Filters -->
            <div class="filters-bar">
                <div class="filter-group">
                    <label>Rechercher:</label>
                    <input type="text" id="search-user" placeholder="Nom ou email..." oninput="filterUsers()">
                </div>
                <div class="filter-group">
                    <label>Statut:</label>
                    <select id="filter-status" onchange="filterUsers()">
                        <option value="all">Tous</option>
                        <option value="active">Actifs</option>
                        <option value="blocked">Bloqu√©s</option>
                    </select>
                </div>
                <div style="flex: 1;"></div>
                <button class="btn btn-outline" onclick="exportUsers()">
                    <i class="fas fa-download"></i> Exporter
                </button>
            </div>

            <!-- Users Table -->
            <div class="dashboard-card full-width">
                <div class="card-header">
                    <h3><i class="fas fa-users"></i> Liste des Utilisateurs</h3>
                    <span id="users-count">0 utilisateurs</span>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Nom</th>
                                    <th>Email</th>
                                    <th>Date inscription</th>
                                    <th>R√©servations</th>
                                    <th>Statut</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="users-table">
                                <tr>
                                    <td colspan="7" class="text-center">Chargement...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal D√©tails Utilisateur -->
    <div class="admin-modal" id="user-modal">
        <div class="admin-modal-content">
            <div class="modal-header">
                <h3>D√©tails de l'utilisateur</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="user-details">
                <!-- Contenu g√©n√©r√© par JavaScript -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal()">Fermer</button>
            </div>
        </div>
    </div>

    <script src="../js/data.js"></script>
    <script src="../js/admin.js"></script>
    <script src="../js/services/api.js"></script>
    <script>
        // V√©rifier l'authentification
        if (!AdminAuth.isLoggedIn()) {
            window.location.href = 'login.html';
        }

        let allUsers = [];

        document.addEventListener('DOMContentLoaded', async function() {
            await loadAllData();
            initSidebar();

            const admin = AdminAuth.getCurrentAdmin();
            if (admin) {
                document.getElementById('admin-name').textContent = admin.username;
            }
        });

        async function loadAllData() {
            await loadStats();
            loadUsersTable();
        }

        async function loadStats() {
            try {
                const response = await ApiService.getAllUsers();
                allUsers = response.users || response || [];
                
                const total = allUsers.length;
                const active = allUsers.filter(u => u.status === 'active' || !u.blocked).length;
                const blocked = allUsers.filter(u => u.status === 'disabled' || u.blocked).length;
                
                document.getElementById('stat-total').textContent = total;
                document.getElementById('stat-active').textContent = active;
                document.getElementById('stat-blocked').textContent = blocked;
            } catch (error) {
                console.error('Erreur lors du chargement des statistiques:', error);
                AdminUtils.showNotification('Erreur lors du chargement des donn√©es: ' + error.message, 'error');
            }
        }

        function loadUsersTable() {
            const users = getFilteredUsers();
            const tbody = document.getElementById('users-table');

            document.getElementById('users-count').textContent = users.length + ' utilisateurs';

            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">Aucun utilisateur trouv√©</td></tr>';
                return;
            }

            tbody.innerHTML = users.map(user => {
                const isBlocked = user.status === 'disabled' || user.blocked;
                const statusClass = isBlocked ? 'danger' : 'success';
                const statusText = isBlocked ? 'Bloqu√©' : 'Actif';
                
                return `
                    <tr>
                        <td>#${(user.id || user.uid || '').slice(-6)}</td>
                        <td><strong>${user.name || user.display_name || 'N/A'}</strong></td>
                        <td>${user.email || '-'}</td>
                        <td>${AdminUtils.formatDate(user.created_at || user.createdAt)}</td>
                        <td>${user.reservation_count || 0}</td>
                        <td><span class="badge ${statusClass}">${statusText}</span></td>
                        <td>
                            <button class="btn-icon view" onclick="viewUser('${user.id || user.uid}')" title="Voir">
                                <i class="fas fa-eye"></i>
                            </button>
                            ${isBlocked ? `
                                <button class="btn-icon edit" onclick="unblockUser('${user.id || user.uid}')" title="D√©bloquer">
                                    <i class="fas fa-unlock"></i>
                                </button>
                            ` : `
                                <button class="btn-icon delete" onclick="blockUser('${user.id || user.uid}')" title="Bloquer">
                                    <i class="fas fa-ban"></i>
                                </button>
                            `}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function getFilteredUsers() {
            let users = [...allUsers];
            const search = document.getElementById('search-user').value.toLowerCase();
            const status = document.getElementById('filter-status').value;

            if (search) {
                users = users.filter(u => 
                    (u.name || u.display_name || '').toLowerCase().includes(search) || 
                    (u.email || '').toLowerCase().includes(search)
                );
            }

            if (status === 'active') {
                users = users.filter(u => u.status === 'active' || !u.blocked);
            } else if (status === 'blocked') {
                users = users.filter(u => u.status === 'disabled' || u.blocked);
            }

            return users;
        }

        function filterUsers() {
            loadUsersTable();
        }

        function viewUser(userId) {
            const user = allUsers.find(u => (u.id || u.uid) === userId);
            if (!user) return;
            
            const isBlocked = user.status === 'disabled' || user.blocked;
            const totalSpent = user.total_spent || 0;

            document.getElementById('user-details').innerHTML = `
                <div style="margin-bottom: 1.5rem;">
                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                        <div style="width: 60px; height: 60px; background: var(--primary-color); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem;">
                            <i class="fas fa-user"></i>
                        </div>
                        <div>
                            <h4 style="margin: 0;">${user.name || user.display_name || 'N/A'}</h4>
                            <p style="margin: 0; color: var(--text-secondary);">${user.email || '-'}</p>
                        </div>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
                    <div style="background: var(--bg-color); padding: 1rem; border-radius: var(--radius-md);">
                        <p style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 0.25rem;">Inscrit le</p>
                        <strong>${AdminUtils.formatDate(user.created_at || user.createdAt)}</strong>
                    </div>
                    <div style="background: var(--bg-color); padding: 1rem; border-radius: var(--radius-md);">
                        <p style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 0.25rem;">Statut</p>
                        <span class="badge ${isBlocked ? 'danger' : 'success'}">${isBlocked ? 'Bloqu√©' : 'Actif'}</span>
                    </div>
                    <div style="background: var(--bg-color); padding: 1rem; border-radius: var(--radius-md);">
                        <p style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 0.25rem;">R√©servations</p>
                        <strong>${user.reservation_count || 0}</strong>
                    </div>
                    <div style="background: var(--bg-color); padding: 1rem; border-radius: var(--radius-md);">
                        <p style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 0.25rem;">Total d√©pens√©</p>
                        <strong>${totalSpent.toLocaleString('fr-FR')} FC</strong>
                    </div>
                </div>
                
                ${user.role ? `
                    <div style="background: var(--bg-color); padding: 1rem; border-radius: var(--radius-md); margin-bottom: 1rem;">
                        <p style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 0.25rem;">R√¥le</p>
                        <span class="badge ${user.role === 'admin' ? 'warning' : 'info'}">${user.role === 'admin' ? 'üëë Admin' : 'üë§ Utilisateur'}</span>
                    </div>
                ` : ''}
            `;

            document.getElementById('user-modal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('user-modal').classList.remove('active');
        }

        async function blockUser(userId) {
            const user = allUsers.find(u => (u.id || u.uid) === userId);
            if (!user) return;
            
            if (confirm(`Voulez-vous bloquer l'utilisateur "${user.name || user.email}" ?`)) {
                try {
                    await ApiService.updateUser(userId, { status: 'disabled' });
                    await loadAllData();
                    AdminUtils.showNotification('Utilisateur bloqu√©');
                } catch (error) {
                    console.error('Erreur lors du blocage:', error);
                    AdminUtils.showNotification('Erreur: ' + error.message, 'error');
                }
            }
        }

        async function unblockUser(userId) {
            try {
                await ApiService.updateUser(userId, { status: 'active' });
                await loadAllData();
                AdminUtils.showNotification('Utilisateur d√©bloqu√©');
            } catch (error) {
                console.error('Erreur lors du d√©blocage:', error);
                AdminUtils.showNotification('Erreur: ' + error.message, 'error');
            }
        }

        function exportUsers() {
            const users = allUsers.map(u => ({
                id: u.id || u.uid,
                name: u.name || u.display_name,
                email: u.email,
                created_at: u.created_at || u.createdAt,
                status: (u.status === 'disabled' || u.blocked) ? 'Bloqu√©' : 'Actif'
            }));
            AdminUtils.exportToCSV(users, 'utilisateurs_aeropark.csv');
            AdminUtils.showNotification('Export termin√©');
        }

        function initSidebar() {
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebar-toggle');
            const mobileToggle = document.getElementById('mobile-menu-toggle');

            sidebarToggle.addEventListener('click', () => sidebar.classList.toggle('collapsed'));
            mobileToggle.addEventListener('click', () => sidebar.classList.toggle('mobile-open'));
            document.getElementById('admin-logout').addEventListener('click', () => {
                AdminAuth.logout();
                window.location.href = 'login.html';
            });
        }
    </script>
</body>
</html>

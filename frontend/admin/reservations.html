<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Réservations - Admin AeroPark GOMA</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/admin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="admin-page">
    <!-- Sidebar -->
    <aside class="admin-sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">
                <i class="fas fa-plane"></i>
                <span>AeroPark GOMA</span>
            </div>
            <button class="sidebar-toggle" id="sidebar-toggle">
                <i class="fas fa-bars"></i>
            </button>
        </div>

        <nav class="sidebar-nav">
            <ul>
                <li>
                    <a href="dashboard.html">
                        <i class="fas fa-tachometer-alt"></i>
                        <span>Tableau de bord</span>
                    </a>
                </li>
                <li>
                    <a href="places.html">
                        <i class="fas fa-parking"></i>
                        <span>Gestion des places</span>
                    </a>
                </li>
                <li class="active">
                    <a href="reservations.html">
                        <i class="fas fa-calendar-check"></i>
                        <span>Réservations</span>
                    </a>
                </li>
                <li>
                    <a href="users.html">
                        <i class="fas fa-users"></i>
                        <span>Utilisateurs</span>
                    </a>
                </li>
                <li>
                    <a href="payments.html">
                        <i class="fas fa-money-bill-wave"></i>
                        <span>Paiements</span>
                    </a>
                </li>
                <li>
                    <a href="settings.html">
                        <i class="fas fa-cog"></i>
                        <span>Paramètres</span>
                    </a>
                </li>
            </ul>
        </nav>

        <div class="sidebar-footer">
            <div class="admin-info">
                <div class="admin-avatar">
                    <i class="fas fa-user-shield"></i>
                </div>
                <div class="admin-details">
                    <span class="admin-name" id="admin-name">Admin</span>
                    <span class="admin-role">Administrateur</span>
                </div>
            </div>
            <button class="btn-logout" id="admin-logout">
                <i class="fas fa-sign-out-alt"></i>
                <span>Déconnexion</span>
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="admin-main">
        <header class="admin-header">
            <div class="header-left">
                <button class="mobile-menu-toggle" id="mobile-menu-toggle">
                    <i class="fas fa-bars"></i>
                </button>
                <h1>Gestion des Réservations</h1>
            </div>
        </header>

        <div class="admin-content">
            <!-- Stats -->
            <section class="dashboard-stats">
                <div class="stat-card-admin">
                    <div class="stat-card-icon blue">
                        <i class="fas fa-calendar-check"></i>
                    </div>
                    <div class="stat-card-info">
                        <h3 id="stat-total">0</h3>
                        <p>Total réservations</p>
                    </div>
                </div>
                <div class="stat-card-admin">
                    <div class="stat-card-icon green">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stat-card-info">
                        <h3 id="stat-active">0</h3>
                        <p>En cours</p>
                    </div>
                </div>
                <div class="stat-card-admin">
                    <div class="stat-card-icon orange">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="stat-card-info">
                        <h3 id="stat-completed">0</h3>
                        <p>Terminées</p>
                    </div>
                </div>
                <div class="stat-card-admin">
                    <div class="stat-card-icon red">
                        <i class="fas fa-times-circle"></i>
                    </div>
                    <div class="stat-card-info">
                        <h3 id="stat-cancelled">0</h3>
                        <p>Annulées</p>
                    </div>
                </div>
            </section>

            <!-- Filters -->
            <div class="filters-bar">
                <div class="filter-group">
                    <label>Rechercher:</label>
                    <input type="text" id="search-reservation" placeholder="Place ou utilisateur..." oninput="filterReservations()">
                </div>
                <div class="filter-group">
                    <label>Date:</label>
                    <input type="date" id="filter-date" onchange="filterReservations()">
                </div>
                <div class="filter-group">
                    <label>Statut:</label>
                    <select id="filter-status" onchange="filterReservations()">
                        <option value="all">Tous</option>
                        <option value="active">En cours</option>
                        <option value="completed">Terminées</option>
                        <option value="cancelled">Annulées</option>
                    </select>
                </div>
                <div style="flex: 1;"></div>
                <button class="btn btn-outline" onclick="exportReservations()">
                    <i class="fas fa-download"></i> Exporter
                </button>
            </div>

            <!-- Reservations Table -->
            <div class="dashboard-card full-width">
                <div class="card-header">
                    <h3><i class="fas fa-list"></i> Liste des Réservations</h3>
                    <span id="reservations-count">0 réservations</span>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Utilisateur</th>
                                    <th>Place</th>
                                    <th>Véhicule</th>
                                    <th>Début</th>
                                    <th>Durée</th>
                                    <th>Montant</th>
                                    <th>Statut</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="reservations-table">
                                <tr>
                                    <td colspan="9" class="text-center">Chargement...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal Détails Réservation -->
    <div class="admin-modal" id="reservation-modal">
        <div class="admin-modal-content">
            <div class="modal-header">
                <h3>Détails de la réservation</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="reservation-details">
                <!-- Contenu généré par JavaScript -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal()">Fermer</button>
                <button class="btn btn-danger" id="btn-cancel-reservation" style="display: none;" onclick="cancelCurrentReservation()">
                    <i class="fas fa-times"></i> Annuler
                </button>
            </div>
        </div>
    </div>

    <script src="../js/data.js"></script>
    <script src="../js/admin.js"></script>
    <script src="../js/services/api.js"></script>
    <script>
        let currentReservationId = null;
        let allReservations = [];

        // Vérifier l'authentification
        if (!AdminAuth.isLoggedIn()) {
            window.location.href = 'login.html';
        }

        document.addEventListener('DOMContentLoaded', async function() {
            await loadAllData();
            initSidebar();

            const admin = AdminAuth.getCurrentAdmin();
            if (admin) {
                document.getElementById('admin-name').textContent = admin.username;
            }
        });

        async function loadAllData() {
            await loadStats();
            loadReservationsTable();
        }

        async function loadStats() {
            try {
                const response = await ApiService.getAllReservations();
                allReservations = response.reservations || response || [];
                
                const total = allReservations.length;
                const active = allReservations.filter(r => r.status === 'active').length;
                const completed = allReservations.filter(r => r.status === 'completed').length;
                const cancelled = allReservations.filter(r => r.status === 'cancelled').length;
                
                document.getElementById('stat-total').textContent = total;
                document.getElementById('stat-active').textContent = active;
                document.getElementById('stat-completed').textContent = completed;
                document.getElementById('stat-cancelled').textContent = cancelled;
            } catch (error) {
                console.error('Erreur lors du chargement des statistiques:', error);
                AdminUtils.showNotification('Erreur lors du chargement des données: ' + error.message, 'error');
            }
        }

        function loadReservationsTable() {
            const reservations = getFilteredReservations();
            const tbody = document.getElementById('reservations-table');

            document.getElementById('reservations-count').textContent = reservations.length + ' réservations';

            if (reservations.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">Aucune réservation trouvée</td></tr>';
                return;
            }

            tbody.innerHTML = reservations.sort((a, b) => new Date(b.created_at || b.start_time) - new Date(a.created_at || a.start_time)).map(res => {
                const userName = res.user_email || res.user_id || 'Utilisateur inconnu';
                const spotId = res.spot_id || res.place_id || '-';
                
                const statusBadges = {
                    active: '<span class="badge success">En cours</span>',
                    pending: '<span class="badge warning">En attente</span>',
                    completed: '<span class="badge secondary">Terminée</span>',
                    cancelled: '<span class="badge danger">Annulée</span>'
                };
                
                // Calculer la durée
                let duration = res.duration || 1;
                if (res.start_time && res.end_time) {
                    const diffMs = new Date(res.end_time) - new Date(res.start_time);
                    duration = Math.ceil(diffMs / (1000 * 60 * 60));
                }
                
                return `
                    <tr>
                        <td><code>#${(res.id || '').slice(-6)}</code></td>
                        <td>${userName}</td>
                        <td><strong>${spotId}</strong></td>
                        <td>${res.vehicle_plate || '-'}</td>
                        <td>${AdminUtils.formatDate(res.start_time || res.created_at)}</td>
                        <td>${duration}h</td>
                        <td><strong>${(res.amount || duration * 1000).toLocaleString('fr-FR')} FC</strong></td>
                        <td>${statusBadges[res.status] || res.status}</td>
                        <td>
                            <button class="btn-icon view" onclick="viewReservation('${res.id}')" title="Voir">
                                <i class="fas fa-eye"></i>
                            </button>
                            ${res.status === 'active' || res.status === 'pending' ? `
                                <button class="btn-icon delete" onclick="cancelReservation('${res.id}')" title="Annuler">
                                    <i class="fas fa-times"></i>
                                </button>
                            ` : ''}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function getFilteredReservations() {
            let reservations = [...allReservations];
            
            const search = document.getElementById('search-reservation').value.toLowerCase();
            const date = document.getElementById('filter-date').value;
            const status = document.getElementById('filter-status').value;

            if (search) {
                reservations = reservations.filter(r => {
                    const spotId = (r.spot_id || r.place_id || '').toLowerCase();
                    const userEmail = (r.user_email || '').toLowerCase();
                    const vehiclePlate = (r.vehicle_plate || '').toLowerCase();
                    return spotId.includes(search) || 
                           userEmail.includes(search) ||
                           vehiclePlate.includes(search);
                });
            }

            if (date) {
                reservations = reservations.filter(r => {
                    const resDate = new Date(r.created_at || r.start_time).toISOString().split('T')[0];
                    return resDate === date;
                });
            }

            if (status !== 'all') {
                reservations = reservations.filter(r => r.status === status);
            }

            return reservations;
        }

        function filterReservations() {
            loadReservationsTable();
        }

        function viewReservation(reservationId) {
            currentReservationId = reservationId;
            const reservation = allReservations.find(r => r.id === reservationId);
            if (!reservation) return;

            const spotId = reservation.spot_id || reservation.place_id || '-';
            let duration = reservation.duration || 1;
            if (reservation.start_time && reservation.end_time) {
                const diffMs = new Date(reservation.end_time) - new Date(reservation.start_time);
                duration = Math.ceil(diffMs / (1000 * 60 * 60));
            }

            const statusInfo = {
                active: { class: 'success', text: 'En cours', icon: 'fa-clock' },
                pending: { class: 'warning', text: 'En attente', icon: 'fa-hourglass-half' },
                completed: { class: 'secondary', text: 'Terminée', icon: 'fa-check-circle' },
                cancelled: { class: 'danger', text: 'Annulée', icon: 'fa-times-circle' }
            };
            const status = statusInfo[reservation.status] || statusInfo.active;

            document.getElementById('reservation-details').innerHTML = `
                <div style="text-align: center; margin-bottom: 1.5rem;">
                    <div style="width: 80px; height: 80px; background: var(--primary-color); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem; color: white; font-size: 2rem;">
                        <i class="fas fa-parking"></i>
                    </div>
                    <h3 style="margin: 0;">Place ${spotId}</h3>
                    <span class="badge ${status.class}"><i class="fas ${status.icon}"></i> ${status.text}</span>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
                    <div style="background: var(--bg-color); padding: 1rem; border-radius: var(--radius-md);">
                        <p style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 0.25rem;">
                            <i class="fas fa-user"></i> Utilisateur
                        </p>
                        <strong>${reservation.user_email || reservation.user_id || 'Inconnu'}</strong>
                    </div>
                    <div style="background: var(--bg-color); padding: 1rem; border-radius: var(--radius-md);">
                        <p style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 0.25rem;">
                            <i class="fas fa-car"></i> Véhicule
                        </p>
                        <strong>${reservation.vehicle_plate || 'Non renseigné'}</strong>
                    </div>
                    <div style="background: var(--bg-color); padding: 1rem; border-radius: var(--radius-md);">
                        <p style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 0.25rem;">
                            <i class="fas fa-calendar"></i> Date début
                        </p>
                        <strong>${AdminUtils.formatDate(reservation.start_time || reservation.created_at)}</strong>
                    </div>
                    <div style="background: var(--bg-color); padding: 1rem; border-radius: var(--radius-md);">
                        <p style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 0.25rem;">
                            <i class="fas fa-hourglass-half"></i> Durée
                        </p>
                        <strong>${duration} heure(s)</strong>
                    </div>
                </div>

                <div style="background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); padding: 1.5rem; border-radius: var(--radius-md); color: white; text-align: center; margin-bottom: 1.5rem;">
                    <p style="margin: 0 0 0.5rem; opacity: 0.9;">Montant</p>
                    <h2 style="margin: 0; font-size: 2rem;">${(reservation.amount || duration * 1000).toLocaleString('fr-FR')} FC</h2>
                </div>

                ${reservation.access_code ? `
                    <div style="background: var(--bg-color); padding: 1rem; border-radius: var(--radius-md);">
                        <p><strong>Code d'accès:</strong> <code>${reservation.access_code}</code></p>
                    </div>
                ` : ''}
            `;

            // Afficher le bouton d'annulation si réservation active
            document.getElementById('btn-cancel-reservation').style.display = 
                (reservation.status === 'active' || reservation.status === 'pending') ? 'inline-flex' : 'none';

            document.getElementById('reservation-modal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('reservation-modal').classList.remove('active');
            currentReservationId = null;
        }

        async function cancelReservation(reservationId) {
            const reservation = allReservations.find(r => r.id === reservationId);
            if (!reservation) return;
            
            const spotId = reservation.spot_id || reservation.place_id;
            if (confirm(`Voulez-vous annuler la réservation de la place ${spotId} ?`)) {
                try {
                    await ApiService.cancelReservation(reservationId);
                    await loadAllData();
                    AdminUtils.showNotification('Réservation annulée');
                } catch (error) {
                    console.error('Erreur lors de l\'annulation:', error);
                    AdminUtils.showNotification('Erreur: ' + error.message, 'error');
                }
            }
        }

        function cancelCurrentReservation() {
            if (currentReservationId) {
                cancelReservation(currentReservationId);
                closeModal();
            }
        }

        function exportReservations() {
            const reservations = getFilteredReservations().map(r => ({
                id: r.id,
                spot_id: r.spot_id || r.place_id,
                user_email: r.user_email || r.user_id,
                vehicle_plate: r.vehicle_plate || '',
                start_time: r.start_time || r.created_at,
                amount: r.amount || 1000,
                status: r.status
            }));
            AdminUtils.exportToCSV(reservations, 'reservations_aeropark.csv');
            AdminUtils.showNotification('Export terminé');
        }

        function initSidebar() {
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebar-toggle');
            const mobileToggle = document.getElementById('mobile-menu-toggle');

            sidebarToggle.addEventListener('click', () => sidebar.classList.toggle('collapsed'));
            mobileToggle.addEventListener('click', () => sidebar.classList.toggle('mobile-open'));
            document.getElementById('admin-logout').addEventListener('click', () => {
                AdminAuth.logout();
                window.location.href = 'login.html';
            });
        }
    </script>
</body>
</html>

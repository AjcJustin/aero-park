<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Réservations - Admin AeroPark GOMA</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/admin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="admin-page">
    <!-- Sidebar -->
    <aside class="admin-sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">
                <img src="../logo/aeropark-logo.png" alt="AeroPark" style="height: 35px; width: auto;">
                <span>AeroPark GOMA</span>
            </div>
            <button class="sidebar-toggle" id="sidebar-toggle">
                <i class="fas fa-bars"></i>
            </button>
        </div>

        <nav class="sidebar-nav">
            <ul>
                <li>
                    <a href="dashboard.html">
                        <i class="fas fa-tachometer-alt"></i>
                        <span>Tableau de bord</span>
                    </a>
                </li>
                <li>
                    <a href="places.html">
                        <i class="fas fa-parking"></i>
                        <span>Gestion des places</span>
                    </a>
                </li>
                <li class="active">
                    <a href="reservations.html">
                        <i class="fas fa-calendar-check"></i>
                        <span>Réservations</span>
                    </a>
                </li>
                <li>
                    <a href="users.html">
                        <i class="fas fa-users"></i>
                        <span>Utilisateurs</span>
                    </a>
                </li>
                <li>
                    <a href="payments.html">
                        <i class="fas fa-money-bill-wave"></i>
                        <span>Paiements</span>
                    </a>
                </li>
                <li>
                    <a href="settings.html">
                        <i class="fas fa-cog"></i>
                        <span>Paramètres</span>
                    </a>
                </li>
            </ul>
        </nav>

        <div class="sidebar-footer">
            <div class="admin-info">
                <div class="admin-avatar">
                    <i class="fas fa-user-shield"></i>
                </div>
                <div class="admin-details">
                    <span class="admin-name" id="admin-name">Admin</span>
                    <span class="admin-role">Administrateur</span>
                </div>
            </div>
            <button class="btn-logout" id="admin-logout">
                <i class="fas fa-sign-out-alt"></i>
                <span>Déconnexion</span>
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="admin-main">
        <header class="admin-header">
            <div class="header-left">
                <button class="mobile-menu-toggle" id="mobile-menu-toggle">
                    <i class="fas fa-bars"></i>
                </button>
                <h1>Gestion des Réservations</h1>
            </div>
        </header>

        <div class="admin-content">
            <!-- Stats -->
            <section class="dashboard-stats">
                <div class="stat-card-admin">
                    <div class="stat-card-icon blue">
                        <i class="fas fa-calendar-check"></i>
                    </div>
                    <div class="stat-card-info">
                        <h3 id="stat-total">0</h3>
                        <p>Total réservations</p>
                    </div>
                </div>
                <div class="stat-card-admin">
                    <div class="stat-card-icon green">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stat-card-info">
                        <h3 id="stat-active">0</h3>
                        <p>En cours</p>
                    </div>
                </div>
                <div class="stat-card-admin">
                    <div class="stat-card-icon orange">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="stat-card-info">
                        <h3 id="stat-completed">0</h3>
                        <p>Terminées</p>
                    </div>
                </div>
                <div class="stat-card-admin">
                    <div class="stat-card-icon red">
                        <i class="fas fa-times-circle"></i>
                    </div>
                    <div class="stat-card-info">
                        <h3 id="stat-cancelled">0</h3>
                        <p>Annulées</p>
                    </div>
                </div>
            </section>

            <!-- Filters -->
            <div class="filters-bar">
                <div class="filter-group">
                    <label>Rechercher:</label>
                    <input type="text" id="search-reservation" placeholder="Place ou utilisateur..." oninput="filterReservations()">
                </div>
                <div class="filter-group">
                    <label>Date:</label>
                    <input type="date" id="filter-date" onchange="filterReservations()">
                </div>
                <div class="filter-group">
                    <label>Statut:</label>
                    <select id="filter-status" onchange="filterReservations()">
                        <option value="all">Tous</option>
                        <option value="active">En cours</option>
                        <option value="completed">Terminées</option>
                        <option value="cancelled">Annulées</option>
                    </select>
                </div>
                <div style="flex: 1;"></div>
                <button class="btn btn-outline" onclick="exportReservations()">
                    <i class="fas fa-download"></i> Exporter
                </button>
            </div>

            <!-- Reservations Table -->
            <div class="dashboard-card full-width">
                <div class="card-header">
                    <h3><i class="fas fa-list"></i> Liste des Réservations</h3>
                    <span id="reservations-count">0 réservations</span>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Utilisateur</th>
                                    <th>Place</th>
                                    <th>Véhicule</th>
                                    <th>Début</th>
                                    <th>Durée</th>
                                    <th>Montant</th>
                                    <th>Statut</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="reservations-table">
                                <tr>
                                    <td colspan="9" class="text-center">Chargement...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal Détails Réservation -->
    <div class="admin-modal" id="reservation-modal">
        <div class="admin-modal-content">
            <div class="modal-header">
                <h3>Détails de la réservation</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="reservation-details">
                <!-- Contenu généré par JavaScript -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal()">Fermer</button>
                <button class="btn btn-danger" id="btn-cancel-reservation" style="display: none;" onclick="cancelCurrentReservation()">
                    <i class="fas fa-times"></i> Annuler
                </button>
            </div>
        </div>
    </div>

    <!-- AeroPark API Services -->
    <script src="../js/api.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/admin.js"></script>
    <script>
        var currentReservationId = null;
        var allReservations = [];
        var allUsers = [];

        document.addEventListener('DOMContentLoaded', function() {
            if (!Auth.isLoggedIn() || !Auth.isAdmin()) {
                window.location.href = 'login.html';
                return;
            }

            loadStats();
            loadReservationsTable();
            Admin.initSidebar();

            var admin = Auth.getUser();
            if (admin) {
                document.getElementById('admin-name').textContent = admin.username || admin.name || 'Admin';
            }
        });

        function loadStats() {
            API.get('/admin/parking/reservations')
                .then(function(response) {
                    allReservations = response.reservations || response || [];
                    
                    // Extract users from reservations since there's no dedicated endpoint
                    var usersMap = {};
                    for (var i = 0; i < allReservations.length; i++) {
                        var r = allReservations[i];
                        var userId = r.user_id || r.userId;
                        if (userId && !usersMap[userId]) {
                            usersMap[userId] = {
                                id: userId,
                                email: r.user_email || 'utilisateur@email.com',
                                name: r.user_name || r.user_email || 'Utilisateur'
                            };
                        }
                    }
                    allUsers = Object.values(usersMap);
                    
                    var total = allReservations.length;
                    var active = allReservations.filter(function(r) { return r.status === 'active'; }).length;
                    var completed = allReservations.filter(function(r) { return r.status === 'completed'; }).length;
                    var cancelled = allReservations.filter(function(r) { return r.status === 'cancelled'; }).length;
                    
                    document.getElementById('stat-total').textContent = total;
                    document.getElementById('stat-active').textContent = active;
                    document.getElementById('stat-completed').textContent = completed;
                    document.getElementById('stat-cancelled').textContent = cancelled;
                    
                    loadReservationsTable();
                })
                .catch(function(error) {
                    console.error('Erreur chargement stats:', error);
                });
        }

        function loadReservationsTable() {
            var reservations = getFilteredReservations();
            var tbody = document.getElementById('reservations-table');

            document.getElementById('reservations-count').textContent = reservations.length + ' réservations';

            if (reservations.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">Aucune réservation trouvée</td></tr>';
                return;
            }

            var sortedReservations = reservations.sort(function(a, b) {
                return new Date(b.created_at || b.createdAt) - new Date(a.created_at || a.createdAt);
            });

            var html = '';
            for (var i = 0; i < sortedReservations.length; i++) {
                var res = sortedReservations[i];
                var user = null;
                for (var j = 0; j < allUsers.length; j++) {
                    if (allUsers[j].id === res.user_id || allUsers[j].id === res.userId) {
                        user = allUsers[j];
                        break;
                    }
                }
                var userName = user ? (user.name || user.display_name || user.email) : (res.user_email || 'Utilisateur');
                
                var statusBadge = '';
                if (res.status === 'active') {
                    statusBadge = '<span class="badge success">En cours</span>';
                } else if (res.status === 'completed') {
                    statusBadge = '<span class="badge secondary">Terminée</span>';
                } else if (res.status === 'cancelled') {
                    statusBadge = '<span class="badge danger">Annulée</span>';
                } else {
                    statusBadge = res.status;
                }
                
                var spotId = res.place_id || res.spotId || '-';
                var duration = res.duration || 1;
                var amount = res.amount || (duration * 1000);
                var resId = res.id || '';
                
                html += '<tr>';
                html += '<td><code>#' + resId.slice(-6) + '</code></td>';
                html += '<td>' + userName + '</td>';
                html += '<td><strong>' + spotId + '</strong></td>';
                html += '<td>' + (res.vehicle_plate || res.vehiclePlate || '-') + '</td>';
                html += '<td>' + Admin.formatDate(res.start_time || res.startTime || res.created_at || res.createdAt) + '</td>';
                html += '<td>' + duration + 'h</td>';
                html += '<td><strong>' + amount.toLocaleString('fr-FR') + ' FC</strong></td>';
                html += '<td>' + statusBadge + '</td>';
                html += '<td>';
                html += '<button class="btn-icon view" onclick="viewReservation(\'' + res.id + '\')" title="Voir">';
                html += '<i class="fas fa-eye"></i>';
                html += '</button>';
                if (res.status === 'active') {
                    html += '<button class="btn-icon delete" onclick="cancelReservation(\'' + res.id + '\')" title="Annuler">';
                    html += '<i class="fas fa-times"></i>';
                    html += '</button>';
                }
                html += '</td>';
                html += '</tr>';
            }
            tbody.innerHTML = html;
        }

        function getFilteredReservations() {
            var reservations = allReservations || [];
            
            var search = document.getElementById('search-reservation').value.toLowerCase();
            var date = document.getElementById('filter-date').value;
            var status = document.getElementById('filter-status').value;

            if (search) {
                reservations = reservations.filter(function(r) {
                    var user = null;
                    for (var j = 0; j < allUsers.length; j++) {
                        if (allUsers[j].id === r.user_id || allUsers[j].id === r.userId) {
                            user = allUsers[j];
                            break;
                        }
                    }
                    var userName = user ? (user.name || user.display_name || user.email || '').toLowerCase() : '';
                    var spotId = (r.place_id || r.spotId || '').toLowerCase();
                    var vehiclePlate = (r.vehicle_plate || r.vehiclePlate || '').toLowerCase();
                    return spotId.indexOf(search) !== -1 || 
                           userName.indexOf(search) !== -1 ||
                           vehiclePlate.indexOf(search) !== -1;
                });
            }

            if (date) {
                reservations = reservations.filter(function(r) {
                    var resDate = new Date(r.created_at || r.createdAt).toISOString().split('T')[0];
                    return resDate === date;
                });
            }

            if (status !== 'all') {
                reservations = reservations.filter(function(r) { return r.status === status; });
            }

            return reservations;
        }

        function filterReservations() {
            loadReservationsTable();
        }

        function viewReservation(reservationId) {
            currentReservationId = reservationId;
            var reservation = null;
            for (var i = 0; i < allReservations.length; i++) {
                if (allReservations[i].id === reservationId) {
                    reservation = allReservations[i];
                    break;
                }
            }
            if (!reservation) {
                Admin.showNotification('Réservation introuvable', 'error');
                return;
            }
            
            var user = null;
            for (var j = 0; j < allUsers.length; j++) {
                if (allUsers[j].id === reservation.user_id || allUsers[j].id === reservation.userId) {
                    user = allUsers[j];
                    break;
                }
            }
            var userName = user ? (user.name || user.display_name || user.email) : (reservation.user_email || 'Utilisateur');

            var statusClass = 'success';
            var statusText = 'En cours';
            var statusIcon = 'fa-clock';
            if (reservation.status === 'completed') {
                statusClass = 'secondary';
                statusText = 'Terminée';
                statusIcon = 'fa-check-circle';
            } else if (reservation.status === 'cancelled') {
                statusClass = 'danger';
                statusText = 'Annulée';
                statusIcon = 'fa-times-circle';
            }
            
            var spotId = reservation.place_id || reservation.spotId || '-';
            var duration = reservation.duration || 1;
            var amount = reservation.amount || (duration * 1000);

            var detailsHtml = '';
            detailsHtml += '<div style="text-align: center; margin-bottom: 1.5rem;">';
            detailsHtml += '<div style="width: 80px; height: 80px; background: var(--primary-color); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem; color: white; font-size: 2rem;">';
            detailsHtml += '<i class="fas fa-parking"></i>';
            detailsHtml += '</div>';
            detailsHtml += '<h3 style="margin: 0;">Place ' + spotId + '</h3>';
            detailsHtml += '<span class="badge ' + statusClass + '"><i class="fas ' + statusIcon + '"></i> ' + statusText + '</span>';
            detailsHtml += '</div>';
            
            detailsHtml += '<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1.5rem;">';
            detailsHtml += '<div style="background: var(--bg-color); padding: 1rem; border-radius: var(--radius-md);">';
            detailsHtml += '<p style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 0.25rem;">';
            detailsHtml += '<i class="fas fa-user"></i> Utilisateur';
            detailsHtml += '</p>';
            detailsHtml += '<strong>' + userName + '</strong>';
            detailsHtml += '</div>';
            detailsHtml += '<div style="background: var(--bg-color); padding: 1rem; border-radius: var(--radius-md);">';
            detailsHtml += '<p style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 0.25rem;">';
            detailsHtml += '<i class="fas fa-car"></i> Véhicule';
            detailsHtml += '</p>';
            detailsHtml += '<strong>' + (reservation.vehicle_plate || reservation.vehiclePlate || 'Non renseigné') + '</strong>';
            detailsHtml += '</div>';
            detailsHtml += '<div style="background: var(--bg-color); padding: 1rem; border-radius: var(--radius-md);">';
            detailsHtml += '<p style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 0.25rem;">';
            detailsHtml += '<i class="fas fa-calendar"></i> Date début';
            detailsHtml += '</p>';
            detailsHtml += '<strong>' + Admin.formatDate(reservation.start_time || reservation.startTime || reservation.created_at || reservation.createdAt) + '</strong>';
            detailsHtml += '</div>';
            detailsHtml += '<div style="background: var(--bg-color); padding: 1rem; border-radius: var(--radius-md);">';
            detailsHtml += '<p style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 0.25rem;">';
            detailsHtml += '<i class="fas fa-hourglass-half"></i> Durée';
            detailsHtml += '</p>';
            detailsHtml += '<strong>' + duration + ' heure(s)</strong>';
            detailsHtml += '</div>';
            detailsHtml += '</div>';

            detailsHtml += '<div style="background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); padding: 1.5rem; border-radius: var(--radius-md); color: white; text-align: center; margin-bottom: 1.5rem;">';
            detailsHtml += '<p style="margin: 0 0 0.5rem; opacity: 0.9;">Montant</p>';
            detailsHtml += '<h2 style="margin: 0; font-size: 2rem;">' + amount.toLocaleString('fr-FR') + ' FC</h2>';
            detailsHtml += '</div>';

            if (reservation.access_code) {
                detailsHtml += '<div style="background: var(--bg-color); padding: 1rem; border-radius: var(--radius-md);">';
                detailsHtml += '<p><strong>Code d\'accès:</strong> <code>' + reservation.access_code + '</code></p>';
                detailsHtml += '</div>';
            }

            document.getElementById('reservation-details').innerHTML = detailsHtml;

            // Afficher le bouton d'annulation si réservation active
            document.getElementById('btn-cancel-reservation').style.display = 
                reservation.status === 'active' ? 'inline-flex' : 'none';

            document.getElementById('reservation-modal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('reservation-modal').classList.remove('active');
            currentReservationId = null;
        }

        function cancelReservation(reservationId) {
            var reservation = null;
            for (var i = 0; i < allReservations.length; i++) {
                if (allReservations[i].id === reservationId) {
                    reservation = allReservations[i];
                    break;
                }
            }
            var spotId = reservation ? (reservation.place_id || reservation.spotId) : reservationId;
            if (confirm('Voulez-vous annuler la réservation de la place ' + spotId + ' ?')) {
                API.post('/admin/reservations/' + reservationId + '/cancel', {})
                    .then(function() {
                        loadStats();
                        Admin.showNotification('Réservation annulée');
                    })
                    .catch(function(error) {
                        console.error('Erreur annulation:', error);
                        Admin.showNotification('Erreur lors de l\'annulation', 'error');
                    });
            }
        }

        function cancelCurrentReservation() {
            if (currentReservationId) {
                cancelReservation(currentReservationId);
                closeModal();
            }
        }

        function completeReservation(reservationId) {
            var reservation = null;
            for (var i = 0; i < allReservations.length; i++) {
                if (allReservations[i].id === reservationId) {
                    reservation = allReservations[i];
                    break;
                }
            }
            var spotId = reservation ? (reservation.place_id || reservation.spotId) : reservationId;
            if (confirm('Marquer la réservation de la place ' + spotId + ' comme terminée ?')) {
                // Pour l'instant, on utilise cancelReservation car l'API n'a pas de complete
                Admin.showNotification('Fonctionnalité en cours de développement', 'error');
            }
        }

        function exportReservations() {
            var filtered = getFilteredReservations();
            var reservations = [];
            for (var i = 0; i < filtered.length; i++) {
                var r = filtered[i];
                reservations.push({
                    id: r.id,
                    spotId: r.place_id || r.spotId,
                    vehiclePlate: r.vehicle_plate || r.vehiclePlate || '',
                    duration: r.duration || 1,
                    amount: r.amount || ((r.duration || 1) * 1000),
                    status: r.status,
                    createdAt: r.created_at || r.createdAt
                });
            }
            Admin.exportToCSV(reservations, 'reservations_aeropark.csv');
            Admin.showNotification('Export terminé');
        }
    </script>
</body>
</html>

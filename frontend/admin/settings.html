<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paramètres - Admin AeroPark GOMA</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/admin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="admin-page">
    <!-- Sidebar -->
    <aside class="admin-sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">
                <i class="fas fa-plane"></i>
                <span>AeroPark GOMA</span>
            </div>
            <button class="sidebar-toggle" id="sidebar-toggle">
                <i class="fas fa-bars"></i>
            </button>
        </div>

        <nav class="sidebar-nav">
            <ul>
                <li>
                    <a href="dashboard.html">
                        <i class="fas fa-tachometer-alt"></i>
                        <span>Tableau de bord</span>
                    </a>
                </li>
                <li>
                    <a href="places.html">
                        <i class="fas fa-parking"></i>
                        <span>Gestion des places</span>
                    </a>
                </li>
                <li>
                    <a href="reservations.html">
                        <i class="fas fa-calendar-check"></i>
                        <span>Réservations</span>
                    </a>
                </li>
                <li>
                    <a href="users.html">
                        <i class="fas fa-users"></i>
                        <span>Utilisateurs</span>
                    </a>
                </li>
                <li>
                    <a href="payments.html">
                        <i class="fas fa-money-bill-wave"></i>
                        <span>Paiements</span>
                    </a>
                </li>
                <li class="active">
                    <a href="settings.html">
                        <i class="fas fa-cog"></i>
                        <span>Paramètres</span>
                    </a>
                </li>
            </ul>
        </nav>

        <div class="sidebar-footer">
            <div class="admin-info">
                <div class="admin-avatar">
                    <i class="fas fa-user-shield"></i>
                </div>
                <div class="admin-details">
                    <span class="admin-name" id="admin-name">Admin</span>
                    <span class="admin-role">Administrateur</span>
                </div>
            </div>
            <button class="btn-logout" id="admin-logout">
                <i class="fas fa-sign-out-alt"></i>
                <span>Déconnexion</span>
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="admin-main">
        <header class="admin-header">
            <div class="header-left">
                <button class="mobile-menu-toggle" id="mobile-menu-toggle">
                    <i class="fas fa-bars"></i>
                </button>
                <h1>Paramètres</h1>
            </div>
        </header>

        <div class="admin-content">
            <div class="settings-grid">
                <!-- Informations générales -->
                <div class="dashboard-card">
                    <div class="card-header">
                        <h3><i class="fas fa-building"></i> Informations générales</h3>
                    </div>
                    <div class="card-body">
                        <form id="general-settings-form">
                            <div class="form-group">
                                <label for="parking-name">Nom du parking</label>
                                <input type="text" id="parking-name" class="form-control" placeholder="AeroPark GOMA">
                            </div>
                            <div class="form-group">
                                <label for="parking-slogan">Slogan</label>
                                <input type="text" id="parking-slogan" class="form-control" placeholder="Parking Automatisé">
                            </div>
                            <div class="form-group">
                                <label for="parking-address">Adresse</label>
                                <textarea id="parking-address" class="form-control" rows="2" placeholder="Aéroport de Goma, RDC"></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Enregistrer
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Tarification -->
                <div class="dashboard-card">
                    <div class="card-header">
                        <h3><i class="fas fa-money-bill"></i> Tarification</h3>
                    </div>
                    <div class="card-body">
                        <form id="pricing-settings-form">
                            <div class="form-group">
                                <label for="hourly-rate">Tarif horaire (FC)</label>
                                <input type="number" id="hourly-rate" class="form-control" min="100" step="100" placeholder="1000">
                            </div>
                            <div class="form-group">
                                <label for="max-duration">Durée maximale (heures)</label>
                                <input type="number" id="max-duration" class="form-control" min="1" max="720" placeholder="168">
                            </div>
                            <div class="form-group">
                                <label for="currency">Devise</label>
                                <select id="currency" class="form-control">
                                    <option value="FC">Franc Congolais (FC)</option>
                                    <option value="USD">Dollar US ($)</option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Enregistrer
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Méthodes de paiement -->
                <div class="dashboard-card">
                    <div class="card-header">
                        <h3><i class="fas fa-credit-card"></i> Méthodes de paiement</h3>
                    </div>
                    <div class="card-body">
                        <form id="payment-methods-form">
                            <div class="payment-method-item">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="orange-enabled" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                                <div class="payment-method-info">
                                    <img src="../logo/orange_money_logo.png" alt="Orange Money" style="height: 30px;">
                                    <span>Orange Money</span>
                                </div>
                            </div>
                            <div class="payment-method-item">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="airtel-enabled" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                                <div class="payment-method-info">
                                    <img src="../logo/airtel-money.png" alt="Airtel Money" style="height: 30px;">
                                    <span>Airtel Money</span>
                                </div>
                            </div>
                            <div class="payment-method-item">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="mpesa-enabled" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                                <div class="payment-method-info">
                                    <img src="../logo/Mpesa.png" alt="M-Pesa" style="height: 30px;">
                                    <span>M-Pesa</span>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary" style="margin-top: 1rem;">
                                <i class="fas fa-save"></i> Enregistrer
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Contact -->
                <div class="dashboard-card">
                    <div class="card-header">
                        <h3><i class="fas fa-phone"></i> Contact</h3>
                    </div>
                    <div class="card-body">
                        <form id="contact-settings-form">
                            <div class="form-group">
                                <label for="contact-phone">Téléphone</label>
                                <input type="tel" id="contact-phone" class="form-control" placeholder="+243 XXX XXX XXX">
                            </div>
                            <div class="form-group">
                                <label for="contact-email">Email</label>
                                <input type="email" id="contact-email" class="form-control" placeholder="contact@aeropark.cd">
                            </div>
                            <div class="form-group">
                                <label for="whatsapp">WhatsApp</label>
                                <input type="tel" id="whatsapp" class="form-control" placeholder="+243 XXX XXX XXX">
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Enregistrer
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Configuration Admin -->
                <div class="dashboard-card">
                    <div class="card-header">
                        <h3><i class="fas fa-user-shield"></i> Compte Administrateur</h3>
                    </div>
                    <div class="card-body">
                        <form id="admin-settings-form">
                            <div class="form-group">
                                <label for="admin-username">Nom d'utilisateur</label>
                                <input type="text" id="admin-username" class="form-control" placeholder="admin">
                            </div>
                            <div class="form-group">
                                <label for="current-password">Mot de passe actuel</label>
                                <input type="password" id="current-password" class="form-control">
                            </div>
                            <div class="form-group">
                                <label for="new-password">Nouveau mot de passe</label>
                                <input type="password" id="new-password" class="form-control">
                            </div>
                            <div class="form-group">
                                <label for="confirm-password">Confirmer le mot de passe</label>
                                <input type="password" id="confirm-password" class="form-control">
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Modifier
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Données système -->
                <div class="dashboard-card">
                    <div class="card-header">
                        <h3><i class="fas fa-database"></i> Données système</h3>
                    </div>
                    <div class="card-body">
                        <div class="data-info">
                            <p><strong>Utilisateurs:</strong> <span id="data-users">0</span></p>
                            <p><strong>Réservations:</strong> <span id="data-reservations">0</span></p>
                            <p><strong>Paiements:</strong> <span id="data-payments">0</span></p>
                            <p><strong>Places de parking:</strong> <span id="data-spots">0</span></p>
                        </div>
                        <hr style="margin: 1rem 0; border-color: var(--border-color);">
                        <div class="data-actions">
                            <button class="btn btn-outline" onclick="exportAllData()">
                                <i class="fas fa-download"></i> Exporter tout
                            </button>
                            <button class="btn btn-danger" onclick="resetData()">
                                <i class="fas fa-trash"></i> Réinitialiser
                            </button>
                        </div>
                        <p class="text-muted" style="margin-top: 1rem; font-size: 0.85rem;">
                            <i class="fas fa-info-circle"></i> Les données sont stockées sur le serveur backend.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- AeroPark API Services -->
    <script src="../js/api.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/admin.js"></script>
    <script>
        var currentSettings = {};

        document.addEventListener('DOMContentLoaded', function() {
            // Check authentication
            if (!Auth.isLoggedIn() || !Auth.isAdmin()) {
                window.location.href = 'login.html';
                return;
            }

            // Initialize sidebar
            Admin.initSidebar();

            // Load data
            loadSettings();
            loadDataStats();
            initForms();

            // Set admin info
            var user = Auth.getUser();
            if (user) {
                document.getElementById('admin-name').textContent = user.name || user.username || 'Admin';
                document.getElementById('admin-username').value = user.name || user.username || '';
            }
        });

        function loadSettings() {
            // Settings are stored in localStorage since there's no backend endpoint
            var storedSettings = localStorage.getItem('aeropark_admin_settings');
            if (storedSettings) {
                try {
                    currentSettings = JSON.parse(storedSettings);
                } catch (e) {
                    currentSettings = {};
                }
            } else {
                currentSettings = {};
            }

            // Informations générales (use defaults if not set)
            document.getElementById('parking-name').value = currentSettings.parkingName || 'AeroPark GOMA';
            document.getElementById('parking-slogan').value = currentSettings.slogan || 'Parking Automatisé';
            document.getElementById('parking-address').value = currentSettings.address || 'Aéroport de Goma, RDC';

            // Tarification - get from backend pricing if available
            API.get('/api/v1/payment/pricing').then(function(pricing) {
                document.getElementById('hourly-rate').value = pricing.rate_per_hour || currentSettings.ratePerHour || 1000;
                document.getElementById('currency').value = pricing.currency || currentSettings.currency || 'FC';
            }).catch(function() {
                document.getElementById('hourly-rate').value = currentSettings.ratePerHour || 1000;
                document.getElementById('currency').value = currentSettings.currency || 'FC';
            });
            document.getElementById('max-duration').value = currentSettings.maxDuration || 168;

            // Méthodes de paiement
            var paymentMethods = currentSettings.paymentMethods || {};
            document.getElementById('orange-enabled').checked = paymentMethods.orange !== false;
            document.getElementById('airtel-enabled').checked = paymentMethods.airtel !== false;
            document.getElementById('mpesa-enabled').checked = paymentMethods.mpesa !== false;

            // Contact
            document.getElementById('contact-phone').value = currentSettings.phone || '';
            document.getElementById('contact-email').value = currentSettings.email || '';
            document.getElementById('whatsapp').value = currentSettings.whatsapp || '';
        }

        function loadDataStats() {
            // Load reservations count (extract users from reservations)
            API.getAdminReservations()
                .then(function(response) {
                    var reservations = response.reservations || response || [];
                    document.getElementById('data-reservations').textContent = reservations.length || 0;
                    
                    // Extract unique users from reservations
                    var usersMap = {};
                    for (var i = 0; i < reservations.length; i++) {
                        var r = reservations[i];
                        var userId = r.user_id || r.userId;
                        if (userId) usersMap[userId] = true;
                    }
                    document.getElementById('data-users').textContent = Object.keys(usersMap).length;
                })
                .catch(function(error) {
                    console.error('Erreur chargement reservations:', error);
                });

            // Load payments count
            API.getAdminPayments()
                .then(function(response) {
                    var payments = response.payments || response || [];
                    document.getElementById('data-payments').textContent = payments.length || 0;
                })
                .catch(function(error) {
                    console.error('Erreur chargement payments:', error);
                });

            // Load parking status
            API.getParkingStatus()
                .then(function(status) {
                    document.getElementById('data-spots').textContent = status.total || 0;
                })
                .catch(function(error) {
                    console.error('Erreur chargement parking status:', error);
                });
        }

        function saveSettings(newSettings) {
            // Merge with current settings
            for (var key in newSettings) {
                currentSettings[key] = newSettings[key];
            }
            // Save to localStorage
            localStorage.setItem('aeropark_admin_settings', JSON.stringify(currentSettings));
        }

        function initForms() {
            // Informations générales
            document.getElementById('general-settings-form').addEventListener('submit', function(e) {
                e.preventDefault();
                saveSettings({
                    parkingName: document.getElementById('parking-name').value,
                    slogan: document.getElementById('parking-slogan').value,
                    address: document.getElementById('parking-address').value
                });
                Admin.showNotification('Informations enregistrées');
            });

            // Tarification
            document.getElementById('pricing-settings-form').addEventListener('submit', function(e) {
                e.preventDefault();
                saveSettings({
                    ratePerHour: parseInt(document.getElementById('hourly-rate').value),
                    maxDuration: parseInt(document.getElementById('max-duration').value),
                    currency: document.getElementById('currency').value
                });
                Admin.showNotification('Tarification enregistrée (Note: les tarifs backend ne sont pas modifiés)');
            });

            // Méthodes de paiement
            document.getElementById('payment-methods-form').addEventListener('submit', function(e) {
                e.preventDefault();
                saveSettings({
                    paymentMethods: {
                        orange: document.getElementById('orange-enabled').checked,
                        airtel: document.getElementById('airtel-enabled').checked,
                        mpesa: document.getElementById('mpesa-enabled').checked
                    }
                });
                Admin.showNotification('Méthodes de paiement enregistrées');
            });

            // Contact
            document.getElementById('contact-settings-form').addEventListener('submit', function(e) {
                e.preventDefault();
                saveSettings({
                    phone: document.getElementById('contact-phone').value,
                    email: document.getElementById('contact-email').value,
                    whatsapp: document.getElementById('whatsapp').value
                });
                Admin.showNotification('Informations de contact enregistrées');
            });

            // Compte admin
            document.getElementById('admin-settings-form').addEventListener('submit', function(e) {
                e.preventDefault();
                var currentPassword = document.getElementById('current-password').value;
                var newPassword = document.getElementById('new-password').value;
                var confirmPassword = document.getElementById('confirm-password').value;

                if (!currentPassword) {
                    Admin.showNotification('Veuillez entrer le mot de passe actuel', 'error');
                    return;
                }

                if (newPassword && newPassword !== confirmPassword) {
                    Admin.showNotification('Les mots de passe ne correspondent pas', 'error');
                    return;
                }

                Admin.showNotification('La modification du mot de passe n\'est pas disponible actuellement', 'error');

                // Reset form
                document.getElementById('current-password').value = '';
                document.getElementById('new-password').value = '';
                document.getElementById('confirm-password').value = '';
            });
        }

        function exportAllData() {
            var exportData = {
                reservations: [],
                payments: [],
                spots: [],
                settings: currentSettings,
                exportDate: new Date().toISOString()
            };

            // Load all data then export
            Promise.all([
                API.getAdminReservations().catch(function() { return { reservations: [] }; }),
                API.getAdminPayments().catch(function() { return { payments: [] }; }),
                API.getParkingStatus().catch(function() { return { places: [] }; })
            ]).then(function(results) {
                exportData.reservations = (results[0] && results[0].reservations) || results[0] || [];
                exportData.payments = (results[1] && results[1].payments) || results[1] || [];
                exportData.spots = (results[2] && results[2].places) || [];

                var blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                var url = URL.createObjectURL(blob);
                var a = document.createElement('a');
                a.href = url;
                a.download = 'aeropark_backup_' + new Date().toISOString().split('T')[0] + '.json';
                a.click();
                URL.revokeObjectURL(url);

                Admin.showNotification('Export complet terminé');
            }).catch(function(error) {
                console.error('Erreur export:', error);
                Admin.showNotification('Erreur lors de l\'export', 'error');
            });
        }

        function resetData() {
            if (!confirm('⚠️ ATTENTION: Cette action n\'est pas disponible via l\'API. Les données sont gérées par le backend.')) {
                return;
            }

            Admin.showNotification('La réinitialisation des données doit être effectuée via le backend', 'error');
        }
    </script>

    <style>
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 1.5rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        .form-control {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 1rem;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(44, 82, 130, 0.1);
        }

        textarea.form-control {
            resize: vertical;
            min-height: 80px;
        }

        .payment-method-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: var(--bg-color);
            border-radius: var(--radius-md);
            margin-bottom: 0.75rem;
        }

        .payment-method-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
            cursor: pointer;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            inset: 0;
            background: #ccc;
            border-radius: 26px;
            transition: 0.3s;
        }

        .toggle-slider::before {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            left: 3px;
            top: 3px;
            background: white;
            border-radius: 50%;
            transition: 0.3s;
        }

        .toggle-switch input:checked + .toggle-slider {
            background: var(--primary-color);
        }

        .toggle-switch input:checked + .toggle-slider::before {
            transform: translateX(24px);
        }

        .data-info p {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px dashed var(--border-color);
        }

        .data-info p:last-child {
            border-bottom: none;
        }

        .data-actions {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        @media (max-width: 768px) {
            .settings-grid {
                grid-template-columns: 1fr;
            }

            .data-actions {
                flex-direction: column;
            }

            .data-actions .btn {
                width: 100%;
            }
        }
    </style>
</body>
</html>
